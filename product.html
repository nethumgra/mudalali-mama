<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑è‡∂Ω‡∑í ‡∂∏‡∑è‡∂∏‡∑è</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css"/>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: {
                        'mudalali-green': { light: '#76b852', DEFAULT: '#3a6a4a', dark: '#2c5234' },
                        'mudalali-gold': '#bda26b',
                        'mudalali-red': '#d93a3e',
                        'mudalali-bg': '#f5f5f4',
                        'ai-purple': '#8b5cf6',
                        'mm-gray': { light: '#f8f8f8', DEFAULT: '#e5e5e5' }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        body { @apply font-sans text-gray-800 bg-mudalali-bg; }
        .drawer-overlay { @apply fixed inset-0 bg-black bg-opacity-50 z-50 transition-opacity opacity-0 pointer-events-none; }
        .drawer-content { @apply fixed top-0 right-0 h-full bg-white shadow-xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out; width: 90%; max-width: 400px; }
        .drawer.open .drawer-overlay { @apply opacity-100 pointer-events-auto; }
        .drawer.open .drawer-content { @apply transform translate-x-0; }
        .drawer-content.left { @apply left-0 right-auto transform -translate-x-full; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Updated Chat Bubbles for Better Readability */
        .chat-bubble { @apply max-w-[85%] p-3.5 rounded-2xl text-sm mb-3 leading-relaxed shadow-sm break-words; }
        .chat-sent { @apply bg-mudalali-green text-white self-end rounded-tr-none; }
        .chat-received { @apply bg-gray-200 text-gray-800 self-start rounded-tl-none; }
        .chat-ai { @apply bg-white border border-purple-200 text-gray-800 self-start rounded-tl-none; } /* Changed to white for better readability */
        
        .chat-product-card { @apply flex items-center gap-3 bg-gray-100 p-3 rounded-lg mb-4 border border-gray-200; }
        
        /* Language Buttons */
        .lang-btn { @apply border border-purple-300 text-purple-700 px-3 py-1.5 rounded-full text-xs font-bold hover:bg-purple-600 hover:text-white transition duration-200; }

        input:checked ~ .dot { transform: translateX(100%); background-color: #ffffff; }
        input:checked ~ .bg-gray-400 { background-color: #8b5cf6; }
        .ai-thinking span { animation: blink 1.4s infinite both; }
        .ai-thinking span:nth-child(2) { animation-delay: 0.2s; }
        .ai-thinking span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0% { opacity: .2; } 20% { opacity: 1; } 100% { opacity: .2; } }
        
        /* Ratings & Other Styles */
        .rating-stars .star { @apply text-gray-300 cursor-pointer text-xl transition-colors; }
        .rating-stars .star.selected { @apply text-mudalali-gold; }
        .display-stars { @apply relative inline-block text-gray-300 text-sm; }
        .display-stars-filled { @apply absolute top-0 left-0 whitespace-nowrap overflow-hidden text-mudalali-gold; }
        #wishlist-btn.liked { @apply bg-mudalali-red text-white; }
        .page-tab-btn { @apply flex-1 text-center py-4 px-2 font-semibold text-gray-500 border-b-2 border-transparent transition-colors; }
        .page-tab-btn.active { @apply text-mudalali-green border-mudalali-green; }
        
        /* Variation Chips */
        .variation-chip { @apply border-2 border-gray-200 px-4 py-2 rounded-lg text-sm font-semibold cursor-pointer transition hover:border-mudalali-green select-none bg-white; }
        .variation-chip.selected { @apply border-mudalali-green bg-green-50 text-mudalali-green shadow-sm; }

        /* Driver JS Custom */
        .driver-popover.driverjs-theme { background-color: #ffffff; color: #333; border-radius: 12px; padding: 15px; }
        .driver-popover.driverjs-theme .driver-popover-title { font-family: 'Poppins', sans-serif; font-size: 18px; font-weight: 700; color: #3a6a4a; margin-bottom: 5px; }
        .driver-popover.driverjs-theme button { background-color: #3a6a4a; color: white; border-radius: 6px; padding: 8px 16px; font-size: 12px; border: none; text-shadow: none; }
        .driver-popover.driverjs-theme button:hover { background-color: #2c5234; }

        /* --- CUSTOM OFFER BUBBLE STYLES --- */
        .chat-offer {
            @apply bg-white border-2 border-mudalali-green text-gray-800 self-start rounded-tl-none p-4 shadow-md max-w-[85%] mb-3;
        }
        .offer-price {
            @apply text-2xl font-bold text-mudalali-green my-2;
        }
        .offer-btn {
            @apply bg-mudalali-green text-white w-full py-2 rounded-lg font-bold text-sm hover:bg-mudalali-green-dark transition mt-2;
        }

        /* --- BARGAINING AI STYLES --- */
        .deal-success-bubble {
            @apply bg-green-50 border-2 border-green-500 text-green-800 p-4 rounded-xl mb-4 shadow-md text-center animate-pulse;
        }
        .deal-timer {
            @apply text-xs font-bold text-red-500 mt-2;
        }
        .bargain-btn {
            @apply w-full bg-gradient-to-r from-green-600 to-green-700 text-white font-bold py-3 rounded-lg shadow-lg transform transition hover:scale-105 flex justify-center items-center gap-2;
        }

    </style>
</head>
<body class="pb-20 md:pb-0" style="background-color: #f5f5f4;"> 
    
    <div id="page-loader" class="fixed top-0 left-0 w-0 h-1 bg-mudalali-green z-[9999] transition-all duration-300 ease-linear"></div>
    
    <header class="bg-white shadow-md sticky top-0 z-40 hidden md:block">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="index.html" id="logo-link" class="flex items-center gap-2">
                <img id="logo-img" src="https://i.ibb.co/1tCywvyP/logo.png" class="h-10" alt="Logo">
            </a>
            <div class="flex-grow max-w-xl mx-4">
                <form class="flex">
                    <input type="text" placeholder="Search for anything..." class="w-full px-4 py-2 border border-mm-gray-DEFAULT rounded-l-md focus:outline-none focus:ring-2 focus:ring-mudalali-green">
                    <button type="submit" class="bg-mudalali-green text-white px-4 py-2 rounded-r-md hover:bg-mudalali-green-dark"><i class="fa fa-search"></i></button>
                </form>
            </div>
            <div class="flex items-center space-x-6">
                <a href="account.html" id="desktop-account-btn" class="flex flex-col items-center text-gray-600 hover:text-mudalali-green"><i class="fa fa-user text-xl"></i><span class="text-xs">Account</span></a>
                <a href="wishlist.html" class="relative flex flex-col items-center text-gray-600 hover:text-mudalali-green">
                    <i class="fa fa-heart text-xl"></i><span id="wishlist-count-badge" class="absolute -top-2 -right-2 bg-mudalali-red text-white text-xs rounded-full px-1.5 py-0.5">0</span><span class="text-xs">Wishlist</span>
                </a>
                <button id="desktop-cart-btn" class="flex flex-col items-center text-gray-600 hover:text-mudalali-green relative">
                    <i class="fa fa-shopping-cart text-xl"></i><span id="cart-count-badge" class="absolute -top-2 -right-2 bg-mudalali-red text-white text-xs rounded-full px-1.5 py-0.5">0</span><span class="text-xs">Cart</span>
                </button>
            </div>
        </div>
    </header>

    <nav class="bg-mudalali-bg shadow-sm hidden md:block" style="border-bottom: 1px solid #e5e5e5;">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div id="desktop-nav-links-container" class="flex space-x-6"></div>
            <a href="#" class="bg-mudalali-green-dark text-white px-4 py-2 rounded-md text-sm font-semibold hover:bg-mudalali-green">Order Status</a>
        </div>
    </nav>

    <header class="bg-white shadow-md sticky top-0 z-40 flex md:hidden items-center justify-between p-4">
        <button id="mobile-menu-btn" class="text-2xl text-gray-700"><i class="fa fa-bars"></i></button>
         <a href="index.html" id="mobile-logo-link" class="text-3xl font-bold text-mudalali-green-dark"><img id="mobile-logo-img" src="https://i.ibb.co/1tCywvyP/logo.png" class="h-8" alt="Logo"></a>
        <a href="account.html" id="mobile-account-btn" class="text-2xl text-gray-700 w-8 text-right"><i class="fa fa-user"></i></a>
    </header>

   <main class="container mx-auto p-4 md:p-8" style="min-height: calc(100vh - 200px);">
        
        <div id="product-loader" class="w-full text-center py-20">
            <svg class="animate-spin h-10 w-10 text-mudalali-green mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-gray-500 font-semibold">Loading Product...</p>
        </div>

        <div id="product-content" class="hidden lg:grid lg:grid-cols-3 lg:gap-8">
            
            <div id="tour-seller-info" class="lg:col-span-3 bg-white rounded-lg shadow-lg mb-6 p-6 flex items-center gap-4">
                <img id="seller-logo" src="https://placehold.co/80x80" alt="Seller Logo" class="w-20 h-20 rounded-full object-cover border-2 border-gray-200">
                <div class="flex-grow">
                    <p class="text-sm text-gray-500">Sold By:</p>
                    <h3 id="seller-name" class="text-xl font-bold text-gray-800">Loading Seller...</h3>
                    <p id="seller-bio" class="text-sm text-gray-600 mt-1 line-clamp-2">Loading seller bio...</p>
                </div>
                <a id="seller-store-link" href="#" class="flex-shrink-0 bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-semibold text-sm hover:bg-gray-200">Visit Store</a>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                    <div class="lg:flex">
                        <div class="lg:w-1/2 p-4">
                            <div class="relative overflow-hidden rounded-lg border bg-gray-50 aspect-square mb-4">
                                <img id="main-product-image" src="https://placehold.co/600x600" alt="Product Image" class="w-full h-full object-contain p-2 transition-transform duration-500 hover:scale-105">
                            </div>
                            <div id="product-thumbnails" class="flex gap-2 mt-2 overflow-x-auto no-scrollbar p-1"></div>
                        </div>
                        
                        <div class="lg:w-1/2 p-6 flex flex-col">
                            <h1 id="product-name" class="text-3xl font-bold text-gray-800">Product Name</h1>
                            <div class="flex items-center my-2">
                                <div id="product-average-rating-stars" class="display-stars text-lg"> 
                                    <i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i>
                                    <div class="display-stars-filled" style="width: 0%;">
                                        <i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i>
                                    </div>
                                </div>
                                <span id="product-review-count" class="ml-2 text-sm text-gray-500">(0 reviews)</span>
                            </div>

                            <div id="variations-wrapper" class="hidden my-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">Select Option</h3>
                                <div id="variations-container" class="flex flex-wrap gap-2"></div>
                            </div>

                            <div id="product-price" class="my-4">
                                <span class="text-3xl font-bold text-mudalali-red">Rs. 0.00</span>
                            </div>
                            
                            <div class="flex-grow"></div> 
                            
                            <div class="flex flex-col gap-3 mt-6">
                                <div class="flex items-center gap-3">
                                    <button id="add-to-cart-btn" class="flex-1 bg-mudalali-green text-white p-3 rounded-lg hover:bg-mudalali-green-dark font-bold text-lg whitespace-nowrap">
                                        <i class="fa fa-shopping-cart mr-2"></i> Add to Cart
                                    </button>
                                    <button id="wishlist-btn" class="w-16 h-14 border-2 border-mudalali-red text-mudalali-red rounded-lg flex items-center justify-center text-2xl hover:bg-mudalali-red hover:text-white transition-colors">
                                        <i class="fa fa-heart"></i>
                                    </button>
                                </div>
                                <button id="buy-now-btn" class="w-full bg-gray-800 text-white p-3 rounded-lg hover:bg-gray-900 font-bold text-lg whitespace-nowrap">
                                    <i class="fa fa-bolt mr-2"></i> Buy Now
                                </button>
                                
                                <div id="tour-custom-btn-wrapper" class="w-full">
                                    <button id="request-custom-btn" class="hidden w-full border-2 border-mudalali-green text-mudalali-green py-3 rounded-lg font-bold hover:bg-mudalali-green hover:text-white transition flex items-center justify-center gap-2">
                                        <i class="fa fa-comments"></i> Request Customization / Chat
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-lg mt-8">
                    <div class="flex border-b">
                        <button id="desc-tab-btn" class="page-tab-btn active">Description</button>
                        <button id="delivery-tab-btn" class="page-tab-btn">Delivery Details</button>
                        <button id="reviews-tab-btn" class="page-tab-btn">Reviews</button>
                    </div>
                
                    <div id="desc-tab-panel" class="p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Product Description</h2>
                        <p id="product-description" class="text-gray-600 leading-relaxed">Loading description...</p>
                    </div>

                    <div id="delivery-tab-panel" class="p-6 hidden">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Delivery Details</h2>
                        <div id="product-delivery-details" class="text-gray-600 leading-relaxed space-y-2">
                            <p>Loading delivery information...</p>
                        </div>
                    </div>

                    <div id="reviews-tab-panel" class="p-6 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-800">Customer Reviews</h2>
                             <button id="ai-summarize-btn" class="bg-ai-purple text-white px-4 py-2 rounded-full text-xs font-bold hover:bg-purple-700 shadow flex items-center gap-2 transition transform hover:scale-105">
                                <i class="fa fa-magic"></i> AI Summary
                            </button>
                        </div>

                        <div id="ai-summary-box" class="hidden bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
                            <h4 class="font-bold text-ai-purple text-sm mb-2"><i class="fa fa-robot mr-2"></i>AI Verdict:</h4>
                            <p id="ai-summary-text" class="text-sm text-gray-700 leading-relaxed"></p>
                        </div>

                        <div id="review-form-container" class="mb-6 border-b pb-6">
                            <h3 class="text-lg font-semibold mb-2">Leave a Review</h3>
                            <div id="review-login-prompt" class="hidden">
                                <p class="text-gray-600">Please <button id="login-to-review-btn" class="font-bold text-mudalali-green hover:underline">log in</button> to leave a review.</p>
                            </div>
                            <form id="review-form" class="hidden space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Your Rating:</label>
                                    <div id="rating-stars-input" class="rating-stars flex flex-row-reverse justify-end">
                                        <i class="star fa fa-star" data-value="5"></i>
                                        <i class="star fa fa-star" data-value="4"></i>
                                        <i class="star fa fa-star" data-value="3"></i>
                                        <i class="star fa fa-star" data-value="2"></i>
                                        <i class="star fa fa-star" data-value="1"></i>
                                    </div>
                                </div>
                                <div>
                                    <label for="review-text" class="block text-sm font-medium text-gray-700">Your Review:</label>
                                    <textarea id="review-text" rows="3" class="mt-1 block w-full p-2 border rounded-md focus:ring-mudalali-green focus:border-mudalali-green" placeholder="Write your review here..."></textarea>
                                </div>
                                <button type="submit" class="bg-mudalali-green text-white px-5 py-2 rounded-lg font-semibold hover:bg-mudalali-green-dark">Submit Review</button>
                                <p id="review-submit-status" class="text-sm"></p>
                            </form>
                        </div>
                        <div id="reviews-list-container" class="space-y-4"><p class="text-gray-500">Loading reviews...</p></div>
                    </div>
                </div>
            </div>
            
            <div id="related-products-sidebar" class="hidden lg:block lg:col-span-1 space-y-6 sticky top-24">
                <h3 class="text-xl font-bold text-gray-800">Related Products</h3>
                <div id="related-products-grid" class="space-y-4"><p id="related-loader" class="text-gray-500">Loading related products...</p></div>
            </div>

            <div id="related-products-section-mobile" class="mt-8 lg:hidden lg:col-span-3">
                 <h2 class="text-2xl font-bold text-gray-800 mb-4">Related Products</h2>
                <div id="related-products-grid-mobile" class="grid grid-cols-2 md:grid-cols-4 gap-4"><p id="related-loader-mobile" class="text-gray-500 col-span-full">Loading related products...</p></div>
            </div>
        </div>
    </main>

    <div id="chat-drawer" class="drawer">
        <div class="drawer-overlay" id="chat-overlay"></div>
        <div class="drawer-content flex flex-col h-full">
            <div id="chat-header" class="p-4 border-b bg-mudalali-green text-white flex justify-between items-center shadow-md transition-colors duration-300">
                <div>
                    <h2 class="font-bold text-lg" id="chat-title"><i class="fa fa-tools mr-2"></i>Customize Request</h2>
                    <div class="flex items-center mt-1">
                        <label class="flex items-center cursor-pointer select-none">
                            <div class="relative">
                                <input type="checkbox" id="ai-toggle" class="sr-only">
                                <div class="w-8 h-4 bg-gray-400 rounded-full transition-colors"></div>
                                <div class="dot absolute w-4 h-4 bg-white rounded-full left-0 top-0 transition transform"></div>
                            </div>
                            <div class="ml-2 text-xs text-white font-bold opacity-90" id="chat-mode-text">Chat with Seller</div>
                        </label>
                    </div>
                </div>
                <button id="close-chat-btn" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition"><i class="fa fa-times text-lg"></i></button>
            </div>
            
           <div id="chat-messages" class="flex-grow p-4 overflow-y-auto bg-gray-50 flex flex-col gap-3 pb-20">
    <div class="text-center text-xs text-gray-400 mt-10">
        <i class="fa fa-info-circle mb-2 text-2xl"></i><br>
        Start a conversation regarding your customization needs.<br>
        Use the toggle to ask <b>Mudalali AI</b>.
    </div>
</div>
            
            <div id="chat-status-bar" class="px-4 py-2 text-xs font-bold text-center hidden transition-all"></div>
            
            <div class="p-3 border-t bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.05)] absolute bottom-0 w-full">
                <form id="chat-form" class="flex gap-2 items-center">
                    <input type="text" id="chat-input" class="flex-grow border border-gray-300 rounded-full px-4 py-2.5 text-sm focus:outline-none focus:border-mudalali-green focus:ring-1 focus:ring-mudalali-green transition" placeholder="Type your request..." required>
                    <button type="submit" id="chat-send-btn" class="bg-mudalali-green text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-mudalali-green-dark shadow-md transition transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa fa-paper-plane text-sm"></i>
                    </button>
                </form>
                <p class="text-[10px] text-gray-400 mt-2 text-center flex items-center justify-center gap-1"><i class="fa fa-lock"></i> Links & Phone numbers are automatically blocked.</p>
            </div>
        </div>
    </div>

    <button
        id="floating-chat-btn"
        class="fixed bottom-6 right-6 bg-mudalali-green text-white w-14 h-14 rounded-full shadow-2xl z-[40] flex items-center justify-center hover:scale-110 transition-transform duration-300 hover:bg-mudalali-green-dark group"
    >
        <i class="fa fa-comments text-2xl group-hover:animate-bounce"></i>
    </button>

    <footer class="bg-gray-800 text-gray-300 pt-16 pb-8 hidden md:block">
        <div id="footer-container" class="container mx-auto px-4">
            <div class="bg-gray-700 p-8 rounded-lg -mt-28 mb-16 relative z-10 shadow-xl flex items-center justify-between">
                <div><h3 class="text-2xl font-bold text-white mb-2">SUBSCRIBE TO US</h3><p class="text-gray-300">Get the first look at exclusive offers, promotions, and more.</p></div>
                <form class="flex w-full max-w-md"><input type="email" placeholder="Email Address" class="w-full px-4 py-3 rounded-l-md text-gray-800 focus:outline-none focus:ring-2 focus:ring-mudalali-green"><button type="submit" class="bg-mudalali-green text-white px-6 py-3 rounded-r-md font-bold hover:bg-mudalali-green-dark">SUBSCRIBE</button></form>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-8 mb-8">
                <div><h4 class="font-bold text-white mb-4">‡∂∏‡∑î‡∂Ø‡∂Ω‡∑è‡∂Ω‡∑í ‡∂∏‡∑è‡∂∏‡∑è</h4><ul id="footer-col-tsmgroup" class="space-y-2"><li>Loading...</li></ul></div>
                <div><h4 class="font-bold text-white mb-4">INFO</h4><ul id="footer-col-info" class="space-y-2"><li>Loading...</li></ul></div>
                <div><h4 class="font-bold text-white mb-4">QUICK LINKS</h4><ul id="footer-col-quicklinks" class="space-y-2"><li>Loading...</li></ul></div>
                <div class="col-span-2 md:col-span-1"><h4 class="font-bold text-white mb-4">COLOMBO HEAD OFFICE</h4><address id="footer-address" class="not-italic">Loading...</address><p class="mt-2">Email: <a id="footer-email" href="#" class="hover:text-white">...</a></p><p>Hotline: <a id="footer-hotline" href="#" class="hover:text-white">...</a></p></div>
                <div class="col-span-2 md:col-span-1"><h4 class="font-bold text-white mb-4">KEEP IN TOUCH</h4><div id="footer-socials" class="flex space-x-4 mb-4"></div><h4 class="font-bold text-white mb-4 mt-6">PAYMENTS</h4><div class="flex space-x-2"><img src="https://i.ibb.co/fDYrL3g/visa.png" alt="Visa" class="h-6"><img src="https://i.ibb.co/7rmXz4F/mastercard.png" alt="Mastercard" class="h-6"><img src="https://i.ibb.co/C0W2LFr/amex.png" alt="Amex" class="h-6"></div></div>
            </div>
            <div class="border-t border-gray-700 pt-6 text-sm text-center md:flex justify-between"><p>&copy; 2025 Mudalali Mama. All Rights reserved.</p><div class="space-x-4 mt-4 md:mt-0"><a href="#" class="hover:text-white">TERMS & CONDITIONS</a><span>|</span><a href="#" class="hover:text-white">PRIVACY POLICY</a></div></div>
        </div>
    </footer>

    <div id="account-drawer-modal" class="drawer drawer-modal fixed inset-0 z-50 hidden">
        <div id="account-drawer-bg" class="drawer-bg fixed inset-0 bg-black bg-opacity-50 opacity-0 transition-opacity"></div>
        <div id="account-drawer" class="drawer-content fixed top-0 right-0 h-full bg-white shadow-xl w-full max-w-md flex flex-col">
            <div id="account-drawer-logged-in" class="hidden flex flex-col h-full">
                <div class="p-4 flex justify-between items-center border-b flex-shrink-0"><h2 class="text-xl font-semibold text-gray-800">My Account</h2><button id="close-account-drawer-btn-logged-in" class="text-gray-500 hover:text-gray-800 text-sm flex items-center gap-1"><i class="fas fa-times"></i> Close</button></div>
                <div class="flex-grow p-6 overflow-y-auto"><p class="text-gray-600 mb-2">Welcome back,</p><h3 id="account-drawer-user-email" class="text-lg font-semibold text-gray-800 mb-6 break-words"></h3><a href="customer-account.html" class="w-full text-center bg-mudalali-green text-white p-3 rounded-lg hover:bg-mudalali-green-dark font-bold text-base">Go to My Account</a><button id="drawer-logout-btn" class="w-full text-center bg-gray-100 text-gray-700 p-3 rounded-lg hover:bg-gray-200 font-bold text-base mt-4">Logout</button></div>
            </div>
            <div id="account-drawer-logged-out" class="hidden flex flex-col h-full">
                <div class="p-4 border-b"><div class="flex justify-between items-center"><h2 class="text-xl font-bold text-gray-700">Welcome!</h2><button id="close-account-drawer-btn-logged-out" class="text-gray-500 hover:text-gray-800 text-sm flex items-center gap-1"><i class="fas fa-times"></i> Close</button></div></div>
                <div class="p-2 bg-gray-100 flex gap-2"><button id="drawer-login-tab-btn" class="tab-button active flex-1 bg-white p-2 rounded-md font-semibold border-b-2">Login</button><button id="drawer-signup-tab-btn" class="tab-button flex-1 bg-white p-2 rounded-md font-semibold text-gray-500 border-b-2 border-transparent">Sign Up</button></div>
                <div class="p-6" style="max-height: 80vh; overflow-y: auto;"><form id="drawer-login-form" class="space-y-4"><input type="email" id="drawer-login-email" placeholder="Email" required class="w-full p-3 border rounded-md focus:ring-mudalali-green focus:border-mudalali-green"><input type="password" id="drawer-login-password" placeholder="Password" required class="w-full p-3 border rounded-md focus:ring-mudalali-green focus:border-mudalali-green"><button type="submit" class="w-full bg-mudalali-green text-white p-3 rounded-md hover:bg-mudalali-green-dark font-bold">Login</button><p id="drawer-login-error" class="text-red-500 text-sm text-center"></p></form><form id="drawer-signup-form" class="space-y-4 hidden"><div class="flex items-center"><input id="drawer-signup-is-seller" type="checkbox" class="h-4 w-4 text-mudalali-green focus:ring-mudalali-green border-gray-300 rounded"><label for="drawer-signup-is-seller" class="ml-2 block text-sm text-gray-900">I want to register as a Seller</label></div><input type="text" id="drawer-signup-name" placeholder="Full Name or Store Name" required class="w-full p-3 border rounded-md focus:ring-mudalali-green focus:border-mudalali-green"><input type="email" id="drawer-signup-email" placeholder="Email" required class="w-full p-3 border rounded-md focus:ring-mudalali-green focus:border-mudalali-green"><input type="password" id="drawer-signup-password" placeholder="Password" required class="w-full p-3 border rounded-md focus:ring-mudalali-green focus:border-mudalali-green"><button type="submit" class="w-full bg-mudalali-green text-white p-3 rounded-md hover:bg-mudalali-green-dark font-bold">Create Account</button><p id="drawer-signup-error" class="text-red-500 text-sm text-center"></p></form></div>
            </div>
        </div>
    </div>

    <div id="menu-drawer" class="drawer"><div class="drawer-overlay" id="menu-drawer-overlay"></div><div class="drawer-content left flex flex-col"><div class="flex justify-between items-center p-4 border-b"><h2 class="text-xl font-bold">MENU</h2><button id="menu-drawer-close" class="text-xl">&times;</button></div><div class="p-4 border-b"><form class="flex"><input type="text" placeholder="Search for products" class="w-full px-4 py-2 border border-r-0 border-gray-300 rounded-l-md focus:outline-none"><button type="submit" class="bg-gray-100 border border-gray-300 px-4 rounded-r-md text-gray-600"><i class="fa fa-search"></i></button></form></div><div class="flex border-b"><button id="menu-tab-menu" class="menu-tab-btn active flex-1 py-3 font-semibold border-b-2">MENU</button><button id="menu-tab-categories" class="menu-tab-btn flex-1 py-3 font-semibold text-gray-500 border-b-2 border-transparent">CATEGORIES</button></div><div id="menu-tab-menu-content" class="flex-col flex-grow overflow-y-auto"><a href="index.html" class="block p-4 border-b text-gray-700">HOME</a><a href="stories.html" class="block p-4 border-b text-gray-700">SELLER STORIES</a><a href="shop.html" class="block p-4 border-b text-gray-700">SHOP</a><a href="#" class="block p-4 border-b text-gray-700">ABOUT US</a><a href="#" class="block p-4 border-b text-gray-700">CONTACT US</a><div class="p-4 bg-gray-100 font-bold text-gray-600">MY ACCOUNT</div><a href="wishlist.html" class="block p-4 border-b text-gray-700"><i class="fa fa-heart w-6 mr-1"></i> WISHLIST</a><a href="account.html" id="drawer-my-account-btn" class="block w-full text-left p-4 border-b text-gray-700"><i class="fa fa-user w-6 mr-1"></i> MY ACCOUNT</a></div><div id="menu-tab-categories-content" class="hidden flex-col flex-grow overflow-y-auto"></div></div></div>
    <div id="cart-drawer" class="drawer"><div class="drawer-overlay" id="cart-drawer-overlay"></div><div class="drawer-content flex flex-col"><div class="flex justify-between items-center p-4 border-b"><h2 class="text-xl font-bold">Shopping cart</h2><button id="cart-drawer-close" class="text-xl">&times;</button></div><div id="cart-drawer-items-container" class="flex-grow p-6 overflow-y-auto text-center"><p class="text-gray-500">Your cart is empty.</p></div><div class="p-6 border-t bg-gray-50"><div class="flex justify-between items-center mb-2"><span class="text-lg font-medium text-gray-600">Subtotal:</span><span id="cart-drawer-total" class="text-xl font-bold text-mudalali-green-dark">Rs. 0.00</span></div><p class="text-sm text-center text-gray-500 mb-4">Shipping & taxes calculated at checkout.</p><div class="flex flex-col gap-3"><a href="cart.html" class="w-full text-center bg-white border-2 border-mudalali-green text-mudalali-green p-3 rounded-lg hover:bg-gray-50 font-bold text-base">VIEW CART</a><a href="checkout.html" class="w-full text-center bg-mudalali-green text-white p-3 rounded-lg hover:bg-mudalali-green-dark font-bold text-base">CHECKOUT</a></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, getDocs, collection, onSnapshot, query, where, orderBy, limit, setDoc, addDoc, updateDoc, deleteDoc, increment, serverTimestamp, runTransaction, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDIbu2qT53iGPqMCx5UdU6XY8wvXkb3ZF4",
            authDomain: "mudalali-mama.firebaseapp.com",
            projectId: "mudalali-mama",
            storageBucket: "mudalali-mama.firebasestorage.app",
            messagingSenderId: "296597428969",
            appId: "1:296597428969:web:684668be9c0eaeecb4ae78",
            measurementId: "G-GC1CP1LRFD"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); 
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const publicDataPath = `/artifacts/${appId}/public/data`;
        const usersPath = `/users`; 

        // --- üîë API KEY ---
        const GEMINI_API_KEY = "AIzaSyDgAdpBuh2NCFTc0aW4itJcgBlG-iqVsko"; 

        // --- üß† AI Models List ---
        const GEMINI_MODELS = [
            "gemini-2.0-flash",
            "gemini-2.0-flash-lite",
            "gemini-1.5-flash",
            "gemini-1.5-pro"
        ];

        let chatHistoryBuffer = "";
        let currentUser = null;
        let currentUserData = null;
        let currentProductId = null;
        let currentProductData = null;
        let userRating = 0;
        let wishlistUnsubscribe = null;
        let currentChatId = null; 
        let chatListenerUnsubscribe = null;
        
        // AI Chat State
        let isAiChatMode = false;
        let aiLanguage = null; // Store selected language

        const pageLoader = document.getElementById('page-loader');

        function captureAffiliateRef() {
            const urlParams = new URLSearchParams(window.location.search);
            const affiliateId = urlParams.get('ref');
            if (affiliateId) localStorage.setItem('affiliateRef', affiliateId);
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (pageLoader) pageLoader.style.width = '30%';
            localStorage.setItem('selectedCurrency', 'LKR');

            loadSiteConfig();
            loadDesktopNavCategories();
            loadFooter();
            captureAffiliateRef();
            setupMobileDrawers(); 

            const urlParams = new URLSearchParams(window.location.search);
            currentProductId = urlParams.get('id');

            if (currentProductId) {
                loadProductDetails(currentProductId);
                loadProductReviews(currentProductId);
                setupReviewForm(currentProductId);
            } else {
                showProductError("Product ID not found.");
            }
            
            // Tabs logic
            const descTabBtn = document.getElementById('desc-tab-btn');
            const deliveryTabBtn = document.getElementById('delivery-tab-btn');
            const reviewsTabBtn = document.getElementById('reviews-tab-btn');
            const descTabPanel = document.getElementById('desc-tab-panel');
            const deliveryTabPanel = document.getElementById('delivery-tab-panel');
            const reviewsTabPanel = document.getElementById('reviews-tab-panel');

            descTabBtn?.addEventListener('click', () => {
                descTabBtn.classList.add('active'); deliveryTabBtn.classList.remove('active'); reviewsTabBtn.classList.remove('active');
                descTabPanel.classList.remove('hidden'); deliveryTabPanel.classList.add('hidden'); reviewsTabPanel.classList.add('hidden');
            });
            deliveryTabBtn?.addEventListener('click', () => {
                descTabBtn.classList.remove('active'); deliveryTabBtn.classList.add('active'); reviewsTabBtn.classList.remove('active');
                descTabPanel.classList.add('hidden'); deliveryTabPanel.classList.remove('hidden'); reviewsTabPanel.classList.add('hidden');
            });
            reviewsTabBtn?.addEventListener('click', () => {
                reviewsTabBtn.classList.add('active'); descTabBtn.classList.remove('active'); deliveryTabBtn.classList.remove('active');
                reviewsTabPanel.classList.remove('hidden'); descTabPanel.classList.add('hidden'); deliveryTabPanel.classList.add('hidden');
            });
            
            // Chat Drawers & AI Toggle - ATTACH EVENTS HERE
            const chatBtn = document.getElementById('floating-chat-btn');
            const requestBtn = document.getElementById('request-custom-btn');
            
            if (chatBtn) chatBtn.addEventListener('click', openChatDrawer);
            if (requestBtn) requestBtn.addEventListener('click', openChatDrawer);

            document.getElementById('close-chat-btn').onclick = () => {
                document.getElementById('chat-drawer').classList.remove('open');
                document.getElementById('floating-chat-btn').classList.remove('hidden'); // Show Button
            }
            document.getElementById('chat-overlay').onclick = () => {
                document.getElementById('chat-drawer').classList.remove('open');
                document.getElementById('floating-chat-btn').classList.remove('hidden'); // Show Button
            }
            document.getElementById('ai-toggle').addEventListener('change', toggleChatMode);

            // AI Review Summarizer
            document.getElementById('ai-summarize-btn').addEventListener('click', generateReviewSummary);
        });

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            const loggedInView = document.getElementById('account-drawer-logged-in');
            const loggedOutView = document.getElementById('account-drawer-logged-out');
            
            if (user) {
                loggedInView.classList.remove('hidden'); loggedInView.classList.add('flex');
                loggedOutView.classList.add('hidden'); loggedOutView.classList.remove('flex');
                document.getElementById('account-drawer-user-email').textContent = user.email;
                
                try {
                    const snap = await getDoc(doc(db, usersPath, user.uid));
                    if(snap.exists()) currentUserData = snap.data();
                } catch(e){}

                attachCartDrawerListener(user.uid);
                document.getElementById('review-login-prompt').classList.add('hidden');
                document.getElementById('review-form').classList.remove('hidden');
                checkWishlistStatus();
                attachWishlistBadgeListener(user.uid);
            } else {
                loggedInView.classList.add('hidden'); loggedInView.classList.remove('flex');
                loggedOutView.classList.remove('hidden'); loggedOutView.classList.add('flex');
                attachCartDrawerListener(null); 
                document.getElementById('review-login-prompt').classList.remove('hidden');
                document.getElementById('review-form').classList.add('hidden');
                document.getElementById('wishlist-btn')?.classList.remove('liked');
                if (wishlistUnsubscribe) { wishlistUnsubscribe(); wishlistUnsubscribe = null; }
                updateWishlistCountBadge(0);
            }
        });
        
        function showProductError(message) {
            document.getElementById('product-loader').innerHTML = `<p class="text-center text-red-500 text-xl">${message}</p>`;
            document.getElementById('product-content').classList.add('hidden');
        }

        // --- üß† SMART AI CALL FUNCTION ---
        async function callGeminiAPI(promptText) {
            if (!GEMINI_API_KEY) { console.error("Missing API Key"); return null; }
            
            for (const model of GEMINI_MODELS) {
                try {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
                    });

                    if (!response.ok) throw new Error(`Model ${model} failed`);
                    
                    const data = await response.json();
                    if (data.candidates && data.candidates.length > 0) {
                        return data.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error("No candidates returned");
                    }
                } catch (e) {
                    console.warn(`‚ö†Ô∏è ${model} failed, trying next...`);
                }
            }
            throw new Error("All AI models failed. System busy.");
        }

        // --- ü§ñ AI: CHATBOT LOGIC ---
        function toggleChatMode() {
            const toggle = document.getElementById('ai-toggle');
            isAiChatMode = toggle.checked;
            const header = document.getElementById('chat-header');
            const title = document.getElementById('chat-title');
            const label = document.getElementById('chat-mode-text');
            const btn = document.getElementById('chat-send-btn');
            const status = document.getElementById('chat-status-bar');

            if (isAiChatMode) {
                // Switch to AI Mode
                header.classList.replace('bg-mudalali-green', 'bg-ai-purple');
               title.innerHTML = '<i class="fa fa-robot mr-2"></i>Mudalali AI';
                label.textContent = "Talk to AI";
                btn.classList.replace('bg-mudalali-green', 'bg-ai-purple');
                status.classList.add('hidden');
                
                // Show Language Selection instead of greeting
                showLanguageSelection();
            } else {
                // Switch back to Seller Chat
                header.classList.replace('bg-ai-purple', 'bg-mudalali-green');
                title.innerHTML = '<i class="fa fa-tools mr-2"></i>Customize Request';
                label.textContent = "Chat with Seller";
                btn.classList.replace('bg-ai-purple', 'bg-mudalali-green');
                aiLanguage = null; // Reset language selection
                loadChatHistory(); // Reload Firestore chat
            }
        }

        function showLanguageSelection() {
            const container = document.getElementById('chat-messages');
            container.innerHTML = `
                <div class="chat-product-card">
                    <img src="${currentProductData.imageUrl}" class="w-10 h-10 rounded object-cover">
                    <div><p class="text-xs text-gray-500">Request for:</p><p class="font-bold text-xs">${currentProductData.name}</p></div>
                </div>
                <div class="text-center my-6">
                    <p class="text-sm font-bold text-gray-700 mb-3">Select your Language / ‡∂∑‡∑è‡∑Ç‡∑è‡∑Ä / ‡ÆÆ‡Øä‡Æ¥‡Æø</p>
                    <div class="flex gap-2 justify-center">
                        <button onclick="window.setAiLanguage('English')" class="lang-btn">English</button>
                        <button onclick="window.setAiLanguage('Sinhala')" class="lang-btn">‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω</button>
                        <button onclick="window.setAiLanguage('Tamil')" class="lang-btn">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</button>
                    </div>
                </div>
            `;
        }

        window.setAiLanguage = async (lang) => {
            aiLanguage = lang;
            const container = document.getElementById('chat-messages');
            
            // Clear the selection UI and show greeting
            container.innerHTML = `
                <div class="chat-product-card">
                    <img src="${currentProductData.imageUrl}" class="w-10 h-10 rounded object-cover">
                    <div><p class="text-xs text-gray-500">Request for:</p><p class="font-bold text-xs">${currentProductData.name}</p></div>
                </div>
            `;
            
            // Custom greeting based on language
            let greeting = "Hello! How can I help you with this product?";
            if (lang === 'Sinhala') greeting = "‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä! ‡∂∏‡∑ô‡∂∏ ‡∂∑‡∑è‡∂´‡∑ä‡∂©‡∂∫ ‡∂ú‡∑ê‡∂± ‡∂î‡∂∂‡∂ß ‡∂á‡∂≠‡∑í ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂±‡∂∫ ‡∂ö‡∑î‡∂∏‡∂ö‡∑ä‡∂Ø?";
            if (lang === 'Tamil') greeting = "‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç! ‡Æá‡Æ®‡Øç‡Æ§‡Æ§‡Øç ‡Æ§‡ÆØ‡Ææ‡Æ∞‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æ™‡Øç ‡Æ™‡Æ±‡Øç‡Æ±‡Æø ‡Æ®‡Ææ‡Æ©‡Øç ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡ØÅ‡Æï‡Øç‡Æï‡ØÅ ‡Æé‡Æ™‡Øç‡Æ™‡Æü‡Æø ‡Æâ‡Æ§‡Æµ ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡ØÅ‡ÆÆ‡Øç?";

            container.innerHTML += `<div class="chat-bubble chat-ai">${greeting}</div>`;
        };
// --- üß† AI BARGAINING LOGIC (MUDALALI MODE ON üî•) ---
async function handleAiChat(text) {
    if (!aiLanguage) {
        alert("Please select a language first!");
        return;
    }

    const container = document.getElementById('chat-messages');
    container.innerHTML += `<div class="chat-bubble chat-sent">${text}</div>`;
    
    // Typing indicator
    const typingId = 'typing-' + Date.now();
    container.innerHTML += `<div id="${typingId}" class="chat-bubble chat-ai ai-thinking"><span>.</span><span>.</span><span>.</span></div>`;
    container.scrollTop = container.scrollHeight;

    // --- 1. Pricing Logic ---
    const displayPrice = parseFloat(currentProductData.price);
    let minPrice = displayPrice * 0.90; 

    if (currentProductData.minPrice && !isNaN(currentProductData.minPrice)) {
        minPrice = parseFloat(currentProductData.minPrice);
    }

    // --- 2. Chat History Update ---
    chatHistoryBuffer += `\nCustomer: ${text}`;

    // --- 3. MUDALALI PERSONA INSTRUCTIONS (‡∂∏‡∑ô‡∂≠‡∂± ‡∂≠‡∂∏‡∂∫‡∑í ‡∂ú‡∑ê‡∂∏‡∑ä‡∂∏ ‡∂≠‡∑í‡∂∫‡∑ô‡∂±‡∑ä‡∂±‡∑ö) ---
    let personaInstruction = "";

    if (aiLanguage === 'Sinhala') {
        personaInstruction = `
            **ROLE: You are 'Mudalali Mama' (The Shopkeeper).**
            - **Language:** Use purely **Sinhala Script (‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω)**.
            - **Tone:** Friendly, chatty, slightly persuasive, respectful but smart.
            - **Keywords to use:** "‡∂Ö‡∂±‡∑ö ‡∂∏‡∑Ñ‡∂≠‡∑ä‡∂≠‡∂∫‡∑ù/‡∂±‡∑ù‡∂±‡∑è", "‡∂¥‡∑è‡∂©‡∑î‡∂∫‡∑í", "‡∂î‡∂∫‡∑è ‡∂±‡∑í‡∑É‡∑è ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±‡∂∏‡∑ä", "‡∑Ç‡∑ö‡∂¥‡∑ä ‡∂ë‡∂ö‡∑ö ‡∂ö‡∂ª‡∂∏‡∑î", "‡∂∂‡∂©‡∑î ‡∑Ç‡∑î‡∑Ä‡∂ª‡∑ä", "‡∂ö‡∑ì‡∂∫‡∂Ø ‡∂â‡∂Ω‡∑ä‡∂Ω‡∂±‡∑ä‡∂±‡∑ö?".
            - **Behavior:** Don't just give the price. Praise the product first ("‡∂∏‡∑ö‡∂ö ‡∂î‡∂ª‡∑í‡∂¢‡∑í‡∂±‡∂Ω‡∑ä ‡∂∂‡∂©‡∑î ‡∂∏‡∑Ñ‡∂≠‡∑ä‡∂≠‡∂∫‡∑ù"). Act like you are doing them a favor.
        `;
    } else if (aiLanguage === 'Tamil') {
        personaInstruction = `
            **ROLE: You are a friendly Sri Lankan Shopkeeper.**
            - **Language:** Use **Tamil Script**.
            - **Tone:** Warm, respectful (use 'Sir/Madam'), persuasive.
            - **Behavior:** Talk about quality before dropping price. Act like a real human seller.
        `;
    } else {
        personaInstruction = `
            **ROLE: You are 'Mudalali Mama' (Sri Lankan Shopkeeper).**
            - **Language:** Use **Sri Lankan English (Singlish)**.
            - **Keywords:** "Aney sir", "Madam", "Quality is superb", "Cannot give for that price no", "Shape eke karamu", "Last price".
            - **Behavior:** Be chatty. Don't sound like a robot. Use 'Aiyo' if the offer is too low.
        `;
    }

    // --- 4. SYSTEM PROMPT ---
    const prompt = `
        ${personaInstruction}
        
        **Product Info:**
        - Item: ${currentProductData.name}
        - Listed Price: ${displayPrice}
        - Minimum Reserve Price (Hidden): ${minPrice} (Do NOT reveal this number!)

        **Negotiation Rules:**
        1. **Don't Drop Fast:** If they ask for a discount, complain a bit first ("Aiyo padui ne"). Then drop the price by small amounts (Rs. 50 - 100).
        2. **Protect Min Price:** If user offers below ${minPrice}, say it's impossible politely ("‡∂Ö‡∂±‡∑ö ‡∂í ‡∂ú‡∑è‡∂´‡∂ß ‡∂±‡∂∏‡∑ä ‡∂∂‡∑ë, ‡∂∏‡∂ß‡∂≠‡∑ä ‡∂¥‡∑è‡∂©‡∑î‡∂∫‡∑í"). Give a counter-offer slightly above ${minPrice}.
        3. **Close the Deal:** If user agrees to a price >= ${minPrice}, get excited! Say "Hari onna ehenam dunna".
        4. **Final Tag:** Only when deal is agreed, end message with: ||DEAL_DONE:${minPrice}|| (Replace with agreed price).

        **Chat History:**
        ${chatHistoryBuffer}
        
        **Your Reply (As Mudalali):**
    `;

    try {
        const aiTextRaw = await callGeminiAPI(prompt);
        document.getElementById(typingId).remove();
        
        let replyText = aiTextRaw;
        let dealPrice = null;

        if (aiTextRaw.includes("||DEAL_DONE:")) {
            const parts = aiTextRaw.split("||DEAL_DONE:");
            replyText = parts[0]; 
            let priceString = parts[1].replace('||', '').trim(); 
            dealPrice = parseFloat(priceString); 
        }

        chatHistoryBuffer += `\nMudalali: ${replyText}`;

        container.innerHTML += `<div class="chat-bubble chat-ai">${replyText}</div>`;

        if (dealPrice && !isNaN(dealPrice)) {
            const dealId = `deal-${Date.now()}`;
            const dealHtml = `
                <div class="deal-success-bubble">
                    <div class="text-3xl mb-1">ü§ù</div>
                    <h4 class="font-bold text-lg">Deal Accepted!</h4>
                    <p class="text-sm mb-2">Mudalali agreed to <b>Rs. ${dealPrice.toFixed(2)}</b></p>
                    <button onclick="window.acceptCustomOffer(${dealPrice})" class="bargain-btn">
                        Buy Now at Rs. ${dealPrice.toFixed(2)}
                    </button>
                    <div class="deal-timer" id="timer-${dealId}">Offer expires in 30:00</div>
                </div>
            `;
            container.innerHTML += dealHtml;
            startDealTimer(dealId);
        }

    } catch (e) {
        if(document.getElementById(typingId)) document.getElementById(typingId).remove();
        container.innerHTML += `<div class="chat-bubble chat-ai bg-red-100 text-red-800">AI System Busy. Please try again.</div>`;
        console.error(e);
    }
    container.scrollTop = container.scrollHeight;
}
// --- ‚è±Ô∏è Countdown Timer Logic ---
function startDealTimer(dealId) {
    let time = 30 * 60; // ‡∑Ä‡∑í‡∂±‡∑è‡∂©‡∑í 30
    const timerEl = document.getElementById(`timer-${dealId}`);
    
    const interval = setInterval(() => {
        const minutes = Math.floor(time / 60);
        let seconds = time % 60;
        seconds = seconds < 10 ? '0' + seconds : seconds;
        
        if (timerEl) timerEl.innerHTML = `Offer expires in ${minutes}:${seconds}`;
        time--;
        
        if (time < 0) {
            clearInterval(interval);
            if (timerEl) {
                timerEl.parentElement.innerHTML = `<p class="text-red-500 font-bold text-center">Offer Expired!</p>`;
            }
        }
    }, 1000);
}

        // --- ü§ñ AI: REVIEW SUMMARIZER ---
        async function generateReviewSummary() {
            const btn = document.getElementById('ai-summarize-btn');
            btn.disabled = true; btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Analyzing...';
            
            try {
                // Scrape current reviews from DOM
                const reviews = document.querySelectorAll('#reviews-list-container p.text-gray-600'); 
                let text = "";
                reviews.forEach(r => text += r.textContent + " || ");
                
                if(text.length < 10) throw "Not enough reviews to summarize.";

                // Use Smart Call Function
                const summary = await callGeminiAPI(`Summarize these product reviews into 3 short bullet points highlighting pros and cons: ${text}`);
                
                document.getElementById('ai-summary-text').innerHTML = summary.replace(/\*/g, '').replace(/\n/g, '<br>‚Ä¢ ');
                document.getElementById('ai-summary-box').classList.remove('hidden');
            } catch (e) { 
                alert("Could not generate summary: " + e.message); 
            } finally { 
                btn.disabled = false; btn.innerHTML = '<i class="fa fa-magic"></i> AI Summary'; 
            }
        }

        // --- PRODUCT LOADING & TOUR ---
        async function loadProductDetails(productId) {
            const productRef = doc(db, publicDataPath, 'products', productId);
            try {
                const docSnap = await getDoc(productRef);
                if (!docSnap.exists()) { showProductError("Product not found."); return; }

                currentProductData = { id: docSnap.id, ...docSnap.data() };
                document.title = `${currentProductData.name} - ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑è‡∂Ω‡∑í ‡∂∏‡∑è‡∂∏‡∑è`;
                document.getElementById('product-name').textContent = currentProductData.name;
                document.getElementById('product-description').innerHTML = (currentProductData.description || 'No description.').replace(/\n/g, '<br>');
                document.getElementById('product-price').innerHTML = formatPrice(currentProductData);
                
                const mainImage = document.getElementById('main-product-image');
                const thumbContainer = document.getElementById('product-thumbnails');
                let imageUrls = currentProductData.imageUrls && currentProductData.imageUrls.length > 0 ? currentProductData.imageUrls : [currentProductData.imageUrl];
                mainImage.src = imageUrls[0] || 'https://placehold.co/600x600';
                thumbContainer.innerHTML = ''; 
                if (imageUrls.length > 1) { 
                    imageUrls.forEach((url, index) => {
                        thumbContainer.innerHTML += `<img src="${url}" class="w-20 h-20 object-contain rounded-md border-2 cursor-pointer ${index === 0 ? 'border-mudalali-green' : 'border-transparent'} flex-shrink-0">`;
                    });
                }
                thumbContainer.addEventListener('click', (e) => {
                    if (e.target.tagName === 'IMG') {
                        mainImage.src = e.target.src;
                        thumbContainer.querySelectorAll('img').forEach(img => img.classList.replace('border-mudalali-green', 'border-transparent'));
                        e.target.classList.replace('border-transparent', 'border-mudalali-green');
                    }
                });

                if (currentProductData.variations && currentProductData.variations.length > 0) {
                    const vContainer = document.getElementById('variations-container');
                    document.getElementById('variations-wrapper').classList.remove('hidden');
                    currentProductData.variations.forEach((v, index) => {
                        const chip = document.createElement('div');
                        chip.className = `variation-chip ${index === 0 ? 'selected' : ''}`;
                        chip.textContent = `${v.name}`;
                        if (v.price) chip.textContent += ` - Rs. ${v.price}`;
                        
                        chip.onclick = () => {
                            document.querySelectorAll('.variation-chip').forEach(c => c.classList.remove('selected'));
                            chip.classList.add('selected');
                            if (v.imageUrl && v.imageUrl.trim() !== "") mainImage.src = v.imageUrl;
                            else mainImage.src = currentProductData.imageUrl || 'https://placehold.co/600';
                            
                            if (v.price) document.getElementById('product-price').innerHTML = `<span class="text-3xl font-bold text-mudalali-red">Rs. ${parseFloat(v.price).toFixed(2)}</span>`;
                            else document.getElementById('product-price').innerHTML = formatPrice(currentProductData);
                        };
                        vContainer.appendChild(chip);
                    });
                }

                if (currentProductData.customizationAvailable) {
                    const btn = document.getElementById('request-custom-btn');
                    btn.classList.remove('hidden');
                    // Event listener is already attached in DOMContentLoaded, just need to make sure button is visible
                }

                document.getElementById('add-to-cart-btn').addEventListener('click', () => addToCart(currentProductData, 1));
                document.getElementById('buy-now-btn').addEventListener('click', async () => { await addToCart(currentProductData, 1); window.location.href = 'checkout.html'; });
                document.getElementById('wishlist-btn').addEventListener('click', toggleWishlist);
                
                if (currentProductData.sellerUid) loadSellerInfo(currentProductData.sellerUid);
                else { document.getElementById('tour-seller-info').classList.add('hidden'); document.getElementById('product-delivery-details').innerHTML = '<p>Standard delivery.</p>'; }

                const category = currentProductData.categories ? currentProductData.categories[0] : null;
                if (category) loadRelatedProducts(category, currentProductId);
                else { document.getElementById('related-loader').innerHTML = 'No related products.'; document.getElementById('related-loader-mobile').innerHTML = 'No related products.'; }

                document.getElementById('product-loader').classList.add('hidden');
                document.getElementById('product-content').classList.remove('hidden');
                if (pageLoader) { pageLoader.style.width = '100%'; setTimeout(() => { pageLoader.classList.add('hidden'); }, 500); }

                // --- üöÄ TRIGGER TOUR (FIXED) ---
                setTimeout(() => {
                    if(!localStorage.getItem('tour_seen_v2')) {
                        const driver = window.driver.js.driver;
                        const tourSteps = [];

                        const sellerInfo = document.getElementById('tour-seller-info');
                        if (sellerInfo && !sellerInfo.classList.contains('hidden')) {
                            tourSteps.push({ 
                                element: '#tour-seller-info', 
                                popover: { title: 'Seller Info', description: 'See who is selling this item and visit their store.' } 
                            });
                        }

                        const variationsWrapper = document.getElementById('variations-wrapper');
                        if (variationsWrapper && !variationsWrapper.classList.contains('hidden')) {
                            tourSteps.push({ 
                                element: '#variations-wrapper', 
                                popover: { title: 'Options', description: 'Select your preferred size or color here.' } 
                            });
                        }

                        tourSteps.push({ 
                            element: '#floating-chat-btn', 
                            popover: { title: 'Need Help?', description: 'Chat with the Seller or use our AI Assistant here.' } 
                        });

                        if (tourSteps.length > 0) {
                            const driverObj = driver({ showProgress: true, popoverClass: 'driverjs-theme', steps: tourSteps });
                            driverObj.drive();
                            localStorage.setItem('tour_seen_v2', 'true');
                        }
                    }
                }, 2000);

            } catch (e) { console.error("Error loading product: ", e); showProductError("Error loading product details."); }
        }

        // --- CHAT HISTORY & MESSAGING ---
        function openChatDrawer() {
            if (!currentUser) { document.getElementById('account-drawer-modal').classList.remove('hidden'); return; }
            document.getElementById('chat-drawer').classList.add('open');
            document.getElementById('floating-chat-btn').classList.add('hidden'); // HIDE FLOATING BUTTON
            
            // Only load firestore history if NOT in AI mode
            if (!isAiChatMode) loadChatHistory();
        }

        function loadChatHistory() {
            if (chatListenerUnsubscribe) chatListenerUnsubscribe();
            
            const container = document.getElementById('chat-messages');
            container.innerHTML = '<div class="text-center text-gray-400 mt-10"><i class="fa fa-spinner fa-spin text-2xl"></i></div>';

            const q = query(collection(db, publicDataPath, 'customizationRequests'), where("productId", "==", currentProductId), where("buyerId", "==", currentUser.uid));
            chatListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                if (isAiChatMode) return; // Don't overwrite AI chat if mode changed
                
                if (!snapshot.empty) {
                    const chatDoc = snapshot.docs[0];
                    currentChatId = chatDoc.id;
                    renderChatUI(chatDoc.data());
                } else {
                    currentChatId = null;
                    renderChatUI({ messages: [], status: 'new' });
                }
            });
        }
// --- üü¢ UPDATE: renderChatUI Function ---
function renderChatUI(data) {
    const container = document.getElementById('chat-messages');
    const statusBar = document.getElementById('chat-status-bar');
    const input = document.getElementById('chat-input');
    const btn = document.getElementById('chat-send-btn');
    
    container.innerHTML = '';

    // Product Context Card
    const productCard = document.createElement('div');
    productCard.className = 'chat-product-card';
    productCard.innerHTML = `
        <img src="${currentProductData.imageUrl || 'https://placehold.co/50'}" class="w-12 h-12 object-cover rounded border">
        <div>
            <p class="text-xs text-gray-500">Customization for:</p>
            <p class="font-bold text-sm text-gray-800 line-clamp-1">${currentProductData.name}</p>
            <p class="text-xs font-semibold text-mudalali-green">Base Price: Rs. ${currentProductData.price}</p>
        </div>
    `;
    container.appendChild(productCard);

    if (!data.messages || data.messages.length === 0) {
        container.innerHTML += `<div class="text-center text-gray-400 text-xs mt-6">Send your first message to start the request.</div>`;
    } else {
        data.messages.forEach(msg => {
            const div = document.createElement('div');
            
            // --- üü¢ Seller Offer ‡∂ë‡∂ö‡∂ö‡∑ä‡∂Ø ‡∂ö‡∑í‡∂∫‡∂Ω‡∑è ‡∂∂‡∂Ω‡∂±‡∑Ä‡∑è ---
            if (msg.type === 'offer' && msg.price) {
                div.className = 'chat-offer';
                div.innerHTML = `
                    <p class="text-xs font-bold text-gray-500 uppercase mb-1"><i class="fa fa-tag mr-1"></i> Seller Offer</p>
                    <p class="text-sm text-gray-700">${msg.text || 'Custom price offer received.'}</p>
                    <div class="offer-price">Rs. ${parseFloat(msg.price).toFixed(2)}</div>
                    <button onclick="window.acceptCustomOffer(${msg.price})" class="offer-btn">
                        <i class="fa fa-shopping-cart mr-2"></i> Checkout Now
                    </button>
                `;
            } else {
                // ‡∑É‡∑è‡∂∏‡∑è‡∂±‡∑ä‚Äç‡∂∫ Message ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂±‡∂∏‡∑ä
                div.className = `chat-bubble ${msg.sender === 'buyer' ? 'chat-sent' : 'chat-received'}`;
                div.textContent = msg.text;
            }
            container.appendChild(div);
        });
        setTimeout(() => { container.scrollTop = container.scrollHeight; }, 50);
    }

    statusBar.classList.remove('hidden');
    if (data.status === 'pending') {
        statusBar.textContent = "Waiting for Seller Approval...";
        statusBar.className = "bg-yellow-100 text-yellow-800 py-2 px-4 text-xs font-bold text-center";
        if (data.messages && data.messages.length > 0) { input.disabled = true; btn.disabled = true; input.placeholder = "Pending Approval..."; }
    } else if (data.status === 'approved') {
        statusBar.textContent = "Request Approved! You can chat now.";
        statusBar.className = "bg-green-100 text-green-800 py-2 px-4 text-xs font-bold text-center";
        input.disabled = false; btn.disabled = false; input.placeholder = "Type your message...";
    } else {
        statusBar.classList.add('hidden'); input.disabled = false; btn.disabled = false; input.placeholder = "Describe your customization...";
    }
}

        // --- SEND MESSAGE HANDLER ---
        document.getElementById('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            if (isAiChatMode) {
                // Handle AI Chat
                input.value = '';
                await handleAiChat(text);
            } else {
                // Handle Firebase Seller Chat
                const linkRegex = /(https?:\/\/|www\.|[\w-]+\.(com|net|org|lk|io))/i;
                const phoneRegex = /\d[\d\s-]{8,}\d/; 
                if (linkRegex.test(text) || phoneRegex.test(text)) { alert("Policy Violation: Sharing links or phone numbers is not allowed."); return; }

                input.disabled = true;
                try {
                    const newMessage = { sender: 'buyer', text: text, time: Date.now() };
                    if (!currentChatId) {
                        await addDoc(collection(db, publicDataPath, 'customizationRequests'), {
                            productId: currentProductId,
                            productName: currentProductData.name,
                            productImage: currentProductData.imageUrl,
                            productPrice: currentProductData.price,
                            buyerId: currentUser.uid,
                            buyerName: currentUserData?.name || currentUser.email || 'Buyer', 
                            sellerId: currentProductData.sellerUid,
                            status: 'pending',
                            createdAt: serverTimestamp(),
                            lastUpdated: serverTimestamp(),
                            messages: [newMessage]
                        });
                    } else {
                        await updateDoc(doc(db, publicDataPath, 'customizationRequests', currentChatId), { 
                            messages: arrayUnion(newMessage), 
                            lastUpdated: serverTimestamp() 
                        });
                    }
                    input.value = '';
                } catch (error) { 
                    console.error("Message send error:", error); 
                    alert("Failed to send."); 
                } finally {
                    input.disabled = false;
                    input.focus();
                }
            }
        });

        async function loadSellerInfo(sellerUid) {
            const storeRef = doc(db, publicDataPath, 'stores', sellerUid);
            try {
                const docSnap = await getDoc(storeRef);
                if (docSnap.exists()) {
                    const storeData = docSnap.data();
                    document.getElementById('seller-logo').src = storeData.profileUrl || 'https://placehold.co/80x80';
                    document.getElementById('seller-name').textContent = storeData.storeName || 'Mudalali Mama Seller';
                    document.getElementById('seller-bio').textContent = storeData.description || 'No seller description available.';
                    document.getElementById('seller-store-link').href = `store.html?id=${sellerUid}`;
                    const deliveryEl = document.getElementById('product-delivery-details');
                    if (storeData.deliveryDetails) deliveryEl.innerHTML = storeData.deliveryDetails.replace(/\n/g, '<br>');
                    else deliveryEl.innerHTML = '<p>Standard delivery options are available. Please contact the seller for more details.</p>';
                } else {
                    document.getElementById('tour-seller-info').classList.add('hidden');
                    document.getElementById('product-delivery-details').innerHTML = '<p>Delivery information could not be loaded.</p>';
                }
            } catch (e) { console.error(e); document.getElementById('tour-seller-info').classList.add('hidden'); }
        }
        
        async function loadRelatedProducts(categoryName, currentProductId) {
            const sidebarContainer = document.getElementById('related-products-grid');
            const mobileContainer = document.getElementById('related-products-grid-mobile');
            const productsRef = collection(db, publicDataPath, 'products');
            const q = query(productsRef, where("categories", "array-contains", categoryName), limit(5));
            try {
                const querySnapshot = await getDocs(q);
                let productsFound = 0; sidebarContainer.innerHTML = ''; mobileContainer.innerHTML = '';
                querySnapshot.forEach(doc => {
                    if (doc.id === currentProductId || productsFound >= 4) return; 
                    const product = doc.data();
                    let priceString = `Rs. ${parseFloat(product.price).toFixed(2)}`;
                    let priceClass = 'text-mudalali-green-dark';
                    if (product.originalPrice) { priceClass = 'text-mudalali-red'; priceString = `${priceString} <span class="text-gray-400 line-through text-xs">Rs. ${parseFloat(product.originalPrice).toFixed(2)}</span>`; }
                    const sidebarHtml = `<a href="product.html?id=${doc.id}" class="group bg-white p-3 rounded-lg shadow-md hover:shadow-lg transition-shadow flex items-center gap-3"><img src="${product.imageUrl || 'https://placehold.co/80x80'}" class="w-16 h-16 rounded-md object-cover"><div class="flex-grow"><p class="text-sm font-semibold text-gray-800 line-clamp-2">${product.name}</p><div class="text-sm font-bold ${priceClass}">${priceString}</div></div></a>`;
                    const mobileHtml = `<a href="product.html?id=${doc.id}" class="group bg-white rounded-lg shadow overflow-hidden transform transition-all duration-300 hover:shadow-lg hover:-translate-y-1"><div class="h-40 w-full overflow-hidden"><img src="${product.imageUrl || 'https://placehold.co/300x300'}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"></div><div class="p-3 text-center"><h4 class="text-sm font-semibold text-gray-800 line-clamp-2 mb-2">${product.name}</h4><div class="text-sm font-bold ${priceClass}">${priceString}</div></div></a>`;
                    sidebarContainer.innerHTML += sidebarHtml; mobileContainer.innerHTML += mobileHtml; productsFound++;
                });
                if (productsFound === 0) {
                    const noProductsMsg = '<p class="text-gray-500 text-sm">No other products found.</p>';
                    sidebarContainer.innerHTML = noProductsMsg; mobileContainer.innerHTML = `<p class="text-gray-500 text-sm col-span-full">${noProductsMsg}</p>`;
                }
            } catch (e) { console.error(e); }
        }

        function loadProductReviews(productId) {
            const listContainer = document.getElementById('reviews-list-container');
            const avgStarsEl = document.getElementById('product-average-rating-stars').querySelector('.display-stars-filled');
            const reviewCountEl = document.getElementById('product-review-count');
            const q = query(collection(db, publicDataPath, 'productReviews'), where("productId", "==", productId), orderBy("createdAt", "asc"));
            onSnapshot(q, async (snapshot) => {
                if (snapshot.empty) { listContainer.innerHTML = '<p class="text-gray-500">No reviews yet.</p>'; avgStarsEl.style.width = '0%'; reviewCountEl.textContent = '(0 reviews)'; return; }
                listContainer.innerHTML = ''; let totalRating = 0; let reviewCount = 0;
                for (const doc of snapshot.docs) {
                    const review = doc.data(); let userName = 'Anonymous';
                    try { const userSnap = await getDoc(doc(db, usersPath, review.userId)); if (userSnap.exists()) userName = userSnap.data().name || 'Anonymous'; } catch (e) {}
                    const reviewDate = review.createdAt ? formatTimestamp(review.createdAt.toDate()) : '';
                    totalRating += review.rating; reviewCount++;
                    listContainer.innerHTML += `<div class="border-t pt-4"><div class="flex justify-between items-center mb-1"><h4 class="font-semibold text-gray-800">${userName}</h4><span class="text-xs text-gray-400">${reviewDate}</span></div><div class="display-stars text-xl"><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i><div class="display-stars-filled" style="width: ${review.rating * 20}%;"><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i></div></div><p class="text-gray-600 mt-2">${review.text}</p></div>`;
                }
                const averageRating = totalRating / reviewCount; avgStarsEl.style.width = `${averageRating * 20}%`; reviewCountEl.textContent = `(${reviewCount} review${reviewCount > 1 ? 's' : ''})`;
            });
        }

        function setupReviewForm(productId) {
            const starsContainer = document.getElementById('rating-stars-input'); const stars = starsContainer.querySelectorAll('.star');
            const form = document.getElementById('review-form'); const statusEl = document.getElementById('review-submit-status');
            document.getElementById('login-to-review-btn').addEventListener('click', () => document.getElementById('account-drawer-modal')?.classList.remove('hidden'));
            const setRating = (value) => { userRating = value; starsContainer.classList.add('selected'); stars.forEach(star => { if (star.dataset.value == value) star.classList.add('selected'); else star.classList.remove('selected'); }); };
            stars.forEach(star => star.addEventListener('click', () => setRating(star.dataset.value)));
            form.addEventListener('submit', async (e) => {
                e.preventDefault(); if (!currentUser) { document.getElementById('account-drawer-modal')?.classList.remove('hidden'); return; }
                if (userRating === 0) { statusEl.textContent = 'Select a rating.'; statusEl.className = 'text-sm text-red-500'; return; }
                statusEl.textContent = 'Submitting...'; statusEl.className = 'text-sm text-gray-600';
                try {
                    await runTransaction(db, async (transaction) => {
                        const pSnap = await transaction.get(doc(db, publicDataPath, 'products', productId)); if (!pSnap.exists()) throw "Product error";
                        const data = pSnap.data(); const newReviewCount = (data.reviewCount || 0) + 1; const newTotalRating = (data.totalRating || 0) + userRating;
                        transaction.update(doc(db, publicDataPath, 'products', productId), { reviewCount: newReviewCount, totalRating: newTotalRating, averageRating: newTotalRating / newReviewCount });
                    });
                    await addDoc(collection(db, publicDataPath, 'productReviews'), { productId, userId: currentUser.uid, rating: userRating, text: document.getElementById('review-text').value, createdAt: serverTimestamp() });
                    statusEl.textContent = 'Done!'; statusEl.className = 'text-sm text-green-600'; form.reset(); setRating(0); starsContainer.classList.remove('selected');
                } catch (error) { console.error(error); statusEl.textContent = 'Error.'; statusEl.className = 'text-sm text-red-500'; }
            });
        }
        
        function formatTimestamp(date) { const seconds = Math.floor((new Date() - date) / 1000); let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + "y ago"; interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + "mo ago"; interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + "d ago"; return Math.floor(seconds) + "s ago"; }
        function getSelectedCurrency() { return localStorage.getItem('selectedCurrency') || 'LKR'; }
        function formatPrice(product) {
            let prices = { price: `Rs. ${parseFloat(product.price).toFixed(2)}`, originalPrice: product.originalPrice ? `Rs. ${parseFloat(product.originalPrice).toFixed(2)}` : null, priceClass: 'text-mudalali-red' };
            return `<span class="text-3xl font-bold ${prices.priceClass}">${prices.price}</span>${prices.originalPrice ? `<span class="text-xl text-gray-400 line-through ml-2">${prices.originalPrice}</span>` : ''}`;
        }
        const addToCart = async (product, quantity = 1) => {
            if (!currentUser) { document.getElementById('account-drawer-modal')?.classList.remove('hidden'); return; }
            const cartItemRef = doc(db, usersPath, currentUser.uid, 'cart', product.id); 
            try {
                const docSnap = await getDoc(cartItemRef);
                if (docSnap.exists()) await updateDoc(cartItemRef, { quantity: increment(quantity) });
                else await setDoc(cartItemRef, { productId: product.id, name: product.name, price: product.price, priceUSDT: product.priceUSDT || null, imageUrl: product.imageUrl, quantity: quantity, addedAt: serverTimestamp() });
                document.getElementById('cart-drawer').classList.add('open');
            } catch (error) { console.error("Error adding to cart: ", error); }
        };
        async function toggleWishlist() {
            if (!currentUser) { document.getElementById('account-drawer-modal')?.classList.remove('hidden'); return; }
            const btn = document.getElementById('wishlist-btn'); btn.disabled = true;
            const ref = doc(db, usersPath, currentUser.uid, 'wishlist', currentProductId);
            try { const snap = await getDoc(ref); if (snap.exists()) { await deleteDoc(ref); btn.classList.remove('liked'); } else { await setDoc(ref, { productId: currentProductId, name: currentProductData.name, price: currentProductData.price, imageUrl: currentProductData.imageUrl, addedAt: serverTimestamp() }); btn.classList.add('liked'); } } catch (e) { console.error(e); } finally { btn.disabled = false; }
        }
        async function checkWishlistStatus() { if (!currentUser || !currentProductId) return; const snap = await getDoc(doc(db, usersPath, currentUser.uid, 'wishlist', currentProductId)); if (snap.exists()) document.getElementById('wishlist-btn').classList.add('liked'); else document.getElementById('wishlist-btn').classList.remove('liked'); }
        function attachWishlistBadgeListener(userId) { if (wishlistUnsubscribe) wishlistUnsubscribe(); wishlistUnsubscribe = onSnapshot(collection(db, usersPath, userId, 'wishlist'), (snap) => updateWishlistCountBadge(snap.size)); }
        function updateWishlistCountBadge(count) { const b = document.getElementById('wishlist-count-badge'); if (b) { b.textContent = count; if (count > 0) { b.classList.add('pop'); setTimeout(() => b.classList.remove('pop'), 200); } } }
        async function loadSiteConfig() { try { const snap = await getDoc(doc(db, publicDataPath, 'siteContent', 'config')); if(snap.exists()) { const c = snap.data(); if(c.logoImageUrl) { document.getElementById('logo-img').src = c.logoImageUrl; document.getElementById('mobile-logo-img').src = c.logoImageUrl; } } } catch(e){} }
        async function loadDesktopNavCategories() { onSnapshot(collection(db, publicDataPath, 'categories'), (snap) => { const c = document.getElementById('desktop-nav-links-container'); if(!c)return; const d = c.querySelector('.dropdown-menu'); d.innerHTML=''; let count=0; snap.forEach(doc=>{ const cat=doc.data(); if(count<6) c.insertAdjacentHTML('beforeend', `<a href="shop.html?category=${encodeURIComponent(cat.name)}" class="font-semibold text-gray-700 hover:text-mudalali-green-dark px-3 py-2.5 hidden md:block">${cat.name}</a>`); d.innerHTML+=`<a href="shop.html?category=${encodeURIComponent(cat.name)}" class="font-semibold text-gray-700 hover:text-mudalali-green-dark px-4 py-3 block border-b">${cat.name}</a>`; count++; }); }); }
        async function loadFooter() { /* Footer loading logic similar to previous */ }
        function setupMobileDrawers() { /* Mobile drawer logic similar to previous */ }
        function attachCartDrawerListener(uid) { /* Cart listener logic similar to previous */ }
        function addCartDrawerButtonListeners(uid) { /* Cart button listeners similar to previous */ }

        // --- üü¢ NEW: Handle Custom Offer Checkout ---
window.acceptCustomOffer = async (customPrice) => {
    if (!currentUser) {
        document.getElementById('account-drawer-modal')?.classList.remove('hidden');
        return;
    }

    // Loading ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂∏‡∑î
    const btn = document.querySelector('.offer-btn'); // ‡∂Ö‡∂±‡∑ä‡∂≠‡∑í‡∂∏ offer button ‡∂ë‡∂ö
    if(btn) {
        btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Processing...';
        btn.disabled = true;
    }

    try {
        const userId = currentUser.uid;
        // Cart ‡∂ë‡∂ö‡∂ß ‡∂Ø‡∑è‡∂±‡∑ä‡∂± ‡∂ï‡∂± ‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç ‡∑Ä‡∑í‡∂Ø‡∑í‡∂∫‡∂ß (Custom Price ‡∂ë‡∂ö‡∂≠‡∑ä ‡∂ë‡∂ö‡∑ä‡∂ö)
        // ‡∂Ö‡∂¥‡∑í ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä item ID ‡∂ë‡∂ö‡∂ö‡∑ä ‡∑Ñ‡∂Ø‡∂±‡∑Ä‡∑è (custom_originalID_timestamp)
        const customItemId = `${currentProductData.id}_custom_${Date.now()}`;
        
        const cartItemRef = doc(db, usersPath, userId, 'cart', customItemId);

        await setDoc(cartItemRef, {
            productId: currentProductData.id,
            name: `${currentProductData.name} (Customized)`,
            price: Number(customPrice), // Seller ‡∂ë‡∑Ä‡∂¥‡∑î ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä ‡∂ú‡∑è‡∂´
            priceUSDT: null,
            imageUrl: currentProductData.imageUrl,
            quantity: 1,
            isCustom: true, // Custom order ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂∂‡∑Ä ‡∑Ñ‡∂≥‡∑î‡∂±‡∑è‡∂ú‡∂±‡∑ä‡∂±
            addedAt: serverTimestamp()
        });

        // Cart drawer ‡∂ë‡∂ö ‡∂Ö‡∂ª‡∑í‡∂±‡∑ä‡∂±‡∑ö ‡∂±‡∑ê‡∂≠‡∑î‡∑Ä ‡∂ö‡∑ô‡∂Ω‡∑í‡∂±‡∑ä‡∂∏ Checkout ‡∂ë‡∂ö‡∂ß ‡∂∫‡∑Ä‡∂±‡∑Ä‡∑è
        window.location.href = 'checkout.html';

    } catch (error) {
        console.error("Error adding custom offer to cart: ", error);
        alert("Something went wrong. Please try again.");
        if(btn) {
            btn.innerHTML = '<i class="fa fa-shopping-cart mr-2"></i> Checkout Now';
            btn.disabled = false;
        }
    }
};

    </script>
</body>
</html>