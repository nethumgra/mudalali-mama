<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - මුදලාලි මාමා</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: {
                        'mudalali-green': { light: '#76b852', DEFAULT: '#3a6a4a', dark: '#2c5234' },
                        'mudalali-gold': '#bda26b',
                        'mudalali-red': '#d93a3e',
                        'mudalali-bg': '#f5f5f4',
                        'mm-gray': { light: '#f8f8f8', DEFAULT: '#e5e5e5' }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        body { @apply font-sans text-gray-800; }
        .drawer-overlay { @apply fixed inset-0 bg-black bg-opacity-50 z-50 transition-opacity opacity-0 pointer-events-none; }
        .drawer-content { @apply fixed top-0 right-0 h-full bg-white shadow-xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out; width: 90%; max-width: 400px; }
        .drawer.open .drawer-overlay { @apply opacity-100 pointer-events-auto; }
        .drawer.open .drawer-content { @apply transform translate-x-0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        /* Ratings & UI */
        .rating-stars .star { @apply text-gray-300 cursor-pointer text-3xl transition-colors; }
        .rating-stars:hover .star { @apply text-mudalali-gold; }
        .rating-stars .star:hover ~ .star { @apply text-gray-300; }
        .rating-stars .star.selected { @apply text-mudalali-gold; }
        .display-stars { @apply relative inline-block text-gray-300; }
        .display-stars-filled { @apply absolute top-0 left-0 whitespace-nowrap overflow-hidden text-mudalali-gold; }
        #wishlist-btn.liked { @apply bg-mudalali-red text-white; }
        .page-tab-btn { @apply flex-1 text-center py-4 px-2 font-semibold text-gray-500 border-b-2 border-transparent transition-colors; }
        .page-tab-btn.active { @apply text-mudalali-green border-mudalali-green; }
    </style>
</head>
<body class="pb-20 md:pb-0" style="background-color: #f5f5f4;"> 
    
    <div id="page-loader" class="fixed top-0 left-0 w-0 h-1 bg-mudalali-green z-[9999] transition-all duration-300 ease-linear"></div>
    
    <div id="header-container"></div>

    <main class="container mx-auto p-4 md:p-8 pb-32" style="min-height: calc(100vh - 200px);">
        
        <div id="product-loader" class="w-full text-center py-20">
            <svg class="animate-spin h-10 w-10 text-mudalali-green mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-gray-500 font-semibold">Loading Product...</p>
        </div>

        <div id="product-content" class="hidden lg:grid lg:grid-cols-3 lg:gap-8">
            
            <div id="seller-info-box" class="lg:col-span-3 bg-white rounded-lg shadow-lg mb-6 p-6 flex items-center gap-4">
                <img id="seller-logo" src="" onerror="window.imgError(this)" alt="Seller" class="w-20 h-20 rounded-full object-cover border-2 border-gray-200">
                <div class="flex-grow">
                    <p class="text-sm text-gray-500">Sold By:</p>
                    <h3 id="seller-name" class="text-xl font-bold text-gray-800">Loading...</h3>
                    <p id="seller-bio" class="text-sm text-gray-600 mt-1 line-clamp-2"></p>
                </div>
                <a id="seller-store-link" href="#" class="flex-shrink-0 bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-semibold text-sm hover:bg-gray-200">Visit Store</a>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                    <div class="lg:flex">
                        <div class="lg:w-1/2 p-4">
                            <img id="main-product-image" src="" onerror="window.imgError(this)" alt="Product" class="w-full h-auto object-contain rounded-lg border">
                            <div id="product-thumbnails" class="flex gap-2 mt-2 overflow-x-auto no-scrollbar p-1"></div>
                        </div>
                        
                        <div class="lg:w-1/2 p-6 flex flex-col">
                            <h1 id="product-name" class="text-3xl font-bold text-gray-800">...</h1>
                            <div class="flex items-center my-2">
                                <div id="product-average-rating-stars" class="display-stars text-2xl">
                                    <i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i>
                                    <div class="display-stars-filled" style="width: 0%;">
                                        <i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i><i class="fa fa-star"></i>
                                    </div>
                                </div>
                                <span id="product-review-count" class="ml-2 text-sm text-gray-500">(0 reviews)</span>
                            </div>

                            <div id="product-price" class="my-4">
                                <span class="text-3xl font-bold text-mudalali-red">Rs. 0.00</span>
                            </div>
                            
                            <div class="flex-grow"></div> 
                            
                            <div class="flex flex-wrap items-center gap-3 mt-6">
                                <button id="add-to-cart-btn" class="flex-grow bg-mudalali-green text-white p-3 rounded-lg hover:bg-mudalali-green-dark font-bold text-lg whitespace-nowrap">
                                    <i class="fa fa-shopping-cart mr-2"></i> Add to Cart
                                </button>
                                <button id="buy-now-btn" class="flex-grow bg-mudalali-green-dark text-white p-3 rounded-lg hover:bg-mudalali-green font-bold text-lg whitespace-nowrap">
                                    <i class="fa fa-bolt mr-2"></i> Buy Now
                                </button>
                                <button id="wishlist-btn" class="w-14 h-14 border-2 border-mudalali-red text-mudalali-red rounded-lg flex items-center justify-center text-2xl hover:bg-mudalali-red hover:text-white transition-colors">
                                    <i class="fa fa-heart"></i>
                                </button>
                            </div>
                            
                            <button id="request-custom-btn" class="mt-3 w-full border-2 border-blue-600 text-blue-600 p-2 rounded-lg hover:bg-blue-600 hover:text-white font-bold transition-colors">
                                <i class="fa fa-tools mr-2"></i> Request Customization
                            </button>
                            
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-lg mt-8">
                    <div class="flex border-b">
                        <button id="desc-tab-btn" class="page-tab-btn active">Description</button>
                        <button id="delivery-tab-btn" class="page-tab-btn">Delivery Details</button>
                        <button id="reviews-tab-btn" class="page-tab-btn">Reviews</button>
                    </div>
                
                    <div id="desc-tab-panel" class="p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Product Description</h2>
                        <p id="product-description" class="text-gray-600 leading-relaxed">Loading...</p>
                    </div>

                    <div id="delivery-tab-panel" class="p-6 hidden">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Delivery Details</h2>
                        <div id="product-delivery-details" class="text-gray-600 leading-relaxed space-y-2">Loading...</div>
                    </div>

                    <div id="reviews-tab-panel" class="p-6 hidden">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Customer Reviews</h2>
                        <div id="review-form-container" class="mb-6 border-b pb-6">
                            <h3 class="text-lg font-semibold mb-2">Leave a Review</h3>
                            <div id="review-login-prompt" class="hidden">
                                <p class="text-gray-600">Please <button id="login-to-review-btn" class="font-bold text-mudalali-green hover:underline">log in</button> to leave a review.</p>
                            </div>
                            <form id="review-form" class="hidden space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Your Rating:</label>
                                    <div id="rating-stars-input" class="rating-stars flex flex-row-reverse justify-end">
                                        <i class="star fa fa-star" data-value="5"></i><i class="star fa fa-star" data-value="4"></i><i class="star fa fa-star" data-value="3"></i><i class="star fa fa-star" data-value="2"></i><i class="star fa fa-star" data-value="1"></i>
                                    </div>
                                </div>
                                <div>
                                    <label for="review-text" class="block text-sm font-medium text-gray-700">Your Review:</label>
                                    <textarea id="review-text" rows="3" class="mt-1 block w-full p-2 border rounded-md focus:ring-mudalali-green focus:border-mudalali-green" placeholder="Write your review here..."></textarea>
                                </div>
                                <button type="submit" class="bg-mudalali-green text-white px-5 py-2 rounded-lg font-semibold hover:bg-mudalali-green-dark">Submit Review</button>
                                <p id="review-submit-status" class="text-sm"></p>
                            </form>
                        </div>
                        <div id="reviews-list-container" class="space-y-4"></div>
                    </div>
                </div>
            </div>
            
            <div id="related-products-sidebar" class="hidden lg:block lg:col-span-1 space-y-6 sticky top-24">
                <h3 class="text-xl font-bold text-gray-800">Related Products</h3>
                <div id="related-products-grid" class="space-y-4"></div>
            </div>

            <div id="related-products-section-mobile" class="mt-8 lg:hidden lg:col-span-3">
                 <h2 class="text-2xl font-bold text-gray-800 mb-4">Related Products</h2>
                <div id="related-products-grid-mobile" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            </div>
        </div>
    </main>

    <div id="custom-request-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4">
        <div class="fixed inset-0 bg-black bg-opacity-50" id="custom-modal-overlay"></div>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md relative z-10 p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Request Customization</h2>
            <p class="text-sm text-gray-600 mb-4">Send a request to the seller for custom colors, sizes, or bulk orders.</p>
            <form id="custom-request-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Your Request</label>
                    <textarea id="custom-request-text" rows="4" class="mt-1 block w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., I need this in Red color, size XL..." required></textarea>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="close-custom-modal-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-bold">Send Request</button>
                </div>
            </form>
        </div>
    </div>

    <div id="footer-container-wrapper"></div>

    <div id="account-drawer-modal" class="drawer drawer-modal fixed inset-0 z-50 hidden">
        <div id="account-drawer-bg" class="drawer-bg fixed inset-0 bg-black bg-opacity-50 opacity-0 transition-opacity"></div>
        <div id="account-drawer" class="drawer-content fixed top-0 right-0 h-full bg-white shadow-xl w-full max-w-md flex flex-col">
            <div id="account-drawer-logged-in" class="hidden flex flex-col h-full">
                <div class="p-4 flex justify-between items-center border-b flex-shrink-0">
                    <h2 class="text-xl font-semibold text-gray-800">My Account</h2>
                    <button id="close-account-drawer-btn-logged-in" class="text-gray-500 hover:text-gray-800 text-sm flex items-center gap-1"><i class="fas fa-times"></i> Close</button>
                </div>
                <div class="flex-grow p-6 overflow-y-auto">
                    <p class="text-gray-600 mb-2">Welcome back,</p>
                    <h3 id="account-drawer-user-email" class="text-lg font-semibold text-gray-800 mb-6 break-words"></h3>
                    <a href="account.html" class="w-full text-center bg-mudalali-green text-white p-3 rounded-lg hover:bg-mudalali-green-dark font-bold text-base">Go to My Account</a>
                    <button id="drawer-logout-btn" class="w-full text-center bg-gray-100 text-gray-700 p-3 rounded-lg hover:bg-gray-200 font-bold text-base mt-4">Logout</button>
                </div>
            </div>
            <div id="account-drawer-logged-out" class="hidden flex flex-col h-full">
                <div class="p-4 border-b"><div class="flex justify-between items-center"><h2 class="text-xl font-bold text-gray-700">Welcome!</h2><button id="close-account-drawer-btn-logged-out" class="text-gray-500 hover:text-gray-800 text-sm flex items-center gap-1"><i class="fas fa-times"></i> Close</button></div></div>
                <div class="p-2 bg-gray-100 flex gap-2"><button id="drawer-login-tab-btn" class="tab-button active flex-1 bg-white p-2 rounded-md font-semibold border-b-2">Login</button><button id="drawer-signup-tab-btn" class="tab-button flex-1 bg-white p-2 rounded-md font-semibold text-gray-500 border-b-2 border-transparent">Sign Up</button></div>
                <div class="p-6" style="max-height: 80vh; overflow-y: auto;">
                    <form id="drawer-login-form" class="space-y-4"><input type="email" id="drawer-login-email" placeholder="Email" required class="w-full p-3 border rounded-md focus:ring-mudalali-green focus:border-mudalali-green"><input type="password" id="drawer-login-password" placeholder="Password" required class="w-full p-3 border rounded-md focus:ring-mudalali-green focus:border-mudalali-green"><button type="submit" class="w-full bg-mudalali-green text-white p-3 rounded-md hover:bg-mudalali-green-dark font-bold">Login</button><p id="drawer-login-error" class="text-red-500 text-sm text-center"></p></form>
                    <form id="drawer-signup-form" class="space-y-4 hidden"><div class="flex items-center"><input id="drawer-signup-is-seller" type="checkbox" class="h-4 w-4 text-mudalali-green focus:ring-mudalali-green border-gray-300 rounded"><label for="drawer-signup-is-seller" class="ml-2 block text-sm text-gray-900">I want to register as a Seller</label></div><input type="text" id="drawer-signup-name" placeholder="Full Name or Store Name" required class="w-full p-3 border rounded-md focus:ring-mudalali-green focus:border-mudalali-green"><input type="email" id="drawer-signup-email" placeholder="Email" required class="w-full p-3 border rounded-md focus:ring-mudalali-green focus:border-mudalali-green"><input type="password" id="drawer-signup-password" placeholder="Password" required class="w-full p-3 border rounded-md focus:ring-mudalali-green focus:border-mudalali-green"><button type="submit" class="w-full bg-mudalali-green text-white p-3 rounded-md hover:bg-mudalali-green-dark font-bold">Create Account</button><p id="drawer-signup-error" class="text-red-500 text-sm text-center"></p></form>
                </div>
            </div>
        </div>
    </div>

    <div id="menu-drawer" class="drawer">
        <div class="drawer-overlay" id="menu-drawer-overlay"></div>
        <div class="drawer-content left flex flex-col">
            <div class="flex justify-between items-center p-4 border-b"><h2 class="text-xl font-bold">MENU</h2><button id="menu-drawer-close" class="text-xl">&times;</button></div>
            <div class="p-4 border-b"><form class="flex"><input type="text" placeholder="Search for products" class="w-full px-4 py-2 border border-r-0 border-gray-300 rounded-l-md focus:outline-none"><button type="submit" class="bg-gray-100 border border-gray-300 px-4 rounded-r-md text-gray-600"><i class="fa fa-search"></i></button></form></div>
            <div class="flex border-b"><button id="menu-tab-menu" class="menu-tab-btn active flex-1 py-3 font-semibold border-b-2">MENU</button><button id="menu-tab-categories" class="menu-tab-btn flex-1 py-3 font-semibold text-gray-500 border-b-2 border-transparent">CATEGORIES</button></div>
            <div id="menu-tab-menu-content" class="flex-col flex-grow overflow-y-auto"><a href="index.html" class="block p-4 border-b font-semibold text-mudalali-green">HOME</a><a href="stories.html" class="block p-4 border-b text-gray-700">SELLER STORIES</a><a href="shop.html" class="block p-4 border-b text-gray-700">SHOP</a><div class="p-4 bg-gray-100 font-bold text-gray-600">MY ACCOUNT</div><a href="wishlist.html" class="block p-4 border-b text-gray-700"><i class="fa fa-heart w-6 mr-1"></i> WISHLIST</a><a href="account.html" id="drawer-my-account-btn" class="block w-full text-left p-4 border-b text-gray-700"><i class="fa fa-user w-6 mr-1"></i> MY ACCOUNT</a></div>
            <div id="menu-tab-categories-content" class="hidden flex-col flex-grow overflow-y-auto"></div>
        </div>
    </div>

    <div id="cart-drawer" class="drawer">
        <div class="drawer-overlay" id="cart-drawer-overlay"></div>
        <div class="drawer-content flex flex-col">
            <div class="flex justify-between items-center p-4 border-b"><h2 class="text-xl font-bold">Shopping cart</h2><button id="cart-drawer-close" class="text-xl">&times;</button></div>
            <div id="cart-drawer-items-container" class="flex-grow p-6 overflow-y-auto text-center"><p class="text-gray-500">Your cart is empty.</p></div>
            <div class="p-6 border-t bg-gray-50"><div class="flex justify-between items-center mb-2"><span class="text-lg font-medium text-gray-600">Subtotal:</span><span id="cart-drawer-total" class="text-xl font-bold text-mudalali-green-dark">Rs. 0.00</span></div><p class="text-sm text-center text-gray-500 mb-4">Shipping & taxes calculated at checkout.</p><div class="flex flex-col gap-3"><a href="cart.html" class="w-full text-center bg-white border-2 border-mudalali-green text-mudalali-green p-3 rounded-lg hover:bg-gray-50 font-bold text-base">VIEW CART</a><a href="checkout.html" class="w-full text-center bg-mudalali-green text-white p-3 rounded-lg hover:bg-mudalali-green-dark font-bold text-base">CHECKOUT</a></div></div>
        </div>
    </div>
    
    <script type="module">
        import { db, auth, publicDataPath, usersPath } from "./js/config/firebase.js";
        import { getHeaderHTML, initHeaderEvents } from "./js/components/header.js";
        import { getFooterHTML, loadFooterData } from "./js/components/footer.js";

        import { createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { doc, getDoc, getDocs, collection, onSnapshot, query, where, orderBy, limit, setDoc, addDoc, updateDoc, deleteDoc, increment, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let currentUser = null;
        let currentProductId = null;
        let currentProductData = null;
        let userRating = 0;
        let wishlistUnsubscribe = null;
        const pageLoader = document.getElementById('page-loader');

        window.imgError = function(image) { image.onerror = ""; image.src = "https://placehold.co/400x400/e5e5e5/a0a0a0?text=No+Image"; return true; };

        document.addEventListener('DOMContentLoaded', () => {
            console.log("Mudalali Mama Product Page Initialized");
            if (pageLoader) pageLoader.style.width = '30%';

            document.getElementById('header-container').innerHTML = getHeaderHTML();
            initHeaderEvents();
            document.getElementById('footer-container-wrapper').innerHTML = getFooterHTML();
            loadFooterData(db);
            
            // Load nav logic if present in header.js or add here
            loadDesktopNavCategories();
            setupMobileDrawers(); 

            const urlParams = new URLSearchParams(window.location.search);
            currentProductId = urlParams.get('id');

            if (currentProductId) {
                loadProductDetails(currentProductId);
                loadProductReviews(currentProductId);
                setupReviewForm(currentProductId);
                setupCustomizationRequest(currentProductId); // NEW
            } else {
                showProductError("Product ID not found.");
            }

            setupTabs();
        });

        function setupTabs() {
            const descTabBtn = document.getElementById('desc-tab-btn');
            const deliveryTabBtn = document.getElementById('delivery-tab-btn');
            const reviewsTabBtn = document.getElementById('reviews-tab-btn');
            const descTabPanel = document.getElementById('desc-tab-panel');
            const deliveryTabPanel = document.getElementById('delivery-tab-panel');
            const reviewsTabPanel = document.getElementById('reviews-tab-panel');

            const switchTab = (activeBtn, activePanel) => {
                [descTabBtn, deliveryTabBtn, reviewsTabBtn].forEach(btn => btn.classList.remove('active'));
                [descTabPanel, deliveryTabPanel, reviewsTabPanel].forEach(panel => panel.classList.add('hidden'));
                activeBtn.classList.add('active');
                activePanel.classList.remove('hidden');
            };

            descTabBtn?.addEventListener('click', () => switchTab(descTabBtn, descTabPanel));
            deliveryTabBtn?.addEventListener('click', () => switchTab(deliveryTabBtn, deliveryTabPanel));
            reviewsTabBtn?.addEventListener('click', () => switchTab(reviewsTabBtn, reviewsTabPanel));
        }

        async function loadProductDetails(productId) {
            try {
                const docSnap = await getDoc(doc(db, publicDataPath, 'products', productId));
                if (!docSnap.exists()) { showProductError("Product not found."); return; }

                currentProductData = { id: docSnap.id, ...docSnap.data() };
                document.title = `${currentProductData.name} - මුදලාලි මාමා`;
                document.getElementById('product-name').textContent = currentProductData.name;
                document.getElementById('product-description').textContent = currentProductData.description || 'No description.';
                document.getElementById('product-price').innerHTML = formatPrice(currentProductData);

                const mainImage = document.getElementById('main-product-image');
                const thumbContainer = document.getElementById('product-thumbnails');
                let imageUrls = currentProductData.imageUrls && currentProductData.imageUrls.length > 0 
                    ? currentProductData.imageUrls 
                    : (currentProductData.imageUrl ? [currentProductData.imageUrl] : ['https://placehold.co/600x600']);
                
                mainImage.src = imageUrls[0];
                thumbContainer.innerHTML = '';
                if (imageUrls.length > 1) {
                    imageUrls.forEach((url, index) => {
                        thumbContainer.innerHTML += `<img src="${url}" class="w-20 h-20 object-contain rounded-md border-2 cursor-pointer ${index===0?'border-mudalali-green':'border-transparent'} flex-shrink-0" onclick="document.getElementById('main-product-image').src='${url}'">`;
                    });
                }

                document.getElementById('add-to-cart-btn').addEventListener('click', () => addToCart(currentProductData, 1));
                document.getElementById('buy-now-btn').addEventListener('click', async () => { await addToCart(currentProductData, 1); window.location.href = 'checkout.html'; });
                document.getElementById('wishlist-btn').addEventListener('click', toggleWishlist);

                if (currentProductData.sellerUid) loadSellerInfo(currentProductData.sellerUid);
                else { 
                    document.getElementById('seller-info-box').classList.add('hidden'); 
                    document.getElementById('product-delivery-details').innerHTML = '<p>Standard delivery.</p>'; 
                }

                const category = currentProductData.categories ? currentProductData.categories[0] : null;
                if (category) loadRelatedProducts(category, currentProductId);

                document.getElementById('product-loader').classList.add('hidden');
                document.getElementById('product-content').classList.remove('hidden');
                if(pageLoader) { pageLoader.style.width='100%'; setTimeout(()=>pageLoader.classList.add('hidden'), 500); }

            } catch (e) { console.error(e); showProductError("Error loading product details."); }
        }

        function formatPrice(product) {
            let price = parseFloat(product.price).toFixed(2);
            let originalPrice = product.originalPrice ? parseFloat(product.originalPrice).toFixed(2) : null;
            return `<span class="text-3xl font-bold text-mudalali-red">Rs. ${price}</span>${originalPrice ? `<span class="text-xl text-gray-400 line-through ml-2">Rs. ${originalPrice}</span>` : ''}`;
        }

        function showProductError(msg) {
            document.getElementById('product-loader').innerHTML = `<p class="text-center text-red-500 text-xl">${msg}</p>`;
            document.getElementById('product-content').classList.add('hidden');
        }

        async function loadSellerInfo(sellerUid) {
            try {
                const snap = await getDoc(doc(db, publicDataPath, 'stores', sellerUid));
                if (snap.exists()) {
                    const data = snap.data();
                    document.getElementById('seller-info-box').classList.remove('hidden');
                    document.getElementById('seller-logo').src = data.profileUrl || 'https://placehold.co/80x80';
                    document.getElementById('seller-name').textContent = data.storeName || 'Seller';
                    document.getElementById('seller-bio').textContent = data.description || '';
                    document.getElementById('seller-store-link').href = `store.html?id=${sellerUid}`;
                    document.getElementById('product-delivery-details').innerHTML = data.deliveryDetails ? data.deliveryDetails.replace(/\n/g, '<br>') : '<p>Contact seller for delivery details.</p>';
                }
            } catch(e) { console.error(e); }
        }

        async function loadRelatedProducts(cat, pid) {
            try {
                const snap = await getDocs(query(collection(db, publicDataPath, 'products'), where("categories", "array-contains", cat), limit(5)));
                const sidebar = document.getElementById('related-products-grid');
                const mobile = document.getElementById('related-products-grid-mobile');
                sidebar.innerHTML=''; mobile.innerHTML='';
                snap.forEach(doc => {
                    if(doc.id === pid) return;
                    const p = doc.data();
                    const html = `<a href="product.html?id=${doc.id}" class="group bg-white p-2 rounded shadow flex gap-3"><img src="${p.imageUrl}" class="w-16 h-16 object-cover"><div class="text-sm"><p class="font-bold line-clamp-1">${p.name}</p><p>Rs. ${p.price}</p></div></a>`;
                    sidebar.innerHTML+=html; mobile.innerHTML+=html;
                });
            } catch(e){}
        }

        // --- NEW: Customization Logic ---
        function setupCustomizationRequest(productId) {
            const modal = document.getElementById('custom-request-modal');
            const overlay = document.getElementById('custom-modal-overlay');
            const openBtn = document.getElementById('request-custom-btn');
            const closeBtn = document.getElementById('close-custom-modal-btn');
            const form = document.getElementById('custom-request-form');

            openBtn.addEventListener('click', () => {
                if (!currentUser) { document.getElementById('account-drawer-modal').classList.remove('hidden'); return; }
                modal.classList.remove('hidden');
            });

            const closeModal = () => modal.classList.add('hidden');
            overlay.addEventListener('click', closeModal);
            closeBtn.addEventListener('click', closeModal);

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = document.getElementById('custom-request-text').value;
                if(!text) return;
                
                // This assumes you have a 'customRequests' collection
                // Ideally, connect this to a Seller Dashboard notification system
                try {
                    await addDoc(collection(db, publicDataPath, 'customRequests'), {
                        productId: productId,
                        productName: currentProductData.name,
                        sellerUid: currentProductData.sellerUid,
                        buyerUid: currentUser.uid,
                        requestText: text,
                        status: 'pending',
                        createdAt: serverTimestamp()
                    });
                    alert("Request sent to seller!");
                    closeModal();
                    form.reset();
                } catch(err) {
                    console.error("Request failed", err);
                    alert("Failed to send request.");
                }
            });
        }

        // --- Auth & Cart Logic ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            const loggedInView = document.getElementById('account-drawer-logged-in');
            const loggedOutView = document.getElementById('account-drawer-logged-out');
            if (user) {
                loggedInView.classList.remove('hidden'); loggedInView.classList.add('flex');
                loggedOutView.classList.add('hidden'); loggedOutView.classList.remove('flex');
                document.getElementById('account-drawer-user-email').textContent = user.email;
                attachCartDrawerListener(user.uid);
                checkWishlistStatus(); attachWishlistBadgeListener(user.uid);
                document.getElementById('review-login-prompt').classList.add('hidden');
                document.getElementById('review-form').classList.remove('hidden');
            } else {
                loggedInView.classList.add('hidden'); loggedInView.classList.remove('flex');
                loggedOutView.classList.remove('hidden'); loggedOutView.classList.add('flex');
                attachCartDrawerListener(null); updateWishlistCountBadge(0);
                document.getElementById('review-login-prompt').classList.remove('hidden');
                document.getElementById('review-form').classList.add('hidden');
            }
        });

        const addToCart = async (product, quantity = 1) => {
            if (!currentUser) { document.getElementById('account-drawer-modal')?.classList.remove('hidden'); return; }
            const cartRef = doc(db, usersPath, currentUser.uid, 'cart', product.id);
            try {
                const snap = await getDoc(cartRef);
                if (snap.exists()) await updateDoc(cartRef, { quantity: increment(quantity) });
                else await setDoc(cartRef, { productId: product.id, name: product.name, price: product.price, imageUrl: product.imageUrl, quantity: quantity, addedAt: serverTimestamp() });
                document.getElementById('cart-drawer').classList.add('open');
            } catch (e) { console.error(e); }
        };

        async function toggleWishlist() {
             if (!currentUser) { document.getElementById('account-drawer-modal').classList.remove('hidden'); return; }
             const ref = doc(db, usersPath, currentUser.uid, 'wishlist', currentProductId);
             try {
                 const snap = await getDoc(ref);
                 if(snap.exists()) { await deleteDoc(ref); document.getElementById('wishlist-btn').classList.remove('liked'); }
                 else { await setDoc(ref, { productId: currentProductId, name: currentProductData.name, price: currentProductData.price, imageUrl: currentProductData.imageUrl, addedAt: serverTimestamp() }); document.getElementById('wishlist-btn').classList.add('liked'); }
             } catch(e){}
        }
        async function checkWishlistStatus() {
             if(!currentUser || !currentProductId) return;
             const snap = await getDoc(doc(db, usersPath, currentUser.uid, 'wishlist', currentProductId));
             if(snap.exists()) document.getElementById('wishlist-btn').classList.add('liked');
        }
        function attachWishlistBadgeListener(uid) {
            if(wishlistUnsubscribe) wishlistUnsubscribe();
            wishlistUnsubscribe = onSnapshot(collection(db, usersPath, uid, 'wishlist'), (s) => updateWishlistCountBadge(s.size));
        }
        function updateWishlistCountBadge(c) {
            document.getElementById('wishlist-count-badge').textContent = c;
            // Mobile badge removed from header in this clean version, check setupMobileDrawers for injection or ignore
        }

        function loadProductReviews(pid) {
            onSnapshot(query(collection(db, publicDataPath, 'productReviews'), where("productId","==",pid), orderBy("createdAt","asc")), (snap) => {
                const container = document.getElementById('reviews-list-container');
                container.innerHTML = snap.empty ? '<p>No reviews yet.</p>' : '';
                let total = 0;
                snap.forEach(doc => {
                    const r = doc.data(); total += r.rating;
                    container.innerHTML += `<div class="border-t pt-4"><b>User</b> <span class="text-xs">${r.createdAt?.toDate().toLocaleDateString()}</span><div class="text-mudalali-gold">${'★'.repeat(r.rating)}</div><p>${r.text}</p></div>`;
                });
                if(!snap.empty) {
                    const avg = total / snap.size;
                    document.querySelector('.display-stars-filled').style.width = `${avg * 20}%`;
                    document.getElementById('product-review-count').textContent = `(${snap.size} reviews)`;
                }
            });
        }

        function setupReviewForm(pid) {
            const stars = document.querySelectorAll('#rating-stars-input .star');
            stars.forEach(s => s.addEventListener('click', () => { userRating = s.dataset.value; stars.forEach(st => st.classList.toggle('selected', st.dataset.value <= userRating)); }));
            
            document.getElementById('review-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if(!currentUser || userRating===0) return;
                await addDoc(collection(db, publicDataPath, 'productReviews'), { productId: pid, userId: currentUser.uid, rating: userRating, text: document.getElementById('review-text').value, createdAt: serverTimestamp() });
                alert('Review submitted!'); e.target.reset();
            });
        }

        async function loadDesktopNavCategories() {
            onSnapshot(collection(db, publicDataPath, 'categories'), (snap) => {
                const cont = document.querySelector('.dropdown-menu'); 
                if(cont) {
                    cont.innerHTML='';
                    snap.forEach(doc => cont.innerHTML += `<a href="shop.html?category=${encodeURIComponent(doc.data().name)}" class="block px-4 py-2 hover:bg-gray-100">${doc.data().name}</a>`);
                }
            });
        }
        
        function setupMobileDrawers() {
             const menuDrawer = document.getElementById('menu-drawer');
             document.getElementById('mobile-menu-btn')?.addEventListener('click', ()=>menuDrawer.classList.add('open'));
             // Add overlay listeners... (Shortened for brevity, same as before)
             
             const cartDrawer = document.getElementById('cart-drawer');
             document.getElementById('desktop-cart-btn')?.addEventListener('click', ()=>cartDrawer.classList.add('open'));

             const authDrawer = document.getElementById('account-drawer-modal');
             const closeAuth = () => authDrawer.classList.add('hidden');
             document.getElementById('desktop-account-btn')?.addEventListener('click', (e)=>{ e.preventDefault(); authDrawer.classList.remove('hidden'); });
             document.getElementById('account-drawer-bg')?.addEventListener('click', closeAuth);
             document.getElementById('close-account-drawer-btn-logged-out')?.addEventListener('click', closeAuth);
             
             document.getElementById('drawer-login-form')?.addEventListener('submit', async(e)=>{
                 e.preventDefault();
                 try { await signInWithEmailAndPassword(auth, document.getElementById('drawer-login-email').value, document.getElementById('drawer-login-password').value); closeAuth(); } catch(e){ alert(e.message); }
             });
             document.getElementById('drawer-logout-btn')?.addEventListener('click', async()=>{ await signOut(auth); closeAuth(); });
        }
        
        function attachCartDrawerListener(uid) { 
            onSnapshot(collection(db, usersPath, uid, 'cart'), (snap) => {
                 updateCartCounters(snap.size);
                 const cont = document.getElementById('cart-drawer-items-container');
                 if(cont) {
                     cont.innerHTML = snap.empty ? '<p>Empty</p>' : '';
                     let total = 0;
                     snap.forEach(d => {
                         const i = d.data(); total += i.price * i.quantity;
                         cont.innerHTML += `<div class="flex justify-between p-2 border-b"><span>${i.name} x${i.quantity}</span><span>${i.price * i.quantity}</span></div>`;
                     });
                     document.getElementById('cart-drawer-total').textContent = `Rs. ${total}`;
                 }
            });
        }

    </script>
</body>
</html>