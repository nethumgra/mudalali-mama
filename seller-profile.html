<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller Dashboard - ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑è‡∂Ω‡∑í ‡∂∏‡∑è‡∂∏‡∑è</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: {
                        'mudalali-green': { light: '#76b852', DEFAULT: '#3a6a4a', dark: '#2c5234' },
                        'mudalali-bg': '#f5f5f4',
                        'mudalali-red': '#d93a3e',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        body { @apply font-sans text-gray-800 bg-mudalali-bg; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .sidebar-link { @apply flex items-center p-3 text-gray-600 font-medium rounded-lg hover:bg-gray-100 hover:text-mudalali-green transition-colors cursor-pointer; }
        .sidebar-link.active { @apply bg-mudalali-green text-white shadow-md; }
        .form-input { @apply mt-1 block w-full p-3 border rounded-md focus:ring-mudalali-green focus:border-mudalali-green; }
        .form-label { @apply block text-sm font-medium text-gray-700; }
        .btn-primary { @apply w-full bg-mudalali-green text-white p-3 rounded-md hover:bg-mudalali-green-dark font-bold text-lg transition-colors; }
        .btn-secondary { @apply w-full bg-gray-100 text-gray-700 p-3 rounded-md hover:bg-gray-200 font-bold transition-colors; }
        .modal-overlay { @apply fixed inset-0 bg-black bg-opacity-50 z-40 transition-opacity; }
        .modal-content { @apply relative bg-white rounded-lg shadow-xl p-6 w-full max-w-lg m-4 transform transition-all z-50; }
        .mobile-nav-link { @apply flex-1 flex flex-col items-center justify-center text-gray-600 hover:text-mudalali-green text-xs cursor-pointer; }
        .mobile-nav-link.active { @apply text-mudalali-green; }
        
        /* Animations */
        @keyframes gradient-x { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
        .ai-magic-btn {
            background: linear-gradient(270deg, #3a6a4a, #bda26b, #3a6a4a);
            background-size: 200% 200%;
            animation: gradient-x 3s ease infinite;
            @apply text-white text-xs font-bold px-3 py-1 rounded-full flex items-center gap-1 hover:opacity-90 transition-opacity cursor-pointer shadow-md;
        }
        .hyper-btn {
            background: linear-gradient(45deg, #6366f1, #a855f7, #ec4899);
            background-size: 200% 200%;
            animation: gradient-x 3s ease infinite;
            @apply w-full text-white font-bold py-3 px-4 rounded-lg shadow-lg flex items-center justify-center gap-2 transform transition hover:scale-105 hover:shadow-xl;
        }
        
        /* Voice Button Pulse */
        .recording { animation: pulse-red 1.5s infinite; @apply border-red-500 text-red-500 bg-red-50; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }

        /* --- SELLER OFFER BUBBLE STYLES --- */
        .seller-offer-bubble {
            @apply bg-white border-2 border-mudalali-green text-gray-800 p-4 rounded-2xl rounded-br-none shadow-sm mb-2 max-w-[85%] self-end text-right;
        }
        .seller-offer-price {
            @apply text-xl font-bold text-mudalali-green mt-1;
        }
    </style>
</head>
<body class="pb-20 md:pb-0"> 
    
    <div id="auth-loader" class="fixed inset-0 bg-mudalali-bg z-[10000] flex flex-col items-center justify-center">
        <i class="fa fa-spinner fa-spin text-4xl text-mudalali-green"></i>
        <p class="mt-4 text-gray-600 font-semibold">Authenticating...</p>
    </div>
    <div id="page-loader" class="fixed top-0 left-0 w-0 h-1 bg-mudalali-green z-[9999] transition-all duration-300 ease-linear"></div>
    
    <aside class="w-64 fixed top-0 left-0 h-full bg-white shadow-lg z-30 hidden md:flex flex-col">
        <div class="p-4 border-b">
            <a href="index.html" class="flex items-center gap-2">
                <img id="logo-img" src="https://i.ibb.co/1tCywvyP/logo.png" class="h-10" alt="Logo">
                <span class="text-xl font-bold text-mudalali-green-dark"></span>
            </a>
        </div>
        <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
            <a href="#products" id="nav-products" class="sidebar-link active"><i class="fa fa-box w-6"></i><span class="ml-3">My Products</span></a>
            <a href="#orders" id="nav-orders" class="sidebar-link"><i class="fa fa-receipt w-6"></i><span class="ml-3">My Orders</span></a>
            <a href="#messages" id="nav-messages" class="sidebar-link"><i class="fa fa-comments w-6"></i><span class="ml-3">Messages</span></a>
            <a href="#stories" id="nav-stories" class="sidebar-link"><i class="fa fa-book-open w-6"></i><span class="ml-3">My Stories</span></a>
            <a href="#settings" id="nav-settings" class="sidebar-link"><i class="fa fa-cog w-6"></i><span class="ml-3">Store Settings</span></a>
        </nav>
        <div class="p-4 border-t">
            <a href="#" id="view-public-store-link" target="_blank" class="block text-center w-full bg-mudalali-green-light text-mudalali-green-dark p-2 rounded-md hover:bg-mudalali-green hover:text-white font-semibold text-sm mb-2"><i class="fa fa-store mr-1"></i> View My Store</a>
            <button id="drawer-logout-btn" class="w-full text-left text-gray-600 p-3 rounded-lg hover:bg-gray-100 font-medium text-sm transition flex items-center"><i class="fa fa-sign-out-alt w-6"></i> <span class="ml-3">Logout</span></button>
        </div>
    </aside>

    <header class="bg-white shadow-md sticky top-0 z-40 flex md:hidden items-center justify-between p-4">
        <button id="dashboard-menu-btn" class="text-2xl text-gray-700"><i class="fa fa-bars"></i></button>
        <h1 class="text-lg font-bold text-mudalali-green-dark" id="mobile-page-title">My Products</h1>
        <a href="account.html" id="mobile-account-btn" class="text-2xl text-gray-700"><i class="fa fa-user"></i></a>
    </header>

    <main class="md:ml-64 py-8 px-4 md:px-10">
        
        <div id="view-products" class="dashboard-view">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">My Products</h1>
                <button id="open-product-modal-btn" class="bg-mudalali-green text-white px-5 py-2 rounded-lg font-semibold hover:bg-mudalali-green-dark shadow-lg transition transform hover:scale-105 flex items-center">
                    <i class="fa fa-plus mr-2"></i> Add Product
                </button>
            </div>
           <div id="product-list-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 md:gap-4">
                <div class="col-span-full text-center py-10"><i class="fa fa-spinner fa-spin text-3xl text-mudalali-green"></i><p class="mt-2 text-gray-500">Loading products...</p></div>
            </div>
        </div>

        <div id="view-orders" class="dashboard-view hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">My Orders</h1>
            <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-100">
                <div id="order-list-container" class="divide-y divide-gray-200">
                    <div class="p-10 text-center text-gray-500"><i class="fa fa-spinner fa-spin text-3xl text-mudalali-green"></i><p class="mt-2">Loading your orders...</p></div>
                </div>
            </div>
        </div>

        <div id="view-messages" class="dashboard-view hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Customer Messages</h1>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-180px)]">
                
                <div class="lg:col-span-1 bg-white rounded-lg shadow-md border border-gray-100 flex flex-col overflow-hidden">
                    <div class="p-4 border-b bg-gray-50">
                        <h2 class="font-bold text-gray-700">Inbox</h2>
                    </div>
                    <div id="chat-list-container" class="flex-grow overflow-y-auto p-2 space-y-2">
                        <p class="text-center text-gray-500 mt-10"><i class="fa fa-spinner fa-spin"></i> Loading...</p>
                    </div>
                </div>

                <div class="hidden lg:flex lg:col-span-2 bg-white rounded-lg shadow-md border border-gray-100 flex-col overflow-hidden relative bg-[url('https://www.transparenttextures.com/patterns/subtle-white-feathers.png')]">
                    
                    <div id="chat-empty-state" class="absolute inset-0 flex flex-col items-center justify-center bg-white z-10">
                        <img src="https://cdn-icons-png.flaticon.com/512/1041/1041916.png" class="w-24 opacity-50 mb-4">
                        <p class="text-gray-400 font-medium">Select a conversation to start chatting</p>
                    </div>

                    <div id="chat-interface" class="flex flex-col h-full hidden">
                        <div class="p-3 border-b bg-white shadow-sm flex justify-between items-center z-20">
                            <div class="flex items-center gap-3">
                                <img id="chat-product-img" src="" class="w-10 h-10 rounded object-cover border">
                                <div>
                                    <h3 id="chat-buyer-name" class="font-bold text-sm text-gray-800">Buyer Name</h3>
                                    <p id="chat-product-name" class="text-xs text-gray-500">Product Name</p>
                                </div>
                            </div>
                            <div class="flex gap-2" id="chat-action-buttons">
                                <button onclick="updateChatStatus('approved')" class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold hover:bg-green-200 transition"><i class="fa fa-check mr-1"></i> Approve</button>
                                <button onclick="updateChatStatus('rejected')" class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-bold hover:bg-red-200 transition"><i class="fa fa-times mr-1"></i> Reject</button>
                            </div>
                            <div id="chat-status-display" class="hidden px-3 py-1 rounded-full text-xs font-bold"></div>
                        </div>

                        <div id="chat-messages-area" class="flex-grow overflow-y-auto p-4 space-y-3 bg-gray-50/50"></div>

                        <div class="p-3 bg-white border-t">
                            <div class="flex gap-2">
                                <button type="button" onclick="toggleOfferModal()" class="bg-yellow-100 text-yellow-700 px-3 rounded-lg hover:bg-yellow-200 font-bold text-xs flex flex-col items-center justify-center" title="Create Offer">
                                    <i class="fa fa-tag text-sm"></i>
                                    <span>Offer</span>
                                </button>
                                <form id="seller-chat-form" class="flex-grow flex gap-2">
                                    <input type="text" id="seller-chat-input" class="flex-grow form-input !mt-0 !py-2" placeholder="Type your reply..." required>
                                    <button type="submit" class="bg-mudalali-green text-white px-4 rounded-lg hover:bg-mudalali-green-dark transition"><i class="fa fa-paper-plane"></i></button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-stories" class="dashboard-view hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">My Stories</h1>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="lg:col-span-1">
                    <form id="create-story-form" class="bg-white p-6 rounded-lg shadow-md space-y-4 border border-gray-100">
                        <h2 class="text-xl font-bold text-gray-800">Create New Story</h2>
                        <div><label class="form-label">Story Content</label><textarea id="story-content" class="form-input" rows="4" placeholder="What's happening?" required></textarea></div>
                        <div><label class="form-label">Story Image</label><input type="file" id="story-image-file" class="form-input" accept="image/*"></div>
                        <div id="story-image-preview-container" class="hidden relative w-full h-48 overflow-hidden rounded-md bg-gray-100 border">
                            <img id="story-image-preview" src="" class="w-full h-full object-contain">
                            <button type="button" id="remove-story-image-btn" class="absolute top-2 right-2 bg-red-500 text-white w-8 h-8 rounded-full"><i class="fa fa-times"></i></button>
                        </div>
                        <button id="submit-story-btn" type="submit" class="btn-primary">Post Story</button>
                        <p id="story-upload-status" class="text-sm text-gray-600 mt-2 text-center"></p>
                    </form>
                </div>
               <div class="lg:col-span-1">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Published Stories</h2>
                    <div id="story-list-container" class="space-y-4"><p class="text-gray-500">Loading...</p></div>
                </div>
            </div>
        </div>

        <div id="view-settings" class="dashboard-view hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Store Settings</h1>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <form id="settings-form" class="lg:col-span-2 bg-white p-6 md:p-8 rounded-lg shadow-md space-y-6 border border-gray-100">
                    <div><label class="form-label">Store Name</label><input type="text" id="settings-store-name" class="form-input"></div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="form-label">Store Description</label>
                            <button type="button" onclick="generateStoreDesc()" class="ai-magic-btn !py-0.5 !px-2 !text-[10px]"><i class="fa-solid fa-wand-magic-sparkles"></i> AI Write</button>
                        </div>
                        <textarea id="settings-description" rows="4" class="form-input" placeholder="Tell customers about your shop..."></textarea>
                        <p id="store-ai-loading" class="text-xs text-mudalali-green font-bold hidden mt-1 animate-pulse"><i class="fa fa-spinner fa-spin"></i> Analyzing...</p>
                    </div>
                    <div><label class="form-label">Location</label><input type="text" id="settings-location" class="form-input"></div>
                    <div><label class="form-label">Delivery Charge (LKR)</label><input type="number" id="settings-shipping-fee" class="form-input"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="form-label">Store Banner</label><input type="file" id="settings-banner-file" class="form-input" accept="image/*"></div>
                        <div><label class="form-label">Profile Picture</label><input type="file" id="settings-profile-file" class="form-input" accept="image/*"></div>
                    </div>
                    <button type="submit" id="save-settings-btn" class="btn-primary !text-base !py-2.5">Save Settings</button>
                    <p id="settings-save-status" class="text-sm text-center font-semibold mt-2"></p>
                </form>
                
                <div class="lg:col-span-1 hidden lg:block">
                    <h3 class="text-lg font-bold text-gray-700 mb-3">Store Preview</h3>
                    <div class="bg-white rounded-lg shadow-lg overflow-hidden sticky top-24 border border-gray-100">
                        <div class="h-32 bg-gray-200 flex items-center justify-center relative bg-cover bg-center" id="preview-banner-bg">
                            <img id="preview-banner-img" src="" class="w-full h-full object-cover hidden">
                            <span id="preview-banner-placeholder" class="text-gray-400">Banner Preview</span>
                        </div>
                        <div class="p-4 relative">
                            <div class="absolute -top-12 left-4 w-24 h-24 rounded-full border-4 border-white bg-gray-300 overflow-hidden flex items-center justify-center shadow-md">
                                <img id="preview-profile-img" src="" class="w-full h-full object-cover hidden">
                                <span id="preview-profile-placeholder" class="text-gray-500 text-3xl"><i class="fa fa-store"></i></span>
                            </div>
                            <h3 id="preview-store-name" class="text-xl font-bold text-gray-800 mt-10 truncate">Store Name</h3>
                            <p id="preview-location" class="text-sm text-gray-500 mt-1"><i class="fa fa-map-marker-alt mr-1"></i>Location</p>
                            <p id="preview-description" class="text-sm text-gray-600 mt-3 h-20 overflow-y-auto no-scrollbar leading-relaxed">Description will appear here...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="mobile-chat-modal" class="fixed inset-0 z-[70] bg-white hidden flex flex-col lg:hidden">
        <div class="p-3 border-b bg-white shadow-sm flex items-center gap-3">
            <button onclick="closeMobileChat()" class="text-gray-600"><i class="fa fa-arrow-left text-xl"></i></button>
            <div class="flex-grow">
                <h3 id="mobile-chat-buyer" class="font-bold text-gray-800">Buyer</h3>
                <p id="mobile-chat-product" class="text-xs text-gray-500">Product</p>
            </div>
            <div id="mobile-status-badge" class="text-[10px] font-bold px-2 py-1 rounded bg-gray-200">Pending</div>
        </div>
        
        <div id="mobile-chat-actions" class="p-2 bg-gray-50 border-b flex justify-center gap-4">
            <button onclick="updateChatStatus('approved')" class="text-green-600 text-xs font-bold bg-white border border-green-200 px-4 py-1 rounded-full shadow-sm">Approve</button>
            <button onclick="updateChatStatus('rejected')" class="text-red-600 text-xs font-bold bg-white border border-red-200 px-4 py-1 rounded-full shadow-sm">Reject</button>
        </div>

        <div id="mobile-messages-area" class="flex-grow overflow-y-auto p-4 space-y-3 bg-gray-100"></div>

        <div class="p-3 bg-white border-t pb-20 md:pb-3">
            <div class="flex gap-2">
                <button type="button" onclick="toggleOfferModal()" class="bg-yellow-100 text-yellow-700 w-10 h-10 rounded-full flex items-center justify-center hover:bg-yellow-200 shadow-sm">
                    <i class="fa fa-tag"></i>
                </button>
                <form id="mobile-chat-form" class="flex-grow flex gap-2">
                    <input type="text" id="mobile-chat-input" class="flex-grow border rounded-full px-4 py-2 focus:outline-none focus:border-mudalali-green" placeholder="Reply..." required>
                    <button type="submit" class="bg-mudalali-green text-white w-10 h-10 rounded-full flex items-center justify-center"><i class="fa fa-paper-plane"></i></button>
                </form>
            </div>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 h-16 bg-white border-t border-gray-200 shadow-lg flex justify-around items-center z-40 md:hidden">
        <a href="index.html" class="mobile-nav-link"><i class="fa fa-home text-xl"></i><span class="mt-1">Home</span></a>
        <a href="#" id="mobile-public-store-link" class="mobile-nav-link"><i class="fa fa-store text-xl"></i><span class="mt-1">My Store</span></a>
        <button id="nav-btn-add" class="text-white relative"><div class="w-14 h-14 rounded-full bg-mudalali-green flex items-center justify-center -mt-8 shadow-xl border-4 border-white transition hover:scale-110"><i class="fa fa-plus text-2xl"></i></div></button>
        <button id="nav-btn-messages" class="mobile-nav-link" data-hash="#messages"><i class="fa fa-comments text-xl"></i><span class="mt-1">Chat</span></button>
        <button id="nav-btn-dashboard" class="mobile-nav-link active" data-hash="#products"><i class="fa fa-user-circle text-xl"></i><span class="mt-1">Dashboard</span></button>
    </nav>

    <button id="global-voice-btn" onclick="toggleGlobalVoice()" class="fixed bottom-20 right-4 md:bottom-8 md:right-8 bg-black text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center z-[60] transition transform hover:scale-110 hover:bg-gray-800 border-2 border-mudalali-green">
        <i class="fa fa-microphone text-2xl"></i>
    </button>
    <div id="voice-listening-indicator" class="hidden fixed bottom-36 right-4 md:bottom-24 md:right-8 bg-white p-3 rounded-lg shadow-xl z-[60] border border-gray-200 animate-bounce">
        <p class="text-sm font-bold text-mudalali-green flex items-center gap-2"><span class="w-2 h-2 bg-red-500 rounded-full animate-ping"></span> Listening...</p>
        <p class="text-[10px] text-gray-500">Say: "Orders", "Messages", "Add New"</p>
    </div>

    <div id="product-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="modal-overlay absolute inset-0 backdrop-blur-sm bg-black/30"></div>
        <div class="modal-content relative max-h-[90vh] overflow-y-auto no-scrollbar w-full max-w-lg rounded-xl bg-white shadow-2xl border border-gray-200">
            
            <h2 id="product-modal-title" class="text-2xl font-bold text-gray-800 mb-4">Add New Product</h2>

            <div class="mb-4">
                <label class="form-label mb-1">Product Image</label>
                <input type="file" id="product-image-files" class="form-input" accept="image/*" multiple>
                <div id="product-image-preview-container" class="mt-2 flex flex-wrap gap-2"></div>
            </div>

            <div class="bg-purple-50 p-3 rounded-lg border border-purple-100 mb-4">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-xs font-bold text-purple-700 block"><i class="fa fa-wand-magic-sparkles mr-1"></i> Magic Voice Input</label>
                    <span class="text-[10px] bg-purple-200 text-purple-800 px-2 py-0.5 rounded-full">Sinhala Supported üá±üá∞</span>
                </div>
                
                <div class="relative">
                    <textarea id="magic-input-text" class="form-input !mt-0 !text-sm !pr-12 resize-none" rows="3" placeholder="Ex: Red frock, Rs. 1500, Customize puluwan..."></textarea>
                    <button type="button" onclick="startProductVoiceInput()" id="product-mic-btn" class="absolute right-2 bottom-2 bg-white border border-purple-300 text-purple-600 rounded-md w-9 h-9 flex items-center justify-center hover:bg-purple-600 hover:text-white transition shadow-sm z-10">
                        <i class="fa fa-microphone"></i>
                    </button>
                </div>

                <button type="button" onclick="hyperAutoFill()" id="hyper-btn" class="hyper-btn mt-2 !py-2 !text-sm">Fill Data Automatically</button>
                <p id="hyper-loading" class="text-xs text-purple-600 font-bold hidden mt-1 text-center animate-pulse"><i class="fa fa-spinner fa-spin"></i> AI Reading: Voice + Image...</p>
            </div>

            <form id="product-form" class="space-y-4 border-t pt-4">
                <input type="hidden" id="product-id">
                <div><label class="form-label">Product Name</label><input type="text" id="product-name" class="form-input" required></div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div><label class="form-label">Sale Price (LKR)</label><input type="number" id="product-sale-price" class="form-input" required></div>
                    <div><label class="form-label">Original Price</label><input type="number" id="product-original-price" class="form-input"></div>
                    
                    <div>
                        <label class="form-label text-red-600 font-bold text-xs md:text-sm">Minimum Price (AI)</label>
                        <input type="number" id="product-min-price" class="form-input border-red-300 text-red-700 focus:ring-red-500 focus:border-red-500 bg-red-50" placeholder="Lowest Allowable">
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-1"><label class="form-label mb-0">Category</label><button type="button" onclick="autoSelectCategory()" class="text-xs text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded">Auto Select</button></div>
                    <select id="product-category-select" class="form-input"><option value="">Loading Categories...</option></select>
                    <p id="cat-ai-loading" class="hidden text-xs text-blue-600 text-right">Matching...</p>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-1"><label class="form-label">Description</label><button type="button" onclick="generateAIDescription()" id="generate-desc-btn" class="ai-magic-btn">Improve Text</button></div>
                    <textarea id="product-description" rows="3" class="form-input"></textarea>
                    <p id="ai-loading-status" class="hidden text-xs text-mudalali-green">Writing...</p>
                </div>
                <div class="flex items-center p-3 bg-blue-50 rounded-md border border-blue-100">
                    <input type="checkbox" id="product-customization-check" class="h-5 w-5 text-mudalali-green border-gray-300 rounded">
                    <div class="ml-3"><label for="product-customization-check" class="text-sm font-bold text-gray-800">Enable Customization?</label><p class="text-xs text-gray-500">Allow color/size requests.</p></div>
                </div>
                <div class="p-4 border-t bg-gray-50 rounded-md border border-gray-100">
                    <label class="form-label">Variations</label>
                    <div id="product-variations-container" class="space-y-3 mb-2"></div>
                    <button type="button" id="add-variation-btn" class="w-full bg-white border border-mudalali-green text-mudalali-green p-2 rounded-md hover:bg-mudalali-green hover:text-white text-sm font-semibold">Add Variation</button>
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="button" id="close-product-modal-btn" class="btn-secondary">Cancel</button>
                    <button type="submit" id="save-product-btn" class="btn-primary">Save Product</button>
                </div>
                <p id="product-save-status" class="text-sm text-center font-semibold mt-2 text-mudalali-green"></p>
            </form>
        </div>
    </div>

    <div id="variation-image-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4">
        <div class="modal-overlay absolute inset-0 backdrop-blur-sm bg-black/50" onclick="closeVariationMagicModal()"></div>
        <div class="modal-content relative w-full max-w-md bg-white rounded-xl shadow-2xl border border-purple-100 p-0 overflow-hidden">
            <div class="bg-gradient-to-r from-purple-600 to-blue-500 p-4">
                <h3 class="text-white font-bold text-lg"><i class="fa fa-wand-magic-sparkles mr-2"></i>AI Image Generator</h3>
            </div>
            <div class="p-6">
                <div class="w-full h-64 bg-gray-100 rounded-lg mb-4 overflow-hidden flex items-center justify-center relative border border-gray-200">
                    <img id="gen-image-preview" class="w-full h-full object-contain hidden">
                    <div id="gen-loader" class="absolute inset-0 flex flex-col items-center justify-center bg-white/90 hidden z-10">
                        <i class="fa fa-spinner fa-spin text-4xl text-purple-600"></i>
                        <p class="text-sm font-bold text-purple-600 mt-2 animate-pulse">Creating Magic...</p>
                    </div>
                    <div id="gen-placeholder" class="text-center p-4">
                        <i class="fa fa-image text-4xl text-gray-300 mb-2"></i>
                        <p class="text-sm text-gray-400">Preview will appear here</p>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Prompt</label>
                    <div class="flex gap-2">
                        <input type="text" id="gen-prompt-input" class="form-input !py-2 !text-sm" placeholder="e.g. Dark Red Dress">
                        <button onclick="generateVariationImage()" class="bg-purple-600 text-white px-4 rounded-md hover:bg-purple-700 transition"><i class="fa fa-sync-alt"></i></button>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="closeVariationMagicModal()" class="btn-secondary">Cancel</button>
                    <button onclick="saveVariationImage()" id="gen-save-btn" class="btn-primary bg-purple-600 hover:bg-purple-700 disabled:opacity-50" disabled>Use Image</button>
                </div>
            </div>
        </div>
    </div>

    <div id="add-new-modal" class="hidden fixed inset-0 z-50 flex items-end justify-center p-4">
        <div class="modal-overlay absolute inset-0 bg-black/40"></div>
        <div class="modal-content relative w-full max-w-sm rounded-xl mb-16">
            <h2 class="text-xl font-bold text-gray-800 text-center mb-4">Create New...</h2>
            <div class="flex flex-col gap-3">
                <button id="add-modal-product-btn" class="w-full text-center bg-mudalali-green text-white p-3 rounded-lg hover:bg-mudalali-green-dark font-bold shadow"><i class="fa fa-box mr-2"></i> Add New Product</button>
                <button id="add-modal-story-btn" class="w-full text-center bg-mudalali-green text-white p-3 rounded-lg hover:bg-mudalali-green-dark font-bold shadow"><i class="fa fa-book-open mr-2"></i> Write New Story</button>
                <button id="add-modal-cancel-btn" class="w-full text-center bg-gray-100 text-gray-700 p-2 rounded-lg hover:bg-gray-200 font-bold mt-2">Cancel</button>
            </div>
        </div>
    </div>

    <div id="dashboard-drawer" class="drawer">
        <div class="drawer-overlay" id="dashboard-drawer-overlay"></div>
        <aside class="drawer-content left w-64 flex flex-col">
            <div class="p-4 border-b"><a href="index.html" class="flex items-center gap-2"><img id="mobile-logo-img" class="h-10" alt="Logo"><span class="text-xl font-bold text-mudalali-green-dark">Dashboard</span></a></div>
            <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
                <a href="#products" id="mobile-nav-products" class="sidebar-link active"><i class="fa fa-box w-6"></i><span class="ml-3">My Products</span></a>
                <a href="#orders" id="mobile-nav-orders" class="sidebar-link"><i class="fa fa-receipt w-6"></i><span class="ml-3">My Orders</span></a>
                <a href="#messages" id="mobile-nav-messages" class="sidebar-link"><i class="fa fa-comments w-6"></i><span class="ml-3">Messages</span></a>
                <a href="#stories" id="mobile-nav-stories" class="sidebar-link"><i class="fa fa-book-open w-6"></i><span class="ml-3">My Stories</span></a>
                <a href="#settings" id="mobile-nav-settings" class="sidebar-link"><i class="fa fa-cog w-6"></i><span class="ml-3">Store Settings</span></a>
            </nav>
            <div class="p-4 border-t"><button id="mobile-drawer-logout-btn" class="w-full text-left text-gray-600 p-3 rounded-lg hover:bg-gray-100 font-medium text-sm mt-2 flex items-center"><i class="fa fa-sign-out-alt w-6"></i><span class="ml-3">Logout</span></button></div>
        </aside>
    </div>

    <div id="create-offer-modal" class="hidden fixed inset-0 z-[80] flex items-center justify-center p-4">
        <div class="modal-overlay absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="toggleOfferModal()"></div>
        <div class="modal-content relative bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm z-10">
            <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fa fa-tag mr-2 text-mudalali-green"></i>Send Custom Offer</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Final Price (LKR)</label>
                    <input type="number" id="offer-price-input" class="form-input text-xl font-bold text-center" placeholder="0.00">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Note to Customer</label>
                    <textarea id="offer-note-input" class="form-input" rows="2" placeholder="e.g. Price including customization..."></textarea>
                </div>
                
                <button onclick="sendCustomOffer()" class="w-full bg-mudalali-green text-white py-3 rounded-lg font-bold hover:bg-mudalali-green-dark shadow-lg transition transform hover:scale-105">
                    Send Offer
                </button>
                <button onclick="toggleOfferModal()" class="w-full text-gray-500 py-2 text-sm hover:text-gray-700">Cancel</button>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, 
        onAuthStateChanged, 
        signOut 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        getDoc, 
        getDocs,
        collection, 
        onSnapshot,
        query,
        where,
        orderBy,
        limit,
        setDoc,
        addDoc,
        updateDoc, 
        deleteDoc, 
        increment, 
        serverTimestamp,
        runTransaction,
        arrayUnion // Make sure this is imported
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Firebase Config (Standard for this project) ---
    const firebaseConfig = {
        apiKey: "AIzaSyDIbu2qT53iGPqMCx5UdU6XY8wvXkb3ZF4",
        authDomain: "mudalali-mama.firebaseapp.com",
        projectId: "mudalali-mama",
        storageBucket: "mudalali-mama.firebasestorage.app",
        messagingSenderId: "296597428969",
        appId: "1:296597428969:web:684668be9c0eaeecb4ae78",
        measurementId: "G-GC1CP1LRFD"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app); 
    
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const publicDataPath = `/artifacts/${appId}/public/data`;
    const usersPath = `/users`; 

    const imgbbApiKey = 'f068295c19803c448665a0ea48bcc2fc';
    
    let GEMINI_API_KEY = ""; 

    // --- SMART MODEL LIST ---
    const GEMINI_MODELS = [
        "gemini-2.0-flash",        
        "gemini-2.0-flash-lite", 
        "gemini-1.5-flash",        
        "gemini-1.5-pro"          
    ];

    let currentUser = null;
    let currentUserData = null;
    let currentStoreData = {};
    let activeChatId = null;
    let chatUnsubscribe = null;

    onAuthStateChanged(auth, async (user) => {
        const authLoader = document.getElementById('auth-loader');
        if (user) {
            currentUser = user;
            try {
                const userDocRef = doc(db, usersPath, user.uid);
                const userDocSnap = await getDoc(userDocRef);
                if (!userDocSnap.exists() || !userDocSnap.data().isSeller) { alert("Access Denied."); window.location.href = 'index.html'; return; }
                currentUserData = userDocSnap.data();
                
                await loadSystemApiKey(); 
                
                initializeDashboard();
            } catch (e) { console.error(e); alert("Auth Error"); } finally { if(authLoader) authLoader.classList.add('hidden'); }
        } else { window.location.href = 'account.html'; }
    });

    async function loadSystemApiKey() {
        try {
            const docRef = doc(db, 'config', 'ai_keys');
            const snap = await getDoc(docRef);
            
            if (snap.exists() && snap.data().geminiKey) {
                GEMINI_API_KEY = snap.data().geminiKey;
                console.log("‚úÖ AI System Ready (Key Loaded)");
            } else {
                console.warn("‚ö†Ô∏è System API Key not found. AI features will not work.");
            }
        } catch (e) {
            console.error("Error loading System Key:", e);
        }
    }

    function initializeDashboard() {
        loadSellerData(); loadMyProducts(); loadMyOrders(); loadMyStories(); loadCategoriesIntoModal();
        loadSellerMessages(); // Load Messages
        setupDashboardNavigation(); setupProductModal(); setupStoryForm(); setupSettingsForm(); setupLogoutButtons();
        const storeLinkMobile = document.getElementById('mobile-public-store-link');
        const storeLinkDesk = document.getElementById('view-public-store-link');
        if(storeLinkMobile) storeLinkMobile.href = `store.html?id=${currentUser.uid}`;
        if(storeLinkDesk) storeLinkDesk.href = `store.html?id=${currentUser.uid}`;
        const pageLoader = document.getElementById('page-loader');
        if(pageLoader) { pageLoader.style.width = '100%'; setTimeout(() => pageLoader.style.display = 'none', 500); }
    }

    // --- GLOBAL VOICE ---
    let recognition;
    window.toggleGlobalVoice = () => {
        if (!('webkitSpeechRecognition' in window)) { alert("Browser not supported"); return; }
        if (!recognition) {
            recognition = new webkitSpeechRecognition(); recognition.lang = 'en-US'; recognition.continuous = false;
            recognition.onresult = (e) => { executeCommand(e.results[0][0].transcript.toLowerCase()); resetVoiceBtn(); };
            recognition.onerror = resetVoiceBtn; recognition.onend = resetVoiceBtn;
        }
        const btn = document.getElementById('global-voice-btn');
        if (btn.classList.contains('recording')) { recognition.stop(); } 
        else { recognition.start(); btn.classList.add('recording', 'bg-red-600'); btn.classList.remove('bg-black'); document.getElementById('voice-listening-indicator').classList.remove('hidden'); }
    };
    function resetVoiceBtn() { document.getElementById('global-voice-btn').classList.remove('recording', 'bg-red-600'); document.getElementById('global-voice-btn').classList.add('bg-black'); document.getElementById('voice-listening-indicator').classList.add('hidden'); }
    function executeCommand(cmd) {
        const views = { 
            'product': '#products', 'products': '#products', 
            'order': '#orders', 'orders': '#orders', 
            'story': '#stories', 
            'setting': '#settings',
            'message': '#messages', 'chat': '#messages' 
        };
        for (let key in views) { if (cmd.includes(key)) { document.querySelector(`[href="${views[key]}"]`).click(); return; } }
        if (cmd.includes('add') || cmd.includes('new')) document.getElementById('nav-btn-add').click();
        else if (cmd.includes('logout')) signOut(auth);
    }

    // --- PRODUCT VOICE ---
    let productRecognition; 
    window.startProductVoiceInput = () => {
        if (!('webkitSpeechRecognition' in window)) { alert("Browser not supported"); return; }
        const btn = document.getElementById('product-mic-btn');
        const input = document.getElementById('magic-input-text');
        if(productRecognition && btn.classList.contains('text-red-500')) { productRecognition.stop(); return; }
        productRecognition = new webkitSpeechRecognition();
        productRecognition.lang = 'si-LK'; productRecognition.continuous = true; productRecognition.interimResults = true;
        btn.innerHTML = '<i class="fa fa-stop animate-pulse"></i>'; btn.classList.add('text-red-500', 'border-red-300');
        productRecognition.onresult = (event) => {
            let finalTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) { if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript; }
            if (finalTranscript) input.value = input.value.trim() + (input.value.trim() ? " " : "") + finalTranscript;
        };
        productRecognition.onerror = () => { btn.innerHTML = '<i class="fa fa-microphone"></i>'; btn.classList.remove('text-red-500', 'border-red-300'); };
        productRecognition.onend = () => { btn.innerHTML = '<i class="fa fa-microphone"></i>'; btn.classList.remove('text-red-500', 'border-red-300'); };
        productRecognition.start();
    };

    // --- AUTO FILL ---
    window.hyperAutoFill = async () => {
        if(!GEMINI_API_KEY) { alert("System Error: Admin has not configured AI Key yet."); return; }

        const fileInput = document.getElementById('product-image-files');
        const extraText = document.getElementById('magic-input-text').value;
        const catSelect = document.getElementById('product-category-select');
        const loader = document.getElementById('hyper-loading');
        const btn = document.getElementById('hyper-btn');
        if (!fileInput.files.length) { alert("Select image first!"); return; }
        btn.disabled = true; btn.classList.add('opacity-50'); loader.classList.remove('hidden');
        try {
            const categories = Array.from(catSelect.options).map(o => o.value).filter(v => v).join(", ");
            const base64 = await fileToGenerativePart(fileInput.files[0]);
            const prompt = `Analyze product image & text: "${extraText}". Task: 1. Name (English). 2. Description (Persuasive). 3. Category (Context: ${categories}). 4. Price (Number). 5. Variations (Sizes/Colors). 6. Custom check (isCustom). Output JSON: {"name":"", "description":"", "category":"", "price":0, "isCustom":false, "variations":[{"name":"", "price":0}]}`;
            const text = await callGeminiAPI(null, prompt, base64);
            if (text) {
                const res = JSON.parse(text.replace(/```json|```/g, '').trim());
                typeWriter(document.getElementById('product-name'), res.name);
                typeWriter(document.getElementById('product-description'), res.description);
                if(res.price > 0) { document.getElementById('product-sale-price').value = res.price; document.getElementById('product-original-price').value = Math.ceil((res.price * 1.25) / 50) * 50; }
                let found = false; for (let i = 0; i < catSelect.options.length; i++) { if (catSelect.options[i].value.toLowerCase() === res.category.toLowerCase()) { catSelect.selectedIndex = i; found = true; break; } }
                if (!found) { const opt = document.createElement('option'); opt.value = res.category; opt.text = res.category + " (AI New)"; opt.selected = true; catSelect.add(opt); }
                document.getElementById('product-customization-check').checked = res.isCustom;
                document.getElementById('product-variations-container').innerHTML = '';
                if(res.variations) res.variations.forEach(v => addVariationRow({name: v.name, price: res.price}));
            }
        } catch (e) { console.error(e); alert("AI Error: " + e.message); } 
        finally { loader.classList.add('hidden'); btn.disabled = false; btn.classList.remove('opacity-50'); }
    };

    window.generateAIDescription = async () => {
        if(!GEMINI_API_KEY) { alert("System Error: Admin has not configured AI Key."); return; }
        const name = document.getElementById('product-name').value;
        if(!name) { alert("Enter Name"); return; }
        const loader = document.getElementById('ai-loading-status'); loader.classList.remove('hidden');
        try { const txt = await callGeminiAPI(null, `Write short persuasive description for: ${name}`); if(txt) typeWriter(document.getElementById('product-description'), txt); } catch(e){} finally { loader.classList.add('hidden'); }
    };
    window.generateStoreDesc = async () => {
        if(!GEMINI_API_KEY) { alert("System Error: Admin has not configured AI Key."); return; }
        const name = document.getElementById('settings-store-name').value;
        const load = document.getElementById('store-ai-loading');
        if(!name) { alert("Enter Store Name"); return; }
        load.classList.remove('hidden');
        try { const txt = await callGeminiAPI(null, `Write warm welcome note for Sri Lankan shop: ${name}`); if(txt) typeWriter(document.getElementById('settings-description'), txt); } catch(e){} finally { load.classList.add('hidden'); }
    };
    window.autoSelectCategory = async () => { 
        if(!GEMINI_API_KEY) { alert("System Error: Admin has not configured AI Key."); return; }
        const name = document.getElementById('product-name').value; const select = document.getElementById('product-category-select'); const loader = document.getElementById('cat-ai-loading');
        if (!name) { alert("Enter name first!"); return; }
        loader.classList.remove('hidden');
        const options = Array.from(select.options).map(o => o.value).filter(v => v);
        try {
            const text = await callGeminiAPI(null, `Product: "${name}". Pick BEST category from: ${options.join(", ")}. OR suggest a new simple category name. Output ONLY the category name.`);
            if(text) {
                const bestCat = text.trim(); let found = false;
                for (let i = 0; i < select.options.length; i++) { if (select.options[i].value.toLowerCase() === bestCat.toLowerCase()) { select.selectedIndex = i; found = true; break; } }
                if(!found) { const newOpt = document.createElement('option'); newOpt.value = bestCat; newOpt.text = bestCat + " (New)"; newOpt.selected = true; select.add(newOpt); }
            }
        } catch(e) {} finally { loader.classList.add('hidden'); }
    };

    // --- VARIATION LOGIC & IMAGE GEN ---
    let activeVariationRow = null;

    window.addVariationRow = (d={}) => {
        const div = document.createElement('div'); div.className = 'variation-row flex flex-col gap-2 bg-gray-50 p-3 rounded-lg border border-gray-200 mb-2';
        div.innerHTML = `
            <div class="flex gap-2 items-center">
                <input class="v-name form-input flex-grow !py-1 !text-sm" placeholder="Name (e.g. Red)" value="${d.name||''}">
                <input class="v-price form-input w-20 !py-1 !text-sm" type="number" placeholder="Price" value="${d.price||''}">
                <button type="button" onclick="this.closest('.variation-row').remove()" class="text-red-400 hover:text-red-600 p-2"><i class="fa fa-trash"></i></button>
            </div>
            <div class="flex items-center gap-2">
                <div class="relative w-10 h-10 bg-gray-200 rounded overflow-hidden border border-gray-300 flex-shrink-0 group">
                    <img class="v-img-preview w-full h-full object-cover ${d.imageUrl ? '' : 'hidden'}" src="${d.imageUrl||''}">
                    <i class="fa fa-image absolute inset-0 flex items-center justify-center text-gray-400 ${d.imageUrl ? 'hidden' : ''} v-img-placeholder"></i>
                </div>
                
                <label class="cursor-pointer text-xs bg-white border border-gray-300 px-2 py-1 rounded hover:bg-gray-100 text-gray-600">
                    <i class="fa fa-upload mr-1"></i> Upload
                    <input type="file" class="hidden v-file-input" accept="image/*" onchange="handleVariationUpload(this)">
                </label>

                <button type="button" onclick="openVariationMagicModal(this)" class="text-xs bg-purple-100 border border-purple-200 text-purple-700 px-2 py-1 rounded hover:bg-purple-200 font-bold">
                    <i class="fa fa-wand-magic-sparkles mr-1"></i> Magic Gen
                </button>
                
                <input type="hidden" class="v-img-url" value="${d.imageUrl||''}">
            </div>
        `;
        document.getElementById('product-variations-container').appendChild(div);
    };

    window.handleVariationUpload = async (input) => {
        if(input.files && input.files[0]) {
            const row = input.closest('.variation-row');
            const file = input.files[0];
            const url = URL.createObjectURL(file); // Temp preview
            row.querySelector('.v-img-preview').src = url;
            row.querySelector('.v-img-preview').classList.remove('hidden');
            row.querySelector('.v-img-placeholder').classList.add('hidden');
            const realUrl = await uploadImageToImgBB(file);
            if(realUrl) row.querySelector('.v-img-url').value = realUrl;
        }
    };

    let generatedImageUrl = null;

    window.openVariationMagicModal = (btn) => {
        if(!GEMINI_API_KEY) { alert("System Error: Admin has not configured AI Key."); return; }
        activeVariationRow = btn.closest('.variation-row');
        const varName = activeVariationRow.querySelector('.v-name').value;
        const prodName = document.getElementById('product-name').value;
        
        document.getElementById('gen-image-preview').classList.add('hidden');
        document.getElementById('gen-placeholder').classList.remove('hidden');
        document.getElementById('gen-save-btn').disabled = true;
        document.getElementById('gen-prompt-input').value = `${prodName} in ${varName} color`;
        
        document.getElementById('variation-image-modal').classList.remove('hidden');
    };

    window.closeVariationMagicModal = () => {
        document.getElementById('variation-image-modal').classList.add('hidden');
        generatedImageUrl = null;
    };

    window.saveVariationImage = () => {
        if (!generatedImageUrl) { alert("No image generated yet!"); return; }
        if (!activeVariationRow) { alert("Error: No variation row selected."); return; }
        
        const imgPreview = activeVariationRow.querySelector('.v-img-preview');
        const imgPlaceholder = activeVariationRow.querySelector('.v-img-placeholder');
        const imgUrlInput = activeVariationRow.querySelector('.v-img-url');
        
        imgPreview.src = generatedImageUrl;
        imgPreview.classList.remove('hidden');
        imgPlaceholder.classList.add('hidden');
        imgUrlInput.value = generatedImageUrl;
        
        closeVariationMagicModal();
    };

    window.generateVariationImage = async () => {
        const promptInput = document.getElementById('gen-prompt-input');
        const userPrompt = promptInput.value;
        const mainImageInput = document.getElementById('product-image-files');
        
        if(!userPrompt) { alert("Please enter a color or variation name!"); return; }

        const loader = document.getElementById('gen-loader');
        const loaderText = loader.querySelector('p');
        const preview = document.getElementById('gen-image-preview');
        const placeholder = document.getElementById('gen-placeholder');
        const saveBtn = document.getElementById('gen-save-btn');
        const genBtn = document.querySelector('button[onclick="generateVariationImage()"]');
        const originalBtnText = '<i class="fa fa-sync-alt"></i>';

        loader.classList.remove('hidden'); placeholder.classList.add('hidden'); preview.classList.add('hidden');
        saveBtn.disabled = true; genBtn.disabled = true; genBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';

        try {
            let finalPrompt = userPrompt;
            if (mainImageInput.files && mainImageInput.files[0]) {
                loaderText.textContent = "üëÄ AI is looking at your original photo...";
                const imageFile = mainImageInput.files[0];
                const base64Image = await fileToGenerativePart(imageFile);
                const visionPrompt = "Describe the clothing item in this image in extreme detail including material, neck style, sleeve length, and fit. Do NOT mention the color. Keep it under 40 words.";
                const styleDescription = await callGeminiAPI(null, visionPrompt, base64Image);
                if (styleDescription) {
                    finalPrompt = `${styleDescription}, in ${userPrompt} color, realistic, 8k, product photography`;
                }
            } else {
                const prodName = document.getElementById('product-name').value;
                finalPrompt = `${prodName} in ${userPrompt}, high quality`;
            }

            loaderText.textContent = "üé® Painting new variation...";
            const encodedPrompt = encodeURIComponent(finalPrompt);
            const seed = Math.floor(Math.random() * 99999);
            const url = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=512&height=512&model=flux&nologo=true&seed=${seed}`;

            const img = new Image();
            img.onload = () => {
                preview.src = url; preview.classList.remove('hidden'); loader.classList.add('hidden');
                saveBtn.disabled = false; saveBtn.textContent = "Use This Image";
                genBtn.disabled = false; genBtn.innerHTML = originalBtnText;
                generatedImageUrl = url; loaderText.textContent = "Creating Magic...";
            };
            img.onerror = () => { alert("Generation failed."); loader.classList.add('hidden'); placeholder.classList.remove('hidden'); genBtn.disabled = false; genBtn.innerHTML = originalBtnText; };
            img.src = url;

        } catch(e) { console.error(e); alert("Something went wrong."); loader.classList.add('hidden'); placeholder.classList.remove('hidden'); genBtn.disabled = false; genBtn.innerHTML = originalBtnText; }
    };

    // --- CRUD ---
    async function loadMyProducts() {
        const con = document.getElementById('product-list-container');
        const q = query(collection(db, publicDataPath, 'products'), where("sellerUid", "==", currentUser.uid), orderBy("createdAt", "desc"));
        try {
            const snap = await getDocs(q);
            if (snap.empty) { con.innerHTML = '<div class="col-span-full text-center py-10 text-gray-500">No products.</div>'; return; }
            con.innerHTML = snap.docs.map(doc => {
                const p = doc.data();
                return `<div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden flex flex-col h-full group">
                    <div class="relative aspect-[4/5] overflow-hidden bg-gray-50"><img src="${p.imageUrl||'https://placehold.co/300'}" class="w-full h-full object-cover group-hover:scale-110 transition"></div>
                    <div class="p-3 flex flex-col flex-grow">
                        <h3 class="font-semibold text-sm line-clamp-2 mb-1">${p.name}</h3>
                        <div class="mt-auto text-mudalali-red font-bold">Rs. ${p.price}</div>
                        <div class="grid grid-cols-2 gap-2 border-t border-gray-100 pt-2 mt-2">
                            <button class="bg-blue-50 text-blue-600 hover:bg-blue-100 py-1 rounded text-xs font-bold edit-btn" data-id="${doc.id}">Edit</button>
                            <button class="bg-red-50 text-red-600 hover:bg-red-100 py-1 rounded text-xs font-bold delete-btn" data-id="${doc.id}">Delete</button>
                        </div>
                    </div></div>`;
            }).join('');
            con.querySelectorAll('.edit-btn').forEach(b => b.onclick = () => openProductModal(b.dataset.id));
            con.querySelectorAll('.delete-btn').forEach(b => b.onclick = () => deleteProduct(b.dataset.id));
        } catch (e) {}
    }
    window.deleteProduct = async (id) => { if(confirm("Delete?")) { await deleteDoc(doc(db, publicDataPath, 'products', id)); loadMyProducts(); } }

    async function saveProduct(e) {
        e.preventDefault();
        const btn = document.getElementById('save-product-btn'); btn.disabled = true; btn.textContent = 'Saving...';
        try {
            const id = document.getElementById('product-id').value;
            const name = document.getElementById('product-name').value;
            const price = Number(document.getElementById('product-sale-price').value);
            const originalPrice = Number(document.getElementById('product-original-price').value) || null;
            
            // üü¢ NEW: Get Minimum Price
            const minPrice = Number(document.getElementById('product-min-price').value) || null;

            const desc = document.getElementById('product-description').value;
            const custom = document.getElementById('product-customization-check').checked;
            const catSelect = document.getElementById('product-category-select');
            let category = catSelect.value;
            if (catSelect.selectedOptions[0]?.text.includes("(AI New)") || catSelect.selectedOptions[0]?.text.includes("(New)")) {
                 try { await addDoc(collection(db, publicDataPath, 'categories'), { name: category, createdAt: serverTimestamp() }); } catch(e){}
            }
            const variations = [];
            document.querySelectorAll('.variation-row').forEach(r => {
                const n = r.querySelector('.v-name').value; const p = r.querySelector('.v-price').value; const img = r.querySelector('.v-img-url').value;
                if(n && p) variations.push({name: n, price: Number(p), imageUrl: img});
            });
            let imageUrl = null; let imageUrls = [];
            const files = document.getElementById('product-image-files').files;
            if (files.length > 0) {
                const urls = await Promise.all(Array.from(files).map(uploadImageToImgBB));
                imageUrls = urls.filter(u => u); imageUrl = imageUrls[0];
            } else if (id) {
                const old = await getDoc(doc(db, publicDataPath, 'products', id));
                if(old.exists()) { imageUrl = old.data().imageUrl; imageUrls = old.data().imageUrls || []; }
            }
            
            // üü¢ NEW: Added minPrice to data object
            const data = { sellerUid: currentUser.uid, storeName: currentStoreData.storeName||'Store', name, price, originalPrice, minPrice, description: desc, category, categories: [category], customizationAvailable: custom, imageUrl, imageUrls, variations, updatedAt: serverTimestamp(), isApproved: true };
            
            if (id) await updateDoc(doc(db, publicDataPath, 'products', id), data);
            else { data.createdAt = serverTimestamp(); await addDoc(collection(db, publicDataPath, 'products'), data); }
            document.getElementById('product-modal').classList.add('hidden'); loadMyProducts(); alert('Saved!');
        } catch(e) { alert(e.message); } finally { btn.disabled = false; btn.textContent = 'Save Product'; }
    }

    async function loadMyOrders() { /* Same as before */ }
    async function loadMyStories() { /* Same as before */ }
    function setupStoryForm() { /* Same as before */ }
    function setupSettingsForm() { /* Same as before */ }

    function openProductModal(id) {
        const form = document.getElementById('product-form'); form.reset();
        document.getElementById('product-modal-title').textContent = id ? 'Edit' : 'Add';
        document.getElementById('product-id').value = id || '';
        
        // üü¢ NEW: Reset min price field
        document.getElementById('product-min-price').value = '';

        document.getElementById('product-image-preview-container').innerHTML = '';
        document.getElementById('product-variations-container').innerHTML = '';
        if(id) {
            getDoc(doc(db, publicDataPath, 'products', id)).then(snap => {
                if(snap.exists()) {
                    const p = snap.data();
                    document.getElementById('product-name').value = p.name;
                    document.getElementById('product-sale-price').value = p.price;
                    document.getElementById('product-original-price').value = p.originalPrice||'';
                    
                    // üü¢ NEW: Load min price
                    document.getElementById('product-min-price').value = p.minPrice || '';

                    document.getElementById('product-description').value = p.description;
                    document.getElementById('product-customization-check').checked = p.customizationAvailable;
                    const sel = document.getElementById('product-category-select'); sel.value = p.category;
                    if(!sel.value && p.category) { const o = document.createElement('option'); o.value = p.category; o.text = p.category; sel.add(o); sel.value = p.category; }
                    if(p.imageUrls) p.imageUrls.forEach(u => { const i = document.createElement('img'); i.src = u; i.className = 'w-16 h-16 object-cover rounded'; document.getElementById('product-image-preview-container').appendChild(i); });
                    if(p.variations) p.variations.forEach(v => addVariationRow(v));
                }
            });
        }
        document.getElementById('product-modal').classList.remove('hidden');
    }
    document.getElementById('add-variation-btn').onclick = () => addVariationRow();
    function typeWriter(element, text) { element.value = ""; let i = 0; const interval = setInterval(() => { element.value += text.charAt(i); i++; if (i > text.length) clearInterval(interval); }, 10); }

    // --- SELLER CHAT SYSTEM ---
    
    window.loadSellerMessages = () => {
        const container = document.getElementById('chat-list-container');
        const q = query(
            collection(db, publicDataPath, 'customizationRequests'), 
            where("sellerId", "==", currentUser.uid),
            orderBy("lastUpdated", "desc")
        );

        onSnapshot(q, (snapshot) => {
            if (snapshot.empty) {
                container.innerHTML = '<p class="text-center text-gray-400 text-sm mt-10">No messages yet.</p>';
                return;
            }

            container.innerHTML = '';
            snapshot.forEach(doc => {
                const data = doc.data();
                const isActive = activeChatId === doc.id ? 'bg-green-50 border-mudalali-green' : 'bg-white hover:bg-gray-50 border-transparent';
                const lastMsg = data.messages[data.messages.length - 1];
                const time = lastMsg ? new Date(lastMsg.time).toLocaleDateString() : '';
                const statusColor = data.status === 'pending' ? 'text-yellow-600 bg-yellow-100' : (data.status === 'approved' ? 'text-green-600 bg-green-100' : 'text-red-600 bg-red-100');

                const div = document.createElement('div');
                div.className = `p-3 rounded-lg border cursor-pointer transition mb-2 shadow-sm ${isActive}`;
                div.onclick = () => openSellerChat(doc.id, data);
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <h4 class="font-bold text-sm text-gray-800">${data.buyerName}</h4>
                        <span class="text-[10px] text-gray-400">${time}</span>
                    </div>
                    <p class="text-xs text-gray-500 truncate mb-2">${lastMsg ? (lastMsg.sender === 'seller' ? 'You: ' : '') + lastMsg.text : 'No messages'}</p>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-1">
                            <img src="${data.productImage}" class="w-5 h-5 rounded object-cover">
                            <span class="text-[10px] text-gray-600 truncate w-20">${data.productName}</span>
                        </div>
                        <span class="text-[10px] px-2 py-0.5 rounded-full font-bold ${statusColor}">${data.status.toUpperCase()}</span>
                    </div>
                `;
                container.appendChild(div);
            });
        });
    };

    window.openSellerChat = (chatId, data) => {
        activeChatId = chatId;
        loadSellerMessages(); // Refresh UI Selection

        // Desktop UI
        document.getElementById('chat-empty-state').classList.add('hidden');
        document.getElementById('chat-interface').classList.remove('hidden');
        document.getElementById('chat-buyer-name').textContent = data.buyerName;
        document.getElementById('chat-product-name').textContent = data.productName;
        document.getElementById('chat-product-img').src = data.productImage;

        // Mobile UI
        if(window.innerWidth < 1024) {
            document.getElementById('mobile-chat-modal').classList.remove('hidden');
            document.getElementById('mobile-chat-buyer').textContent = data.buyerName;
            document.getElementById('mobile-chat-product').textContent = data.productName;
            document.getElementById('mobile-status-badge').textContent = data.status.toUpperCase();
        }

        updateStatusUI(data.status);

        if(chatUnsubscribe) chatUnsubscribe();
        chatUnsubscribe = onSnapshot(doc(db, publicDataPath, 'customizationRequests', chatId), (docSnap) => {
            if(docSnap.exists()) {
                const newData = docSnap.data();
                renderMessages(newData.messages);
                updateStatusUI(newData.status);
            }
        });
    };

    function updateStatusUI(status) {
        const buttons = document.getElementById('chat-action-buttons');
        const display = document.getElementById('chat-status-display');
        const mobileActions = document.getElementById('mobile-chat-actions');
        const mobileBadge = document.getElementById('mobile-status-badge');
        
        if(status === 'pending') {
            buttons.classList.remove('hidden');
            display.classList.add('hidden');
            if(mobileActions) mobileActions.classList.remove('hidden');
        } else {
            buttons.classList.add('hidden');
            display.classList.remove('hidden');
            display.textContent = status === 'approved' ? 'Approved' : 'Rejected';
            display.className = status === 'approved' ? 'px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 border border-green-200' : 'px-3 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700 border border-red-200';
            if(mobileActions) mobileActions.classList.add('hidden');
        }
        if(mobileBadge) {
            mobileBadge.textContent = status.toUpperCase();
            mobileBadge.className = `text-[10px] font-bold px-2 py-1 rounded ${status === 'pending' ? 'bg-yellow-100 text-yellow-700' : (status === 'approved' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700')}`;
        }
    }

    // --- üü¢ UPDATE: renderMessages Function ---
    function renderMessages(messages) {
        const desktopArea = document.getElementById('chat-messages-area');
        const mobileArea = document.getElementById('mobile-messages-area');
        
        const html = messages.map(msg => {
            const isMe = msg.sender === 'seller';
            
            // 1. Offer ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂±‡∂∏‡∑ä ‡∑Ä‡∑ô‡∂±‡∂∏ Style ‡∂ë‡∂ö‡∂ö‡∑ä
            if (msg.type === 'offer') {
                return `
                    <div class="flex w-full justify-end">
                        <div class="seller-offer-bubble">
                            <p class="text-[10px] font-bold text-gray-400 uppercase mb-1">YOU SENT AN OFFER</p>
                            <p class="text-sm">${msg.text}</p>
                            <div class="seller-offer-price">Rs. ${parseFloat(msg.price).toFixed(2)}</div>
                            <p class="text-[9px] mt-1 opacity-70">${new Date(msg.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                        </div>
                    </div>
                `;
            } 
            // 2. ‡∑É‡∑è‡∂∏‡∑è‡∂±‡∑ä‚Äç‡∂∫ Message ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂±‡∂∏‡∑ä
            else {
                return `
                    <div class="flex w-full ${isMe ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-[80%] ${isMe ? 'bg-mudalali-green text-white rounded-br-none' : 'bg-white border text-gray-800 rounded-bl-none'} p-3 rounded-2xl shadow-sm text-sm">
                            <p>${msg.text}</p>
                            <p class="text-[9px] mt-1 opacity-70 text-right">${new Date(msg.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                        </div>
                    </div>
                `;
            }
        }).join('');

        desktopArea.innerHTML = html;
        mobileArea.innerHTML = html;
        desktopArea.scrollTop = desktopArea.scrollHeight;
        mobileArea.scrollTop = mobileArea.scrollHeight;
    }

    // --- üü¢ FIX: Normal Message ‡∂∫‡∑Ä‡∂± Function ‡∂ë‡∂ö ---
    async function handleSendMessage(text) {
        if(!activeChatId || !text.trim()) return;
        
        try {
            const chatRef = doc(db, publicDataPath, 'customizationRequests', activeChatId);
            
            // Normal text message ‡∂ë‡∂ö‡∂ö‡∑ä ‡∑Ä‡∑í‡∂Ø‡∑í‡∂∫‡∂ß ‡∂∫‡∑Ä‡∂±‡∑Ä‡∑è
            await updateDoc(chatRef, {
                messages: arrayUnion({ 
                    sender: 'seller', 
                    text: text.trim(), 
                    time: Date.now() 
                    // type: 'offer' ‡∂ö‡∑í‡∂∫‡∂Ω‡∑è ‡∂Ø‡∑è‡∂±‡∑ä‡∂±‡∑ö ‡∂±‡∑ë, ‡∂ë‡∂≠‡∂ö‡∑ú‡∂ß ‡∂∏‡∑ö‡∂ö normal message ‡∂ë‡∂ö‡∂ö‡∑ä
                }),
                lastUpdated: serverTimestamp()
            });
        } catch(e) { 
            console.error("Send Error:", e); 
            alert("Failed to send message"); 
        }
    }

    document.getElementById('seller-chat-form').onsubmit = (e) => { e.preventDefault(); const i = document.getElementById('seller-chat-input'); handleSendMessage(i.value); i.value = ''; };
    document.getElementById('mobile-chat-form').onsubmit = (e) => { e.preventDefault(); const i = document.getElementById('mobile-chat-input'); handleSendMessage(i.value); i.value = ''; };

    window.updateChatStatus = async (newStatus) => {
        if(!activeChatId || !confirm(`Are you sure you want to ${newStatus} this request?`)) return;
        try {
            const chatRef = doc(db, publicDataPath, 'customizationRequests', activeChatId);
            const msgText = newStatus === 'approved' ? "‚úÖ Request Approved!" : "‚ùå Request Rejected.";
            await updateDoc(chatRef, {
                status: newStatus, lastUpdated: serverTimestamp(),
                messages: arrayUnion({ sender: 'seller', text: msgText, time: Date.now() })
            });
        } catch(e) { console.error(e); alert("Error updating status"); }
    };

    async function callGeminiAPI(ignoredModel, promptText, inlineImage) {
        if (!GEMINI_API_KEY) { console.error("Missing API Key"); return null; }
        const parts = [{ text: promptText }]; 
        if (inlineImage) parts.push(inlineImage);
        for (const modelName of GEMINI_MODELS) {
            try {
                console.log(`ü§ñ Trying AI Model: ${modelName}...`); 
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${GEMINI_API_KEY}`, { 
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts }] }) 
                });
                if (!res.ok) { console.warn(`‚ö†Ô∏è Model ${modelName} failed. Next...`); continue; }
                const data = await res.json(); 
                if(data.candidates && data.candidates.length > 0) return data.candidates[0].content.parts[0].text;
                else throw new Error("No candidates");
            } catch (e) { console.warn(`‚ö†Ô∏è Error ${modelName}:`, e); continue; }
        }
        alert("System Busy: AI models are overloaded. Try again later."); return null;
    }

    async function fileToGenerativePart(file) { return new Promise((resolve) => { const r = new FileReader(); r.onloadend = () => resolve({ inlineData: { data: r.result.split(',')[1], mimeType: file.type } }); r.readAsDataURL(file); }); }
    async function uploadImageToImgBB(file) { const d = new FormData(); d.append('image', file); try { const r = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, { method: 'POST', body: d }); const j = await r.json(); return j.data.url; } catch(e) { return null; } }
    function setupDashboardNavigation() {
        const tabs = document.querySelectorAll('.sidebar-link, .mobile-nav-link');
        tabs.forEach(t => t.onclick = () => {
            const h = t.getAttribute('href') || t.dataset.hash;
            document.querySelectorAll('.dashboard-view').forEach(v => v.classList.add('hidden'));
            document.getElementById('view-'+h.substring(1)).classList.remove('hidden');
            tabs.forEach(x => x.classList.remove('active')); t.classList.add('active');
            document.getElementById('dashboard-drawer').classList.remove('open');
        });
        document.getElementById('dashboard-menu-btn').onclick = () => document.getElementById('dashboard-drawer').classList.add('open');
        document.getElementById('dashboard-drawer-overlay').onclick = () => document.getElementById('dashboard-drawer').classList.remove('open');
        document.getElementById('nav-btn-add').onclick = () => document.getElementById('add-new-modal').classList.remove('hidden');
        document.getElementById('add-modal-cancel-btn').onclick = () => document.getElementById('add-new-modal').classList.add('hidden');
        document.getElementById('add-modal-product-btn').onclick = () => { document.getElementById('add-new-modal').classList.add('hidden'); openProductModal(); };
        document.querySelector('.modal-overlay').onclick = () => document.getElementById('add-new-modal').classList.add('hidden');
    }
    function setupProductModal() {
        document.getElementById('product-form').onsubmit = saveProduct;
        document.getElementById('open-product-modal-btn').onclick = () => openProductModal();
        document.getElementById('close-product-modal-btn').onclick = () => document.getElementById('product-modal').classList.add('hidden');
        document.getElementById('product-image-files').onchange = function() {
            const c = document.getElementById('product-image-preview-container'); c.innerHTML = '';
            Array.from(this.files).forEach(f => { const i = document.createElement('img'); i.src = URL.createObjectURL(f); i.className='w-16 h-16 object-cover rounded'; c.appendChild(i); });
        };
    }
    async function loadSellerData() {
        const s = await getDoc(doc(db, publicDataPath, 'stores', currentUser.uid));
        if(s.exists()) {
            currentStoreData = s.data();
            document.getElementById('settings-store-name').value = currentStoreData.storeName || '';
            document.getElementById('settings-description').value = currentStoreData.description || '';
            document.getElementById('settings-location').value = currentStoreData.location || '';
            document.getElementById('settings-shipping-fee').value = currentStoreData.shippingFee || '';
            document.getElementById('preview-store-name').textContent = currentStoreData.storeName || 'Store Name';
            if(currentStoreData.bannerUrl) { document.getElementById('preview-banner-img').src = currentStoreData.bannerUrl; document.getElementById('preview-banner-img').classList.remove('hidden'); }
            if(currentStoreData.profileUrl) { document.getElementById('preview-profile-img').src = currentStoreData.profileUrl; document.getElementById('preview-profile-img').classList.remove('hidden'); }
        }
    }
    async function loadCategoriesIntoModal() { const s = document.getElementById('product-category-select'); const snap = await getDocs(query(collection(db, publicDataPath, 'categories'), orderBy('name'))); s.innerHTML = '<option value="">Select</option>'; snap.forEach(d => { const o = document.createElement('option'); o.value = d.data().name; o.text = d.data().name; s.add(o); }); }
    function setupLogoutButtons() { document.getElementById('drawer-logout-btn').onclick = () => signOut(auth); document.getElementById('mobile-drawer-logout-btn').onclick = () => signOut(auth); }

    // --- üü¢ NEW: Offer Modal Logic ---
    window.toggleOfferModal = () => {
        const modal = document.getElementById('create-offer-modal');
        modal.classList.toggle('hidden');
        document.getElementById('offer-price-input').value = '';
        document.getElementById('offer-note-input').value = '';
    };

    window.sendCustomOffer = async () => {
        const price = document.getElementById('offer-price-input').value;
        const note = document.getElementById('offer-note-input').value;

        if (!price || price <= 0) {
            alert("Please enter a valid price.");
            return;
        }
        if (!activeChatId) {
            alert("No active chat selected.");
            return;
        }

        try {
            const chatRef = doc(db, publicDataPath, 'customizationRequests', activeChatId);
            
            // Offer ‡∂ë‡∂ö Message ‡∂ë‡∂ö‡∂ö‡∑ä ‡∑Ä‡∑í‡∂Ø‡∑í‡∂∫‡∂ß ‡∂∫‡∑Ä‡∂±‡∑Ä‡∑è (type: 'offer' ‡∂ë‡∂ö‡∑ä‡∂ö)
            await updateDoc(chatRef, {
                messages: arrayUnion({
                    sender: 'seller',
                    text: note || `Custom offer created for Rs. ${price}`,
                    price: Number(price), // ‡∂∏‡∑ö‡∂ö ‡∂≠‡∂∏‡∂∫‡∑í ‡∑Ä‡∑ê‡∂Ø‡∂ú‡∂≠‡∑ä‡∂∏ field ‡∂ë‡∂ö
                    type: 'offer',        // ‡∂∏‡∑ö‡∂ö‡∑ô‡∂±‡∑ä ‡∂≠‡∂∏‡∂∫‡∑í product.html ‡∂ë‡∂ö‡∑ö‡∂Ø‡∑í button ‡∂ë‡∂ö ‡∂¥‡∑ô‡∂±‡∑ä‡∂±‡∂±‡∑ä‡∂±‡∑ö
                    time: Date.now()
                }),
                lastUpdated: serverTimestamp()
            });

            window.toggleOfferModal(); // Modal ‡∂ë‡∂ö ‡∑Ä‡∑Ñ‡∂±‡∑Ä‡∑è
            alert("Offer Sent Successfully!");

        } catch (e) {
            console.error("Error sending offer:", e);
            alert("Failed to send offer.");
        }
    }; 

</script>
</body>
</html>