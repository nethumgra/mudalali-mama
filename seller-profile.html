<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller Dashboard - මුදලාලි මාමා</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        'mudalali-green': {
                            light: '#76b852',       
                            DEFAULT: '#3a6a4a',      
                            dark: '#2c5234',        
                        },
                        'mudalali-gold': '#bda26b',
                        'mudalali-red': '#d93a3e',
                        'mudalali-bg': '#f5f5f4',
                        'mm-gray': { 
                            light: '#f8f8f8',
                            DEFAULT: '#e5e5e5',
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        body {
            @apply font-sans text-gray-800 bg-mudalali-bg;
        }
        .drawer-overlay { @apply fixed inset-0 bg-black bg-opacity-50 z-50 transition-opacity opacity-0 pointer-events-none; }
        .drawer-content { @apply fixed top-0 right-0 h-full bg-white shadow-xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out; width: 90%; max-width: 400px; }
        .drawer-content.left { @apply left-0 right-auto transform -translate-x-full; }
        .drawer.open .drawer-overlay { @apply opacity-100 pointer-events-auto; }
        .drawer.open .drawer-content { @apply transform translate-x-0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { scrollbar-width: none; }
        .sidebar-link { @apply flex items-center p-3 text-gray-600 font-medium rounded-lg hover:bg-gray-100 hover:text-mudalali-green transition-colors; }
        .sidebar-link.active { @apply bg-mudalali-green text-white shadow-md; }
        .sidebar-link i { @apply w-6 text-center; }
        .stat-card { @apply bg-white p-6 rounded-lg shadow-md; }
        .form-input { @apply mt-1 block w-full p-3 border rounded-md focus:ring-mudalali-green focus:border-mudalali-green; }
        .form-label { @apply block text-sm font-medium text-gray-700; }
        .btn-primary { @apply w-full bg-mudalali-green text-white p-3 rounded-md hover:bg-mudalali-green-dark font-bold text-lg; }
        .btn-secondary { @apply w-full bg-gray-100 text-gray-700 p-3 rounded-md hover:bg-gray-200 font-bold; }
        .modal-overlay { @apply fixed inset-0 bg-black bg-opacity-50 z-40 transition-opacity; }
        .modal-content { @apply relative bg-white rounded-lg shadow-xl p-6 w-full max-w-lg m-4 transform transition-all z-50; }
        /* .dynamic-field-group { @apply hidden space-y-4 p-4 border-t; } */ /* Me class eka dan wedak ne */
        .mobile-nav-link { @apply flex-1 flex flex-col items-center justify-center text-gray-600 hover:text-mudalali-green text-xs; }
        .mobile-nav-link.active { @apply text-mudalali-green; }
    </style>
</head>
<body class="pb-20 md:pb-0"> 
    
    <div id="auth-loader" class="fixed inset-0 bg-mudalali-bg z-[10000] flex flex-col items-center justify-center">
        <svg class="animate-spin h-10 w-10 text-mudalali-green mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-gray-600 font-semibold">Authenticating Seller...</p>
    </div>
    
    <div id="page-loader" class="fixed top-0 left-0 w-0 h-1 bg-mudalali-green z-[9999] transition-all duration-300 ease-linear"></div>
    
    <aside class="w-64 fixed top-0 left-0 h-full bg-white shadow-lg z-30 hidden md:flex flex-col">
        <div class="p-4 border-b">
    <a href="index.html" class="flex items-center gap-2">
        <img id="logo-img" src="https://i.ibb.co/1tCywvyP/logo.png" class="h-10" alt="Logo">
        
        <span class="text-xl font-bold text-mudalali-green-dark">Dashboard</span>
    </a>
</div>
        <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
            <a href="#products" id="nav-products" class="sidebar-link active">
                <i class="fa fa-box"></i>
                <span class="ml-3">My Products</span>
            </a>
            <a href="#orders" id="nav-orders" class="sidebar-link">
                <i class="fa fa-receipt"></i>
                <span class="ml-3">My Orders</span>
            </a>
            <a href="#stories" id="nav-stories" class="sidebar-link">
                <i class="fa fa-book-open"></i>
                <span class="ml-3">My Stories</span>
            </a>
            <a href="#settings" id="nav-settings" class="sidebar-link">
                <i class="fa fa-cog"></i>
                <span class="ml-3">Store Settings</span>
            </a>
        </nav>
        <div class="p-4 border-t">
            <a href="store.html?id=USER_ID" id="view-public-store-link" target="_blank" class="block text-center w-full bg-mudalali-green-light text-mudalali-green-dark p-2 rounded-md hover:bg-mudalali-green hover:text-white font-semibold text-sm">
                <i class="fa fa-store mr-1"></i> View My Store
            </a>
            <button id="drawer-logout-btn" class="w-full text-left text-gray-600 p-3 rounded-lg hover:bg-gray-100 font-medium text-sm mt-2">
                <i class="fa fa-sign-out-alt w-6"></i>
                <span class="ml-3">Logout</span>
            </button>
        </div>
    </aside>

    <header class="bg-white shadow-md sticky top-0 z-40 flex md:hidden items-center justify-between p-4">
        <button id="dashboard-menu-btn" class="text-2xl text-gray-700">
            <i class="fa fa-bars"></i>
        </button>
        <h1 class="text-lg font-bold text-mudalali-green-dark" id="mobile-page-title">My Products</h1>
        <a href="account.html" id="mobile-account-btn" class="text-2xl text-gray-700">
            <i class="fa fa-user"></i>
        </a>
    </header>

    <main class="md:ml-64 py-8 px-4 md:px-10">
        
        <div id="view-products" class="dashboard-view">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">My Products</h1>
                <button id="open-product-modal-btn" class="bg-mudalali-green text-white px-5 py-2 rounded-lg font-semibold hover:bg-mudalali-green-dark">
                    <i class="fa fa-plus mr-1"></i> Add New Product
                </button>
            </div>
           <div id="product-list-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6">
                <p class="text-gray-500">Loading your products...</p>
            </div>
        </div>

        <div id="view-orders" class="dashboard-view hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">My Orders</h1>
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div id="order-list-container" class="divide-y divide-gray-200">
                    <p class="p-6 text-gray-500">Loading your orders...</p>
                </div>
            </div>
        </div>

        <div id="view-stories" class="dashboard-view hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">My Stories</h1>
         <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="lg:col-span-1">
                    <form id="create-story-form" class="bg-white p-6 rounded-lg shadow-md space-y-4">
                        <input type="hidden" id="story-edit-id">
                        <h2 id="story-form-title" class="text-xl font-bold text-gray-800">Create New Story</h2>
                        <div>
                            <label for="story-content" class="form-label">Story Content</label>
                            <textarea id="story-content" class="form-input" rows="4" placeholder="What's on your mind?"></textarea>
                        </div>
                        <div>
                            <label for="story-image-file" class="form-label">Cover Image (1080x1080px)</label>
                            <input type="file" id="story-image-file" class="form-input" accept="image/*">
                        </div>
                        <div id="story-image-preview-container" class="hidden relative w-full h-auto max-h-96 overflow-hidden rounded-md border border-gray-200">
                            <img id="story-image-preview" src="" class="w-full h-auto object-contain">
                            <button type="button" id="remove-story-image-btn" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                        <div>
                            <label for="story-product-tag-select" class="form-label">Tag a Product (Optional)</label>
                            <select id="story-product-tag-select" class="form-input">
                                <option value="">No Product</option>
                            </select>
                        </div>
                        <button id="submit-story-btn" type="submit" class="btn-primary !text-base !py-2">Post Story</button>
                        <button id="cancel-edit-story-btn" type="button" class="btn-secondary !text-base !py-2 hidden">Cancel Edit</button>
                        <p id="story-upload-status" class="text-sm text-gray-600 mt-2"></p>
                    </form>
                </div>
               <div class="lg:col-span-1">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Published Stories</h2>
                    <div id="story-list-container" class="space-y-4">
                        <p class="text-gray-500">Loading your stories...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-settings" class="dashboard-view hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Store Settings</h1>
            
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <form id="settings-form" class="lg:col-span-2 bg-white p-6 md:p-8 rounded-lg shadow-md space-y-6">
                    <div>
                        <label for="settings-store-name" class="form-label">Store Name</label>
                        <input type="text" id="settings-store-name" class="form-input">
                    </div>
                    <div>
                        <label for="settings-description" class="form-label">Store Description</label>
                        <textarea id="settings-description" rows="4" class="form-input"></textarea>
                    </div>
                    <div>
                        <label for="settings-location" class="form-label">Location</label>
                        <input type="text" id="settings-location" class="form-input">
                    </div>
                    
                    <div>
                        <label for="settings-shipping-fee" class="form-label">Standard Delivery Charge (LKR)</label>
                        <input type="number" id="settings-shipping-fee" class="form-input" placeholder="e.g. 350">
                        <p class="text-xs text-gray-500 mt-1">This is the flat shipping fee you will charge *per item* in an order.</p>
                    </div>
                    <div>
                        <label for="settings-banner-file" class="form-label">Store Banner Image</label>
                        <input type="file" id="settings-banner-file" class="form-input" accept="image/*">
                    </div>
                    <div>
                        <label for="settings-profile-file" class="form-label">Store Profile Picture</label>
                        <input type="file" id="settings-profile-file" class="form-input" accept="image/*">
                    </div>
                    <button type="submit" id="save-settings-btn" class="btn-primary !text-base !py-2.5">Save Settings</button>
                    <p id="settings-save-status" class="text-sm text-gray-600 mt-2"></p>
                </form>
                
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-md overflow-hidden sticky top-24">
                        <div class="h-32 bg-gray-200 flex items-center justify-center">
                            <img id="preview-banner-img" src="" class="w-full h-full object-cover hidden">
                            <span id="preview-banner-placeholder" class="text-gray-400">Banner Preview</span>
                        </div>
                        <div class="p-4 relative">
                            <div class="absolute -top-12 left-4 w-20 h-20 rounded-full border-4 border-white bg-gray-300 overflow-hidden flex items-center justify-center">
                                <img id="preview-profile-img" src="" class="w-full h-full object-cover hidden">
                                <span id="preview-profile-placeholder" class="text-gray-500 text-3xl"><i class="fa fa-store"></i></span>
                            </div>
                            <h3 id="preview-store-name" class="text-xl font-bold text-gray-800 mt-8 truncate">Store Name</h3>
                            <p id="preview-location" class="text-sm text-gray-500 mt-1"><i class="fa fa-map-marker-alt mr-1"></i>Location</p>
                            <p id="preview-description" class="text-sm text-gray-600 mt-3 h-20 overflow-y-auto no-scrollbar">Store Description goes here...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </main>

    <nav class="fixed bottom-0 left-0 right-0 h-16 bg-white border-t border-gray-200 shadow-lg flex justify-around items-center z-40 md:hidden">
        <a href="index.html" class="mobile-nav-link">
            <i class="fa fa-home text-xl"></i>
            <span class="mt-1">Home</span>
        </a>
        <a href="store.html?id=USER_ID" id="mobile-public-store-link" class="mobile-nav-link">
            <i class="fa fa-store text-xl"></i>
            <span class="mt-1">My Store</span>
        </a>
        <button id="nav-btn-add" class="text-white">
            <div class="w-14 h-14 rounded-full bg-mudalali-green flex items-center justify-center -mt-6 shadow-lg">
                <i class="fa fa-plus text-2xl"></i>
            </div>
        </button>
        <button id="nav-btn-orders" class="mobile-nav-link" data-hash="#orders">
            <i class="fa fa-receipt text-xl"></i>
            <span class="mt-1">Orders</span>
        </button>
        <button id="nav-btn-dashboard" class="mobile-nav-link active" data-hash="#products">
            <i class="fa fa-user-circle text-xl"></i>
            <span class="mt-1">Dashboard</span>
        </button>
    </nav>

    <div id="product-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="modal-content relative max-h-[90vh] overflow-y-auto no-scrollbar">
            <h2 id="product-modal-title" class="text-2xl font-bold text-gray-800 mb-6">Add New Product</h2>
            <form id="product-form" class="space-y-4">
                <input type="hidden" id="product-id">
                <div>
                    <label for="product-name" class="form-label">Product Name</label>
                    <input type="text" id="product-name" class="form-input" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="product-original-price" class="form-label">Default "Original Price"</label>
                        <input type="number" id="product-original-price" class="form-input" placeholder="e.g. 1200">
                        <p class="text-xs text-gray-500 mt-1">Customer will see this with 5% added.</p>
                    </div>
                    <div>
                        <label for="product-sale-price" class="form-label">Default Price (LKR)</label>
                        <input type="number" id="product-sale-price" class="form-input" placeholder="e.g. 1000" required>
                        <p class="text-xs text-gray-500 mt-1">5% (Platform Fee) will be added to this.</p>
                    </div>
                </div>
                <div>
                    <label for="product-description" class="form-label">Description</label>
                    <textarea id="product-description" rows="3" class="form-input"></textarea>
                </div>
                <div>
                    <label for="product-category-select" class="form-label">Category</label>
                    <select id="product-category-select" class="form-input">
                        <option value="">Loading Categories...</option>
                    </select>
                </div>
                
                <div class="p-4 border-t space-y-3 bg-gray-50 rounded-md">
                    <label class="form-label">Product Variations (Optional)</label>
                    <p class="text-xs text-gray-500 -mt-2">Use this if your product has different sizes, colors, or types with **different prices**. If you add variations, the default price above will be used as the base.</p>
                    
                    <div id="product-variations-container" class="space-y-3">
                        </div>
                    
                    <button type="button" id="add-variation-btn" class="w-full bg-mudalali-green-light text-mudalali-green-dark p-2 rounded-md hover:bg-mudalali-green hover:text-white font-semibold text-sm">
                        <i class="fa fa-plus mr-1"></i> Add Variation
                    </button>
                </div>
                <div>
                    <label for="product-image-files" class="form-label">Product Images (Add Multiple)</label>
                    <input type="file" id="product-image-files" class="form-input" accept="image/*" multiple>
                    <div id="product-image-preview-container" class="mt-2 flex flex-wrap gap-2">
                        </div>
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="button" id="close-product-modal-btn" class="btn-secondary !text-base !py-2.5">Cancel</button>
                    <button type="submit" id="save-product-btn" class="btn-primary !text-base !py-2.5">Save Product</button>
                </div>
                <p id="product-save-status" class="text-sm text-gray-600 mt-2"></p>
            </form>
        </div>
    </div>
    <div id="add-new-modal" class="hidden fixed inset-0 z-50 flex items-end justify-center p-4">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="modal-content relative w-full" style="max-width: 400px;">
            <h2 class="text-xl font-bold text-gray-800 text-center mb-4">Create New...</h2>
            <div class="flex flex-col gap-3">
                <button id="add-modal-product-btn" class="w-full text-center bg-mudalali-green text-white p-3 rounded-lg hover:bg-mudalali-green-dark font-bold text-base">
                    <i class="fa fa-box mr-2"></i> Add New Product
                </button>
                <button id="add-modal-story-btn" class="w-full text-center bg-mudalali-green text-white p-3 rounded-lg hover:bg-mudalali-green-dark font-bold text-base">
                    <i class="fa fa-book-open mr-2"></i> Write New Story
                </button>
                <button id="add-modal-cancel-btn" class="w-full text-center bg-gray-100 text-gray-700 p-2 rounded-lg hover:bg-gray-200 font-bold text-sm mt-2">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="dashboard-drawer" class="drawer">
        <div class="drawer-overlay" id="dashboard-drawer-overlay"></div>
        <aside class="drawer-content left w-64 flex flex-col">
            <div class="p-4 border-b">
                <a href="index.html" class="flex items-center gap-2">
                    <img id="mobile-logo-img" class="h-10" alt="Logo">
                    <span class="text-xl font-bold text-mudalali-green-dark">Dashboard</span>
                </a>
            </div>
            <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
                <a href="#products" id="mobile-nav-products" class="sidebar-link active">
                    <i class="fa fa-box"></i>
                    <span class="ml-3">My Products</span>
                </a>
                <a href="#orders" id="mobile-nav-orders" class="sidebar-link">
                    <i class="fa fa-receipt"></i>
                    <span class="ml-3">My Orders</span>
                </a>
                <a href="#stories" id="mobile-nav-stories" class="sidebar-link">
                    <i class="fa fa-book-open"></i>
                    <span class="ml-3">My Stories</span>
                </a>
                <a href="#settings" id="mobile-nav-settings" class="sidebar-link">
                    <i class="fa fa-cog"></i>
                    <span class="ml-3">Store Settings</span>
                </a>
            </nav>
            <div class="p-4 border-t">
                <a href="store.html?id=USER_ID" id="mobile-view-public-store-link" target="_blank" class="block text-center w-full bg-mudalali-green-light text-mudalali-green-dark p-2 rounded-md hover:bg-mudalali-green hover:text-white font-semibold text-sm">
                    <i class="fa fa-store mr-1"></i> View My Store
                </a>
                <button id="mobile-drawer-logout-btn" class="w-full text-left text-gray-600 p-3 rounded-lg hover:bg-gray-100 font-medium text-sm mt-2">
                    <i class="fa fa-sign-out-alt w-6"></i>
                    <span class="ml-3">Logout</span>
                </button>
            </div>
        </aside>
    </div>

    <div id="comments-drawer" class="drawer">
        <div class="drawer-overlay" id="comments-drawer-overlay"></div>
        <div class="drawer-content flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-bold">Comments</h2>
                <button id="comments-drawer-close" class="text-xl">&times;</button>
            </div>
            <div id="comments-list-container" class="flex-grow p-4 overflow-y-auto space-y-4">
                <p class="text-gray-500 text-center">Loading comments...</p>
            </div>
            <div class="p-4 border-t bg-gray-50">
                <div class="flex gap-2">
                    <input type="text" id="new-comment-input" placeholder="Write a comment..." class="flex-grow p-2 border rounded-lg focus:ring-mudalali-green focus:border-mudalali-green" disabled>
                    <button id="submit-comment-btn" class="bg-mudalali-green text-white px-4 rounded-lg font-semibold hover:bg-mudalali-green-dark" disabled>
                        <i class="fa fa-paper-plane"></i>
                    </button>
                </div>
                <p id="comment-login-prompt" class="text-xs text-gray-500 mt-2 text-center hidden">Please <a href="#" id="comment-login-link" class="text-mudalali-green font-semibold">log in</a> to comment.</p>
            </div>
        </div>
    </div>

    <div id="cart-drawer" class="drawer"> </div>
    <div id="account-drawer-modal" class="drawer drawer-modal fixed inset-0 z-50 hidden"> </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            getDocs,
            collection, 
            onSnapshot,
            query,
            where,
            orderBy,
            setDoc,
            addDoc,
            updateDoc, 
            deleteDoc, 
            serverTimestamp,
            increment
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDIbu2qT53iGPqMCx5UdU6XY8wvXkb3ZF4",
            authDomain: "mudalali-mama.firebaseapp.com",
            projectId: "mudalali-mama",
            storageBucket: "mudalali-mama.firebasestorage.app",
            messagingSenderId: "296597428969",
            appId: "1:296597428969:web:684668be9c0eaeecb4ae78",
            measurementId: "G-GC1CP1LRFD"
        };

        const imgbbApiKey = 'f068295c19803c448665a0ea48bcc2fc'; // --- IMAGE UPLOAD KEY ---

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); 
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const publicDataPath = `/artifacts/${appId}/public/data`;
        const usersPath = `/users`; 

        let currentUser = null;
        let currentUserData = null;
        let currentStoreData = {};
        let currentEditedStoryImageUrl = null; 
        let currentStoryIdForComment = null;
        let unsubscribeCommentsListener = null;

        onAuthStateChanged(auth, async (user) => {
            const authLoader = document.getElementById('auth-loader');
            if (user) {
                currentUser = user;
                const userDocRef = doc(db, usersPath, user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (!userDocSnap.exists() || !userDocSnap.data().isSeller) {
                    alert("You do not have permission to view this page.");
                    window.location.href = 'index.html'; 
                    return;
                }
                
                currentUserData = userDocSnap.data();
                initializeDashboard();
                
                authLoader.classList.add('hidden'); 

                document.getElementById('new-comment-input').disabled = false;
                document.getElementById('submit-comment-btn').disabled = false;
                document.getElementById('comment-login-prompt').classList.add('hidden');

            } else {
                window.location.href = 'account.html'; 

                document.getElementById('new-comment-input').disabled = true;
                document.getElementById('submit-comment-btn').disabled = true;
                document.getElementById('comment-login-prompt').classList.remove('hidden');
            }
        });

        async function loadCategoriesIntoModal() {
            const selectEl = document.getElementById('product-category-select');
            if (!selectEl) return; 

            selectEl.innerHTML = '<option value="">Select a Category</option>'; 

            try {
                const collRef = collection(db, publicDataPath, 'categories');
                const q = query(collRef, orderBy("name", "asc")); 
                
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    console.warn("No categories found in Firestore.");
                    selectEl.innerHTML = '<option value="">No categories found</option>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const category = doc.data();
                    const option = document.createElement('option');
                    option.value = category.name; 
                    option.textContent = category.name;
                    selectEl.appendChild(option);
                });

            } catch (e) {
                console.error("Error loading categories into modal: ", e);
                selectEl.innerHTML = '<option value="">Error loading categories</option>';
            }
        }

        function initializeDashboard() {
            console.log("Seller Dashboard Initialized for:", currentUser.uid);
            loadSiteConfig();
            setupDashboardNavigation();
            loadSellerData();
            loadMyProducts();
            loadMyOrders();
            loadMyStories(); 
            loadCategoriesIntoModal(); 
            setupCommentDrawer();

            setupLogoutButtons();
            setupProductModal();
            setupStoryForm();
            setupSettingsForm();

            document.getElementById('mobile-public-store-link').href = `store.html?id=${currentUser.uid}`;

            document.getElementById('page-loader').style.width = '100%';
            setTimeout(() => document.getElementById('page-loader').style.display = 'none', 500);
        }

        function setupDashboardNavigation() {
            const navLinks = document.querySelectorAll('.sidebar-link');
            const mobileNavLinks = document.querySelectorAll('#dashboard-drawer .sidebar-link');
            const mobileBottomNavLinks = document.querySelectorAll('.mobile-nav-link[data-hash]');
            const views = document.querySelectorAll('.dashboard-view');
            const mobilePageTitle = document.getElementById('mobile-page-title');
            const dashboardDrawer = document.getElementById('dashboard-drawer');
            const addModal = document.getElementById('add-new-modal');

            function switchView(hash) {
                if (!hash) hash = '#products';
                window.location.hash = hash;

                views.forEach(view => view.classList.add('hidden'));
                const activeView = document.getElementById(`view-${hash.substring(1)}`);
                activeView?.classList.remove('hidden');

                let activeLinkTitle = 'My Products';
                navLinks.forEach(link => {
                    if (link.hash === hash) {
                        link.classList.add('active');
                        activeLinkTitle = link.querySelector('span').textContent;
                    } else {
                        link.classList.remove('active');
                    }
                });
                
                mobileNavLinks.forEach(link => {
                    if (link.hash === hash) link.classList.add('active');
                    else link.classList.remove('active');
                });

                mobileBottomNavLinks.forEach(link => {
                    if (link.dataset.hash === hash) link.classList.add('active');
                    else link.classList.remove('active');
                });
                
                mobilePageTitle.textContent = activeLinkTitle;
                dashboardDrawer.classList.remove('open');
            }

            navLinks.forEach(link => link.addEventListener('click', (e) => switchView(e.currentTarget.hash)));
            mobileNavLinks.forEach(link => link.addEventListener('click', (e) => switchView(e.currentTarget.hash)));
            mobileBottomNavLinks.forEach(link => link.addEventListener('click', (e) => switchView(e.currentTarget.dataset.hash)));

            document.getElementById('dashboard-menu-btn').addEventListener('click', () => dashboardDrawer.classList.add('open'));
            document.getElementById('dashboard-drawer-overlay').addEventListener('click', () => dashboardDrawer.classList.remove('open'));
            
            document.getElementById('nav-btn-add').addEventListener('click', () => addModal.classList.remove('hidden'));
            addModal.querySelector('.modal-overlay').addEventListener('click', () => addModal.classList.add('hidden'));
            document.getElementById('add-modal-cancel-btn').addEventListener('click', () => addModal.classList.add('hidden'));

            document.getElementById('add-modal-product-btn').addEventListener('click', () => {
                addModal.classList.add('hidden');
                document.getElementById('open-product-modal-btn').click();
            });
            document.getElementById('add-modal-story-btn').addEventListener('click', () => {
                addModal.classList.add('hidden');
                switchView('#stories');
            });
            
            switchView(window.location.hash);

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.story-options-btn')) {
                    document.querySelectorAll('.story-options-menu').forEach(menu => menu.classList.add('hidden'));
                }
            });
        }

        async function loadSellerData() {
            const storeRef = doc(db, publicDataPath, 'stores', currentUser.uid);
            const storeSnap = await getDoc(storeRef);

            if (storeSnap.exists()) {
                currentStoreData = storeSnap.data();
                document.getElementById('settings-store-name').value = currentStoreData.storeName || '';
                document.getElementById('settings-description').value = currentStoreData.description || '';
                document.getElementById('settings-location').value = currentStoreData.location || '';
                document.getElementById('settings-shipping-fee').value = currentStoreData.shippingFee || '';
                
                updateSettingsPreview(currentStoreData.storeName, currentStoreData.description, currentStoreData.location, currentStoreData.bannerUrl, currentStoreData.profileUrl);
            } else {
                await setDoc(storeRef, {
                    storeName: currentUserData.displayName || 'My Store',
                    description: 'Welcome to my new store!',
                    location: 'Sri Lanka',
                    shippingFee: 0, 
                    bannerUrl: null,
                    profileUrl: null,
                    createdAt: serverTimestamp()
                });
                currentStoreData = (await getDoc(storeRef)).data();
                updateSettingsPreview(currentStoreData.storeName, currentStoreData.description, currentStoreData.location, currentStoreData.bannerUrl, currentStoreData.profileUrl);
            }
            
            document.getElementById('view-public-store-link').href = `store.html?id=${currentUser.uid}`;
            document.getElementById('mobile-view-public-store-link').href = `store.html?id=${currentUser.uid}`;
        }
        
        function updateSettingsPreview(name, desc, loc, bannerImg, profileImg) {
            const nameEl = document.getElementById('preview-store-name');
            const descEl = document.getElementById('preview-description');
            const locEl = document.getElementById('preview-location');
            const bannerImgEl = document.getElementById('preview-banner-img');
            const bannerPlaceholder = document.getElementById('preview-banner-placeholder');
            const profileImgEl = document.getElementById('preview-profile-img');
            const profilePlaceholder = document.getElementById('preview-profile-placeholder');

            nameEl.textContent = name || 'Store Name';
            descEl.textContent = desc || 'Store Description goes here...';
            locEl.innerHTML = `<i class="fa fa-map-marker-alt mr-1"></i> ${loc || 'Location'}`;

            if (bannerImg && bannerImg.startsWith('http')) {
                bannerImgEl.src = bannerImg;
                bannerImgEl.classList.remove('hidden');
                bannerPlaceholder.classList.add('hidden');
            } else {
                bannerImgEl.classList.add('hidden');
                bannerPlaceholder.classList.remove('hidden');
            }

            if (profileImg && profileImg.startsWith('http')) {
                profileImgEl.src = profileImg;
                profileImgEl.classList.remove('hidden');
                profilePlaceholder.classList.add('hidden');
            } else {
                profileImgEl.classList.add('hidden');
                profilePlaceholder.classList.remove('hidden');
            }
        }

        async function loadMyProducts() {
            const container = document.getElementById('product-list-container');
            const productSelect = document.getElementById('story-product-tag-select');
            
            container.innerHTML = '';
            productSelect.innerHTML = '<option value="">No Product</option>';

            const productsRef = collection(db, publicDataPath, 'products');
            const q = query(productsRef, where("sellerUid", "==", currentUser.uid), orderBy("createdAt", "desc"));

            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                container.innerHTML = '<p class="text-gray-500">You haven\'t added any products yet.</p>';
                return;
            }

            querySnapshot.forEach(doc => {
                const product = doc.data();
                const productId = doc.id;
                
                const sellerPrice = product.basePrice || product.price; 
                const sellerOriginalPrice = product.baseOriginalPrice || product.originalPrice; 

                let priceHtml = `<p class="text-mudalali-green font-semibold">Rs. ${sellerPrice.toFixed(2)}</p>`;
                if (sellerOriginalPrice && sellerOriginalPrice > sellerPrice) {
                    priceHtml = `
                        <p class="text-mudalali-red font-bold text-lg">Rs. ${sellerPrice.toFixed(2)}</p>
                        <p class="text-gray-400 line-through text-sm">Rs. ${sellerOriginalPrice.toFixed(2)}</p>
                    `;
                }

              container.innerHTML += `
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="h-48 w-full bg-gray-100"> 
            <img src="${product.imageUrl || 'https://placehold.co/400x300'}" alt="${product.name}" class="h-full w-full object-contain">
        </div>
        <div class="p-4">
                            <h3 class="text-lg font-bold text-gray-800">${product.name}</h3>
                            <div class="flex items-baseline gap-2">${priceHtml}</div>
                            <p class="text-sm text-gray-600 mt-2 truncate">${product.description}</p>
                            <div class="flex gap-2 mt-4">
                                <button class="edit-product-btn w-full text-sm bg-gray-100 p-2 rounded-md font-semibold hover:bg-gray-200" data-id="${productId}">Edit</button>
                                <button class="delete-product-btn w-full text-sm bg-red-100 text-red-600 p-2 rounded-md font-semibold hover:bg-red-200" data-id="${productId}">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
                
                const option = document.createElement('option');
                option.value = productId;
                option.textContent = product.name;
                option.dataset.name = product.name;
                option.dataset.price = product.price; 
                option.dataset.image = product.imageUrl;
                productSelect.appendChild(option);
            });
            
            container.querySelectorAll('.edit-product-btn').forEach(btn => btn.addEventListener('click', (e) => openProductModal(e.target.dataset.id)));
            container.querySelectorAll('.delete-product-btn').forEach(btn => btn.addEventListener('click', (e) => deleteProduct(e.target.dataset.id)));
        }

        async function loadMyOrders() { 
            const container = document.getElementById('order-list-container');
            container.innerHTML = '<p class="p-6 text-gray-500">Loading your orders...</p>';
            try {
                const ordersRef = collection(db, "orders");
                const allOrdersQ = query(collection(db, "orders"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(allOrdersQ);
                
                let myOrders = [];
                querySnapshot.forEach(doc => {
                    const order = doc.data();
                    const myItemsInThisOrder = (order.items || []).filter(item => item.sellerUid === currentUser.uid);
                    
                    if (myItemsInThisOrder.length > 0) {
                        let sellerTotal = 0;
                        myItemsInThisOrder.forEach(item => {
                            sellerTotal += (item.price * item.quantity); 
                        });
                        
                        order.sellerTotal = sellerTotal; 
                        myOrders.push(order);
                    }
                });

                if (myOrders.length === 0) {
                    container.innerHTML = '<p class="p-6 text-gray-500">You have no orders yet.</p>';
                    return;
                }
                
                container.innerHTML = ''; 
                myOrders.forEach(order => {
                    container.innerHTML += `
                        <div class="p-4 md:p-6">
                            <div class="flex flex-col md:flex-row justify-between md:items-center">
                                <div>
                                    <p class="text-sm font-semibold text-gray-500">Order ID: ${order.id || 'N/A'}</p>
                                    <h3 class="text-lg font-bold text-gray-800">${order.customerInfo.name || 'N/A'}</h3>
                                    <p class="text-sm text-gray-500">${order.createdAt.toDate().toLocaleDateString()}</p>
                                </div>
                                <div class="mt-2 md:mt-0 text-left md:text-right">
                                    <p class="text-xl font-bold text-mudalali-green">Rs. ${order.sellerTotal.toFixed(2)}</p>
                                    <span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-700">${order.status || 'Pending'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });

            } catch (err) {
                console.error("Error loading orders:", err);
                container.innerHTML = '<p class="p-6 text-red-500">Error loading orders. Check console for index errors.</p>';
            }
        }
        
        async function loadMyStories() { 
            const container = document.getElementById('story-list-container');
            container.innerHTML = '';
            
            const storiesRef = collection(db, publicDataPath, 'stories');
            const q = query(storiesRef, where("sellerUid", "==", currentUser.uid), orderBy("createdAt", "desc"));
            
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                container.innerHTML = '<p class="text-gray-500">You haven\'t posted any stories yet.</p>';
                return;
            }
            
            querySnapshot.forEach(doc => {
                const story = doc.data();
                const storeName = currentStoreData.storeName || 'Unknown Seller';
                const profileUrl = currentStoreData.profileUrl || 'https://placehold.co/40x40/3a6a4a/f5f5f4?text=MM';

                let taggedProductHtml = '';
                if (story.taggedProductId && story.taggedProductName) {
                    taggedProductHtml = `
                        <div class="flex items-center gap-2 bg-gray-100 p-2 rounded-md mt-3">
                            <img src="${story.taggedProductImageUrl || 'https://placehold.co/40x40'}" class="w-10 h-10 object-cover rounded-md">
                            <div>
                                <p class="text-sm font-semibold text-gray-700">${story.taggedProductName}</p>
                                <p class="text-xs text-mudalali-red">Rs. ${story.taggedProductPrice ? story.taggedProductPrice.toFixed(2) : '0.00'}</p>
                            </div>
                        </div>
                    `;
                }

                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-lg shadow-md space-y-3 relative";
                card.innerHTML = `
                    <div class="absolute top-2 right-2 z-10">
                        <button class="story-options-btn text-gray-500 hover:text-gray-800 w-8 h-8 rounded-full flex items-center justify-center">
                            <i class="fa fa-ellipsis-v"></i>
                        </button>
                        <div class="story-options-menu hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-xl z-20">
                            <button class="edit-story-btn block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-id="${doc.id}" data-timestamp="${story.createdAt ? story.createdAt.toMillis() : 0}">
                                <i class="fa fa-edit w-4 mr-2"></i> Edit
                            </button>
                            <button class="delete-story-btn block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100" data-id="${doc.id}">
                                <i class="fa fa-trash w-4 mr-2"></i> Delete
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <img src="${profileUrl}" class="w-10 h-10 rounded-full object-cover">
                        <div>
                            <p class="font-semibold text-gray-800">${storeName}</p>
                            <p class="text-xs text-gray-500">${story.createdAt ? new Date(story.createdAt.toDate()).toLocaleString() : 'Just now'}</p>
                        </div>
                    </div>
                    <p class="text-gray-700 whitespace-pre-wrap">${story.content}</p>
                    ${story.imageUrl ? `<img src="${story.imageUrl}" class="w-full h-auto max-h-96 object-contain rounded-md border border-gray-200 bg-gray-100">` : ''}
                    ${taggedProductHtml}
                    <div class="flex gap-4 text-sm text-gray-500 border-t pt-3 mt-3 justify-between">
                        <div class="flex gap-4 items-center">
                            <span><i class="fa fa-heart mr-1"></i> ${story.likeCount || 0} Likes</span>
                            <button class="comment-count-btn text-gray-500 hover:text-mudalali-green cursor-pointer" data-id="${doc.id}" data-seller-id="${currentUser.uid}">
                                <i class="fa fa-comment mr-1"></i> ${story.commentCount || 0} Comments
                            </button>
                        </div>
                        <button class="share-story-btn text-gray-500 hover:text-mudalali-green" data-id="${doc.id}" data-content="${story.content ? story.content.replace(/"/g, '&quot;') : ''}">
                            <i class="fa fa-share mr-1"></i> Share
                        </button>
                    </div>
                `;
                container.appendChild(card);

                card.querySelector('.story-options-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.story-options-menu').forEach(menu => {
                        if (menu !== card.querySelector('.story-options-menu')) {
                            menu.classList.add('hidden');
                        }
                    });
                    card.querySelector('.story-options-menu').classList.toggle('hidden');
                });
                card.querySelector('.delete-story-btn').addEventListener('click', (e) => {
                    deleteStory(e.currentTarget.dataset.id);
                });
                card.querySelector('.edit-story-btn').addEventListener('click', (e) => {
                    const timestamp = new Date(parseInt(e.currentTarget.dataset.timestamp));
                    openStoryEditModal(e.currentTarget.dataset.id, timestamp);
                });
                card.querySelector('.comment-count-btn').addEventListener('click', (e) => {
                    openCommentsDrawer(e.currentTarget.dataset.id, e.currentTarget.dataset.sellerId);
                });
                card.querySelector('.share-story-btn').addEventListener('click', (e) => {
                    shareStory(e.currentTarget.dataset.id, e.currentTarget, e.currentTarget.dataset.content);
                });
            });
        }

        async function shareStory(storyId, buttonEl, storyContent) {
            const storyUrl = `${window.location.origin}/story-detail.html?id=${storyId}`; 
            const shareData = {
                title: `Story from ${currentStoreData.storeName}`,
                text: storyContent ? storyContent.substring(0, 100) + '...' : 'Check out this story on Mudalali Mama!',
                url: storyUrl
            };

            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    throw new Error('Web Share not supported');
                }
            } catch (err) {
                try {
                    await navigator.clipboard.writeText(storyUrl);
                    const originalText = buttonEl.innerHTML;
                    buttonEl.innerHTML = '<i class="fa fa-check mr-1"></i> Copied!';
                    buttonEl.disabled = true;
                    setTimeout(() => {
                        buttonEl.innerHTML = '<i class="fa fa-share mr-1"></i> Share';
                        buttonEl.disabled = false;
                    }, 2000);
                } catch (copyErr) {
                    console.error('Failed to copy story link: ', copyErr);
                    alert('Failed to copy link.');
                }
            }
        }

        async function deleteStory(storyId) {
            if (!confirm('Are you sure you want to delete this story?')) return;
            try {
                const docRef = doc(db, publicDataPath, 'stories', storyId);
                await deleteDoc(docRef);
                loadMyStories(); 
            } catch (err) {
                console.error("Error deleting story: ", err);
                alert('Error: Could not delete story.');
            }
        }

        async function openStoryEditModal(storyId, timestamp) {
            if (timestamp.getTime() === 0) {
                alert('Cannot edit story: Invalid timestamp.');
                return;
            }
            const hoursSincePost = (Date.now() - timestamp.getTime()) / (1000 * 60 * 60);
            if (hoursSincePost > 12) {
                alert('You can only edit stories posted within the last 12 hours.');
                return;
            }

            try {
                const docRef = doc(db, publicDataPath, 'stories', storyId);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) {
                    alert('Story not found.');
                    return;
                }
                
                const story = docSnap.data();
                
                document.getElementById('story-edit-id').value = storyId;
                document.getElementById('story-form-title').textContent = "Edit Story";
                document.getElementById('story-content').value = story.content || '';
                document.getElementById('story-product-tag-select').value = story.taggedProductId || '';
                
                const previewContainer = document.getElementById('story-image-preview-container');
                const previewImg = document.getElementById('story-image-preview');
                if (story.imageUrl) {
                    previewImg.src = story.imageUrl;
                    previewContainer.classList.remove('hidden');
                    currentEditedStoryImageUrl = story.imageUrl; 
                } else {
                    previewImg.src = '';
                    previewContainer.classList.add('hidden');
                    currentEditedStoryImageUrl = null;
                }
                
                document.getElementById('story-image-file').value = ''; 
                document.getElementById('submit-story-btn').textContent = "Save Changes";
                document.getElementById('cancel-edit-story-btn').classList.remove('hidden');

                switchView('#stories');
                document.getElementById('create-story-form').scrollIntoView({ behavior: 'smooth' });

            } catch (err) {
                console.error("Error opening story for edit: ", err);
                alert('Could not load story for editing.');
            }
        }

        // =====================================
        // === PRODUCT MODAL JS - WENAS WELA ===
        // =====================================
        
        // --- Aluth Function eka: Variation Row ekak hadanna ---
        function addVariationRow(variation = {}) {
            const container = document.getElementById('product-variations-container');
            const newRow = document.createElement('div');
            newRow.className = 'variation-row flex gap-2 items-center p-2 border rounded-md bg-white';
            
            // variation object eken data gannawa (edit karaddi)
            const name = variation.name || '';
            const price = variation.price || ''; // Me 'price' eka seller ge 'basePrice' eka

            newRow.innerHTML = `
                <div class="flex-grow">
                    <label class="text-xs font-medium text-gray-600">Name (e.g., Small, Red)</label>
                    <input type="text" class="variation-name form-input !p-2 !mt-0" placeholder="Variation Name" value="${name}" required>
                </div>
                <div class="w-28 flex-shrink-0">
                    <label class="text-xs font-medium text-gray-600">Your Price</label>
                    <input type="number" class="variation-price form-input !p-2 !mt-0" placeholder="e.g. 1000" value="${price}" required>
                </div>
                <button type="button" class="remove-variation-btn text-red-500 hover:text-red-700 h-10 w-10 mt-4 flex-shrink-0">
                    <i class="fa fa-trash"></i>
                </button>
            `;
            container.appendChild(newRow);
        }

        function setupProductModal() {
            const modal = document.getElementById('product-modal');
            const openBtn = document.getElementById('open-product-modal-btn');
            const closeBtn = document.getElementById('close-product-modal-btn');
            const overlay = modal.querySelector('.modal-overlay');
            const form = document.getElementById('product-form');
            const modalTitle = document.getElementById('product-modal-title');
            
            const fileInput = document.getElementById('product-image-files'); 
            const previewContainer = document.getElementById('product-image-preview-container'); 
            const variationsContainer = document.getElementById('product-variations-container'); // Aluth

            const openModal = () => modal.classList.remove('hidden');
            const closeModal = () => {
                modal.classList.add('hidden');
                form.reset();
                previewContainer.innerHTML = ''; 
                variationsContainer.innerHTML = ''; // Aluth: variations clear karanna
                document.getElementById('product-id').value = '';
                document.getElementById('product-save-status').textContent = '';
            };

            openBtn.addEventListener('click', () => {
                modalTitle.textContent = 'Add New Product';
                openModal();
            });
            closeBtn.addEventListener('click', closeModal);
            overlay.addEventListener('click', closeModal);
            
            fileInput.addEventListener('change', () => {
                previewContainer.innerHTML = ''; 
                const files = fileInput.files;
                
                if (files.length > 0) {
                    Array.from(files).forEach(file => {
                        const img = document.createElement('img');
                        img.src = URL.createObjectURL(file);
                        img.className = 'w-24 h-24 object-cover rounded-md border';
                        previewContainer.appendChild(img);
                    });
                }
            });
            
            // --- Aluth: Variation buttons walata listeners ---
            document.getElementById('add-variation-btn').addEventListener('click', () => {
                addVariationRow(); // His row ekak add karanawa
            });
            
            // Event Delegation: "Remove" button click karama row eka ain karanna
            variationsContainer.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-variation-btn');
                if (removeBtn) {
                    removeBtn.closest('.variation-row').remove();
                }
            });
            // --- Iwarai ---
            
            form.addEventListener('submit', saveProduct);
        }
        
        // --- Me function eka dan wedak ne ---
        // function showDynamicFields() { ... }

        async function openProductModal(productId) {
            const modalTitle = document.getElementById('product-modal-title');
            modalTitle.textContent = 'Edit Product';

            const docRef = doc(db, publicDataPath, 'products', productId);
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) return;
            
            const product = docSnap.data();
            document.getElementById('product-id').value = productId;
            document.getElementById('product-name').value = product.name;
            
            document.getElementById('product-original-price').value = product.baseOriginalPrice || product.originalPrice || '';
            document.getElementById('product-sale-price').value = product.basePrice || product.price; 

            document.getElementById('product-description').value = product.description;
            document.getElementById('product-category-select').value = product.category || '';
            
            // --- Parana dynamic fields (Fashion/Food) load karana ewa ain kara ---
            
            // --- Aluth: Variations load kirima ---
            const variationsContainer = document.getElementById('product-variations-container');
            variationsContainer.innerHTML = ''; // Clear karanna
            if (product.variations && Array.isArray(product.variations)) {
                product.variations.forEach(variation => {
                    // 'variation' object eka (e.g., {name: "Small", basePrice: 1000})
                    // 'addVariationRow' ekata pass karanawa
                    addVariationRow({
                        name: variation.name,
                        price: variation.basePrice // Seller ge price eka (basePrice) thama pennanna ona
                    });
                });
            }
            // --- Iwarai ---

            document.getElementById('product-image-files').value = ''; 
            const previewContainer = document.getElementById('product-image-preview-container');
            previewContainer.innerHTML = ''; 

            const imageUrls = product.imageUrls || (product.imageUrl ? [product.imageUrl] : []);

            if (imageUrls.length > 0) {
                imageUrls.forEach(url => {
                    const img = document.createElement('img');
                    img.src = url;
                    img.className = 'w-24 h-24 object-cover rounded-md border';
                    previewContainer.appendChild(img);
                });
            }
            
            document.getElementById('product-modal').classList.remove('hidden');
        }

        async function saveProduct(e) {
            e.preventDefault();
            const statusEl = document.getElementById('product-save-status');
            const saveBtn = document.getElementById('save-product-btn');
            saveBtn.disabled = true;
            statusEl.textContent = 'Saving...';
            
            const productId = document.getElementById('product-id').value;
            const imageFiles = document.getElementById('product-image-files').files; 
            let finalImageUrls = []; 

            try {
                if (imageFiles.length > 0) {
                    statusEl.textContent = `Uploading ${imageFiles.length} image(s)...`;
                    const uploadPromises = Array.from(imageFiles).map(file => uploadImageToImgBB(file));
                    finalImageUrls = await Promise.all(uploadPromises);
                    
                    if (finalImageUrls.some(url => !url)) {
                        throw new Error('Some image uploads failed.');
                    }
                } else if (productId) {
                    const existingProductDoc = await getDoc(doc(db, publicDataPath, 'products', productId));
                    if (existingProductDoc.exists()) {
                        const data = existingProductDoc.data();
                        finalImageUrls = data.imageUrls || (data.imageUrl ? [data.imageUrl] : []);
                    }
                }
                
                // --- Aluth: Variations data ganna ---
                const variationsContainer = document.getElementById('product-variations-container');
                const variationRows = variationsContainer.querySelectorAll('.variation-row');
                const variations = []; // Me array ekata thama variations save karanne
                
                let hasVariationError = false;
                for (const row of variationRows) {
                    const nameInput = row.querySelector('.variation-name');
                    const priceInput = row.querySelector('.variation-price');
                    
                    const name = nameInput.value.trim();
                    const sellerPrice = Number(priceInput.value);

                    // Validation
                    let rowError = false;
                    if (!name) {
                        nameInput.classList.add('border-red-500');
                        rowError = true;
                    } else {
                        nameInput.classList.remove('border-red-500');
                    }

                    if (!(sellerPrice > 0)) {
                        priceInput.classList.add('border-red-500');
                        rowError = true;
                    } else {
                        priceInput.classList.remove('border-red-500');
                    }

                    if (rowError) {
                        hasVariationError = true;
                    }

                    if (name && sellerPrice > 0) {
                        // Customer ge price eka calculate karanawa
                        const customerPrice = Math.round(sellerPrice * 1.05);
                        variations.push({
                            name: name,
                            basePrice: sellerPrice, // Seller's price
                            price: customerPrice    // Customer's price
                        });
                    }
                }
                
                if (hasVariationError) {
                    throw new Error('Please fill all variation names and prices correctly.');
                }
                // --- Iwarai ---
                
                const sellerSalePrice = Number(document.getElementById('product-sale-price').value);
                const sellerOriginalPrice = Number(document.getElementById('product-original-price').value) || null;

                const customerSalePrice = Math.round(sellerSalePrice * 1.05); 
                let customerOriginalPrice = null;
                if (sellerOriginalPrice && sellerOriginalPrice > 0) {
                    customerOriginalPrice = Math.round(sellerOriginalPrice * 1.05); 
                }
                
                const shippingFee = Number(currentStoreData.shippingFee) || 0;
                const category = document.getElementById('product-category-select').value;

                const productData = {
                    sellerUid: currentUser.uid,
                    storeName: currentStoreData.storeName || 'Mudalali Mama Store',
                    name: document.getElementById('product-name').value,
                    
                    basePrice: sellerSalePrice, // Default Seller Price
                    price: customerSalePrice, // Default Customer Price
                    
                    baseOriginalPrice: sellerOriginalPrice, // Default Seller Original Price
                    originalPrice: customerOriginalPrice, // Default Customer Original Price
                    
                    description: document.getElementById('product-description').value,
                    category: category,
                    categories: [category], 
                    
                    variations: variations, // Aluth variations array eka save karanawa
                    
                    imageUrl: finalImageUrls[0] || null, 
                    imageUrls: finalImageUrls, 
                    
                    shipping: shippingFee, 

                    updatedAt: serverTimestamp(),
                    isApproved: true 
                };

                let docRef;
                if (productId) {
                    docRef = doc(db, publicDataPath, 'products', productId);
                    await updateDoc(docRef, productData);
                } else {
                    productData.createdAt = serverTimestamp();
                    docRef = doc(collection(db, publicDataPath, 'products')); 
                    await setDoc(docRef, productData); 
                }

                statusEl.textContent = 'Product saved successfully!';
                loadMyProducts(); 
                loadCategoriesIntoModal(); 
                
                setTimeout(() => {
                    document.getElementById('product-modal').classList.add('hidden');
                    statusEl.textContent = '';
                    document.getElementById('product-form').reset();
                    document.getElementById('product-image-preview-container').innerHTML = '';
                    document.getElementById('product-variations-container').innerHTML = ''; // Aluth
                }, 1500);

            } catch (err) {
                console.error("Error saving product: ", err);
                statusEl.textContent = `Error: ${err.message}`;
            } finally {
                saveBtn.disabled = false;
            }
        }
        
        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) return;
            try {
                const docRef = doc(db, publicDataPath, 'products', productId);
                await deleteDoc(docRef);
                loadMyProducts();
            } catch (err) {
                console.error("Error deleting product: ", err);
                alert('Error: Could not delete product.');
            }
        }

        function resetStoryForm() {
            const form = document.getElementById('create-story-form');
            form.reset();
            document.getElementById('story-edit-id').value = '';
            document.getElementById('story-form-title').textContent = "Create New Story";
            document.getElementById('submit-story-btn').textContent = "Post Story";
            document.getElementById('cancel-edit-story-btn').classList.add('hidden');
            
            document.getElementById('story-image-preview-container').classList.add('hidden');
            document.getElementById('story-image-preview').src = '';
            document.getElementById('story-image-file').value = '';
            currentEditedStoryImageUrl = null;
        }

        function setupStoryForm() {
            const form = document.getElementById('create-story-form');
            const storyImageFile = document.getElementById('story-image-file');
            const storyImagePreview = document.getElementById('story-image-preview');
            const storyImagePreviewContainer = document.getElementById('story-image-preview-container');
            const removeStoryImageBtn = document.getElementById('remove-story-image-btn');

           storyImageFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            const statusEl = document.getElementById('story-upload-status');
            statusEl.textContent = ''; 

            if (file) {
                const img = new Image();
                img.src = URL.createObjectURL(file);
                
                img.onload = () => {
                    const width = img.width;
                    const height = img.height;

                    if (width === 1080 && height === 1080) {
                        statusEl.textContent = 'Image size eka hari (1080x1080px).';
                        statusEl.className = 'text-sm text-green-600 mt-2'; 
                        
                        storyImagePreview.src = img.src;
                        storyImagePreviewContainer.classList.remove('hidden');
                        currentEditedStoryImageUrl = null;
                        
                        URL.revokeObjectURL(img.src);

                    } else {
                        statusEl.textContent = `Error: Image eka 1080x1080px wenna one. Oya dapu eke size eka: ${width}x${height}px`;
                        statusEl.className = 'text-sm text-red-600 mt-2'; 
                        
                        e.target.value = ''; 
                        storyImagePreview.src = '';
                        storyImagePreviewContainer.classList.add('hidden');
                        currentEditedStoryImageUrl = null;
                        
                        URL.revokeObjectURL(img.src);
                    }
                };

                img.onerror = () => {
                    statusEl.textContent = 'Error: Image file eka load karanna ba.';
                    statusEl.className = 'text-sm text-red-600 mt-2';
                    e.target.value = '';
                    URL.revokeObjectURL(img.src);
                };

            } else {
                storyImagePreview.src = '';
                storyImagePreviewContainer.classList.add('hidden');
                currentEditedStoryImageUrl = null;
            }
        });

        removeStoryImageBtn.addEventListener('click', () => {
            storyImageFile.value = '';
            storyImagePreview.src = '';
            storyImagePreviewContainer.classList.add('hidden');
            currentEditedStoryImageUrl = null;
            document.getElementById('story-upload-status').textContent = ''; 
        });

            document.getElementById('cancel-edit-story-btn').addEventListener('click', resetStoryForm);

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const statusEl = document.getElementById('story-upload-status');
                const submitBtn = document.getElementById('submit-story-btn');
                submitBtn.disabled = true;
                
                const editId = document.getElementById('story-edit-id').value;
                statusEl.textContent = editId ? 'Saving changes...' : 'Posting...';
                
                const content = document.getElementById('story-content').value;
                const imageFile = storyImageFile.files[0];
                const productSelect = document.getElementById('story-product-tag-select');
                const selectedOption = productSelect.options[productSelect.selectedIndex];
                const taggedProductId = selectedOption.value;

                try {
                    let imageUrl = null;

                    if (editId) {
                        imageUrl = currentEditedStoryImageUrl; 
                    }

                    if (imageFile) {
                        statusEl.textContent = 'Uploading image...';
                        imageUrl = await uploadImageToImgBB(imageFile);
                        if (!imageUrl) throw new Error('Image upload failed.');
                    } else if (!imageUrl && !imageFile) {
                        imageUrl = null; 
                    }
                    
                    const storyData = {
                        sellerUid: currentUser.uid,
                        storeName: currentStoreData.storeName || currentUserData.displayName || 'Unknown Seller',
                        profileUrl: currentStoreData.profileUrl || null,
                        content: content,
                        imageUrl: imageUrl,
                        taggedProductId: taggedProductId || null,
                        taggedProductName: taggedProductId ? selectedOption.dataset.name : null,
                        taggedProductPrice: taggedProductId ? Number(selectedOption.dataset.price) : null,
                        taggedProductImageUrl: taggedProductId ? selectedOption.dataset.image : null,
                        updatedAt: serverTimestamp(),
                        isApproved: true 
                    };

                    if (editId) {
                        const storyRef = doc(db, publicDataPath, 'stories', editId);
                        await updateDoc(storyRef, storyData);
                        statusEl.textContent = 'Story updated!';
                    } else {
                        storyData.createdAt = serverTimestamp();
                        storyData.likeCount = 0;
                        storyData.commentCount = 0;
                        const storiesRef = collection(db, publicDataPath, 'stories');
                        await addDoc(storiesRef, storyData);
                        statusEl.textContent = 'Story posted!';
                    }
                    
                    resetStoryForm();
                    loadMyStories();
                
                } catch (err) {
                    console.error("Error saving story: ", err);
                    statusEl.textContent = `Error: ${err.message}`;
                } finally {
                    submitBtn.disabled = false;
                    setTimeout(() => statusEl.textContent = '', 3000);
                }
            });
        }
        
        function setupSettingsForm() {
            const form = document.getElementById('settings-form');
            
            ['settings-store-name', 'settings-description', 'settings-location'].forEach(id => {
                const inputEl = document.getElementById(id);
                inputEl.addEventListener('input', () => { 
                    updateSettingsPreview(
                        document.getElementById('settings-store-name').value,
                        document.getElementById('settings-description').value,
                        document.getElementById('settings-location').value,
                        document.getElementById('preview-banner-img').src, 
                        document.getElementById('preview-profile-img').src  
                    );
                });
            });
            
            ['settings-banner-file', 'settings-profile-file'].forEach(id => {
                document.getElementById(id).addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    const targetImgEl = (id === 'settings-banner-file') ? 'preview-banner-img' : 'preview-profile-img';
                    const placeholderEl = (id === 'settings-banner-file') ? 'preview-banner-placeholder' : 'preview-profile-placeholder';
                    
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            document.getElementById(targetImgEl).src = event.target.result;
                            document.getElementById(targetImgEl).classList.remove('hidden');
                            document.getElementById(placeholderEl).classList.add('hidden');
                            
                            updateSettingsPreview(
                                document.getElementById('settings-store-name').value,
                                document.getElementById('settings-description').value,
                                document.getElementById('settings-location').value,
                                document.getElementById('preview-banner-img').src, 
                                document.getElementById('preview-profile-img').src
                            );
                        }
                        reader.readAsDataURL(file);
                    } else {
                        const currentUrl = (id === 'settings-banner-file') ? currentStoreData.bannerUrl : currentStoreData.profileUrl;
                        if (currentUrl) {
                            document.getElementById(targetImgEl).src = currentUrl;
                            document.getElementById(targetImgEl).classList.remove('hidden');
                            document.getElementById(placeholderEl).classList.add('hidden');
                        } else {
                            document.getElementById(targetImgEl).classList.add('hidden');
                            document.getElementById(placeholderEl).classList.remove('hidden');
                            document.getElementById(targetImgEl).src = ''; 
                        }
                        updateSettingsPreview( 
                            document.getElementById('settings-store-name').value,
                            document.getElementById('settings-description').value,
                            document.getElementById('settings-location').value,
                            document.getElementById('preview-banner-img').src, 
                            document.getElementById('preview-profile-img').src
                        );
                    }
                });
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const statusEl = document.getElementById('settings-save-status');
                const saveBtn = document.getElementById('save-settings-btn');
                saveBtn.disabled = true;
                statusEl.textContent = 'Saving settings...';
                
                try {
                    const bannerFile = document.getElementById('settings-banner-file').files[0];
                    const profileFile = document.getElementById('settings-profile-file').files[0];
                    
                    let bannerUrl = currentStoreData.bannerUrl || null;
                    let profileUrl = currentStoreData.profileUrl || null;
                    
                    if (bannerFile) {
                        statusEl.textContent = 'Uploading banner...';
                        bannerUrl = await uploadImageToImgBB(bannerFile);
                    }

                    if (profileFile) {
                        statusEl.textContent = 'Uploading profile picture...';
                        profileUrl = await uploadImageToImgBB(profileFile);
                    }
                    
                    const settingsData = {
                        storeName: document.getElementById('settings-store-name').value,
                        description: document.getElementById('settings-description').value,
                        location: document.getElementById('settings-location').value,
                        shippingFee: Number(document.getElementById('settings-shipping-fee').value) || 0, 
                        bannerUrl: bannerUrl,
                        profileUrl: profileUrl,
                        updatedAt: serverTimestamp() 
                    };
                    
                    const storeRef = doc(db, publicDataPath, 'stores', currentUser.uid);
                    await setDoc(storeRef, settingsData, { merge: true }); 

                    currentStoreData = {...currentStoreData, ...settingsData}; 
                    statusEl.textContent = 'Settings saved successfully!';

                } catch (err) {
                    console.error("Error saving settings: ", err);
                    statusEl.textContent = `Error: ${err.message}`;
                } finally {
                    saveBtn.disabled = false;
                    setTimeout(() => statusEl.textContent = '', 3000);
                }
            });
        }
        
        async function uploadImageToImgBB(imageFile) {
            const formData = new FormData();
            formData.append('image', imageFile);
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.success) {
                    return data.data.url; 
                } else {
                    throw new Error(data.error.message);
                }
            } catch (error) {
                console.error('ImgBB Upload Error:', error);
                return null; 
            }
        }

        function formatTimestamp(date) {
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "y ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "mo ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "d ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "h ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "m ago";
            return Math.floor(seconds) + "s ago";
        }

        function setupCommentDrawer() {
            const drawer = document.getElementById('comments-drawer');
            const closeBtn = document.getElementById('comments-drawer-close');
            const overlay = document.getElementById('comments-drawer-overlay');

            const closeDrawer = () => {
                drawer.classList.remove('open');
                if (unsubscribeCommentsListener) {
                    unsubscribeCommentsListener();
                    unsubscribeCommentsListener = null;
                }
                currentStoryIdForComment = null;
            };

            closeBtn.addEventListener('click', closeDrawer);
            overlay.addEventListener('click', closeDrawer);

            document.getElementById('submit-comment-btn').addEventListener('click', async () => {
                if (!currentUser || !currentStoryIdForComment) return;

                const input = document.getElementById('new-comment-input');
                const commentText = input.value.trim();
                if (!commentText) return;

                const btn = document.getElementById('submit-comment-btn');
                btn.disabled = true;
                input.disabled = true;

                try {
                    const storyRef = doc(db, publicDataPath, 'stories', currentStoryIdForComment);
                    const interactionRef = collection(db, publicDataPath, 'storyInteractions');

                    await addDoc(interactionRef, {
                        storyId: currentStoryIdForComment,
                        userId: currentUser.uid,
                        type: 'comment',
                        commentText: commentText,
                        createdAt: serverTimestamp()
                    });
                    
                    await updateDoc(storyRef, {
                        commentCount: increment(1)
                    });

                    input.value = '';

                } catch (e) {
                    console.error("Error adding comment: ", e);
                    alert('Could not post comment.');
                } finally {
                    btn.disabled = false;
                    input.disabled = false;
                }
            });
        }

        function openCommentsDrawer(storyId, sellerUid) {
            if (unsubscribeCommentsListener) {
                unsubscribeCommentsListener();
            }
            currentStoryIdForComment = storyId;
            const drawer = document.getElementById('comments-drawer');
            const container = document.getElementById('comments-list-container');
            container.innerHTML = '<p class="text-gray-500 text-center">Loading comments...</p>';
            drawer.classList.add('open');

            const commentsRef = collection(db, publicDataPath, 'storyInteractions');
            const q = query(commentsRef, 
                where("storyId", "==", storyId), 
                where("type", "==", "comment"), 
                orderBy("createdAt", "asc")
            );

            unsubscribeCommentsListener = onSnapshot(q, async (snapshot) => {
                container.innerHTML = '';
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 text-center">No comments yet. Be the first!</p>';
                    return;
                }

                for (const doc of snapshot.docs) {
                    const comment = doc.data();
                    let userName = 'User';
                    let userPic = 'https://placehold.co/40x40/cccccc/969696?text=U';
                    
                    try {
                        const userRef = doc(db, usersPath, comment.userId);
                        const userSnap = await getDoc(userRef);
                        if (userSnap.exists()) {
                            userName = userSnap.data().name || 'User';
                        }
                    } catch (e) { console.error("Error getting user for comment", e); }
                    
                    const commentDate = comment.createdAt ? formatTimestamp(comment.createdAt.toDate()) : '';
                    
                    const isCreator = comment.userId === sellerUid;
                    const creatorBadge = isCreator ? '<span class="ml-2 bg-mudalali-green text-white text-xs font-semibold px-2 py-0.5 rounded-full">Creator</span>' : '';

                    container.innerHTML += `
                    <div class="flex gap-3">
                        <img src="${userPic}" class="h-10 w-10 rounded-full object-cover flex-shrink-0">
                        <div class="bg-gray-100 rounded-lg p-3">
                            <div class="flex items-center">
                                <span class="font-semibold text-sm">${userName}</span>
                                ${creatorBadge}
                            </div>
                            <p class="text-sm text-gray-700">${comment.commentText}</p>
                            <p class="text-xs text-gray-400 mt-1">${commentDate}</p>
                        </div>
                    </div>
                    `;
                }
            });
        }

        async function loadSiteConfig() {
            const docRef = doc(db, publicDataPath, 'siteContent', 'config');
            try {
                const docSnap = await getDoc(docRef);
                let config = {};
                if (docSnap.exists()) config = docSnap.data();
                
                const logoImg = document.getElementById('logo-img');
                const mobileLogoImg = document.getElementById('mobile-logo-img');

                if (config.logoImageUrl && logoImg && mobileLogoImg) {
                    logoImg.src = config.logoImageUrl;
                    mobileLogoImg.src = config.logoImageUrl;
                } else {
                    const logoLink = document.getElementById('logo-link');
                    const mobileLogoLink = document.getElementById('mobile-logo-link');
                    const logoText = config.logoText || 'Dashboard';
                    
                    if (logoImg) logoImg.remove();
                    if (mobileLogoImg) mobileLogoImg.remove();
                    
                    if (logoLink && logoLink.querySelector('span')) {
                         logoLink.querySelector('span').textContent = logoText;
                    }
                    if (mobileLogoLink && mobileLogoLink.querySelector('span')) {
                        mobileLogoLink.querySelector('span').textContent = logoText;
                    }
                }
            } catch (e) {
                console.error("Error loading site config: ", e);
            }
        }

        function setupLogoutButtons() {
            const logoutBtns = [
                document.getElementById('drawer-logout-btn'),
                document.getElementById('mobile-drawer-logout-btn')
            ];
            logoutBtns.forEach(btn => {
                btn?.addEventListener('click', () => {
                    signOut(auth).catch(error => console.error("Logout Error:", error));
                });
            });
        }

    </script>
</body>
</html>